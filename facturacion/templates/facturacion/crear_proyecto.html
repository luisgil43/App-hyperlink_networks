{# templates/facturacion/crear_proyecto.html #}
{% extends "dashboard_admin/base.html" %}
{% load widget_tweaks %}

{% block title %}Create Project{% endblock %}

{% block dashboard_content %}
<div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      ‚ûï Create Project
    </h2>
    {% if next_code %}
      <div class="text-sm text-slate-600">
        Next available code:
        <code class="px-2 py-1 rounded bg-slate-100 text-slate-800 font-mono">{{ next_code }}</code>
      </div>
    {% endif %}
  </div>

  <!-- Form -->
  <form id="createForm" method="post" class="space-y-4 mb-6">
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Code -->
      <div>
        <label class="block text-sm font-medium text-gray-700">{{ form.codigo.label }}</label>
        {% if not form.instance.pk %}
          {{ form.codigo|add_class:"w-full border rounded-xl px-3 py-2"|attr:"readonly:readonly" }}
          <p class="text-xs text-slate-500 mt-1">The field is pre-filled to avoid duplicates.</p>
        {% else %}
          {{ form.codigo|add_class:"w-full border rounded-xl px-3 py-2" }}
        {% endif %}
        {% if form.codigo.errors %}<p class="text-red-600 text-sm">{{ form.codigo.errors }}</p>{% endif %}
      </div>

      <!-- Name -->
      <div>
        <label class="block text-sm font-medium text-gray-700">{{ form.nombre.label }}</label>
        {{ form.nombre|add_class:"w-full border rounded-xl px-3 py-2" }}
        {% if form.nombre.errors %}<p class="text-red-600 text-sm">{{ form.nombre.errors }}</p>{% endif %}
      </div>

      <!-- Client -->
      <div>
        <label class="block text-sm font-medium text-gray-700">{{ form.mandante.label }}</label>
        {{ form.mandante|add_class:"w-full border rounded-xl px-3 py-2" }}
        {% if form.mandante.errors %}<p class="text-red-600 text-sm">{{ form.mandante.errors }}</p>{% endif %}
      </div>

      <!-- City -->
      <div>
        <label class="block text-sm font-medium text-gray-700">{{ form.ciudad.label }}</label>
        {{ form.ciudad|add_class:"w-full border rounded-xl px-3 py-2" }}
        {% if form.ciudad.errors %}<p class="text-red-600 text-sm">{{ form.ciudad.errors }}</p>{% endif %}
      </div>

      <!-- State -->
      <div>
        <label class="block text-sm font-medium text-gray-700">{{ form.estado.label }}</label>
        {{ form.estado|add_class:"w-full border rounded-xl px-3 py-2" }}
        {% if form.estado.errors %}<p class="text-red-600 text-sm">{{ form.estado.errors }}</p>{% endif %}
      </div>

      <!-- Office -->
      <div>
        <label class="block text-sm font-medium text-gray-700">{{ form.oficina.label }}</label>
        {{ form.oficina|add_class:"w-full border rounded-xl px-3 py-2" }}
        {% if form.oficina.errors %}<p class="text-red-600 text-sm">{{ form.oficina.errors }}</p>{% endif %}
      </div>
    </div>

    <!-- Active -->
    <div class="flex items-center gap-4 pt-2">
      <label class="text-sm font-medium text-gray-700">{{ form.activo.label }}</label>
      <div class="flex items-center gap-4">
        {{ form.activo }}
      </div>
      {% if form.activo.errors %}<p class="text-red-600 text-sm">{{ form.activo.errors }}</p>{% endif %}
    </div>

    <div class="flex justify-end gap-3 pt-4">
      <a href="{% url 'facturacion:listar_cartola' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-xl">
        Cancel
      </a>
      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl">
        Save
      </button>
    </div>
  </form>

  <!-- Table -->
  <h3 class="text-lg font-bold text-gray-700 mb-3">Created Projects</h3>
  <div class="overflow-x-auto">
    <table class="min-w-full table-auto border border-gray-300 rounded-xl text-sm">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-2 border">ID</th>
          <th class="p-2 border">Code</th>
          <th class="p-2 border">Project Name</th>
          <th class="p-2 border">Client</th>
          <th class="p-2 border">City</th>
          <th class="p-2 border">State</th>
          <th class="p-2 border">Office</th>
          <th class="p-2 border">Active</th>
          <th class="p-2 border">Actions</th>
        </tr>
      </thead>
      <tbody id="proyectosBody">
        {% for proyecto in proyectos %}
        <tr class="border-t">
          <td class="p-2 border text-center">{{ proyecto.id }}</td>
          <td class="p-2 border text-center">{{ proyecto.codigo }}</td>
          <td class="p-2 border text-center">{{ proyecto.nombre }}</td>
          <td class="p-2 border text-center">{{ proyecto.mandante }}</td>
          <td class="p-2 border text-center">{{ proyecto.ciudad }}</td>
          <td class="p-2 border text-center">{{ proyecto.estado }}</td>
          <td class="p-2 border text-center">{{ proyecto.oficina }}</td>
          <td class="p-2 border text-center">
            {% if proyecto.activo %}
              <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-700">Yes</span>
            {% else %}
              <span class="px-2 py-1 text-xs rounded bg-red-100 text-red-700">No</span>
            {% endif %}
          </td>
          <td class="p-2 border text-center">
            <a href="{% url 'facturacion:editar_proyecto' proyecto.id %}" class="text-blue-600 hover:underline">‚úèÔ∏è Edit</a> |
            <button type="button"
                    class="text-red-600 hover:underline delete-btn"
                    data-url="{% url 'facturacion:eliminar_proyecto' proyecto.id %}"
                    data-nombre="{{ proyecto.nombre }}">
              üóëÔ∏è Delete
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="p-4 text-center text-gray-500">No projects created.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Delete modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-lg">
    <h3 class="text-xl font-bold mb-4">Delete Project</h3>
    <p class="mb-4 text-gray-700">
      Are you sure you want to delete the project
      <span id="deleteNombre" class="font-semibold"></span>?
    </p>
    <div class="flex justify-end gap-3">
      <button type="button" id="cancelDelete" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-xl">Cancel</button>
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl">Delete</button>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Mensajes de validaci√≥n en ingl√©s
  const form = document.getElementById('createForm');
  if (form) {
    const REQUIRED_MSG = 'This field is required.';
    const RADIO_MSG    = 'Please select Active or Inactive.';
    form.querySelectorAll('input[required], textarea[required], select[required]').forEach(function (el) {
      el.addEventListener('invalid', function () {
        el.setCustomValidity('');
        if (!el.validity.valid) {
          el.setCustomValidity(el.type === 'radio' ? RADIO_MSG : REQUIRED_MSG);
        }
      });
      el.addEventListener('input',  () => el.setCustomValidity(''));
      el.addEventListener('change', () => el.setCustomValidity(''));
    });
    const radios = form.querySelectorAll('input[name="{{ form.activo.html_name }}"]');
    if (radios.length) {
      const enforceRadioValidity = () => {
        const oneChecked = Array.from(radios).some(r => r.checked);
        radios.forEach(r => r.setCustomValidity(oneChecked ? '' : RADIO_MSG));
      };
      radios.forEach(r => {
        r.addEventListener('change', enforceRadioValidity);
        r.addEventListener('invalid', enforceRadioValidity);
      });
      enforceRadioValidity();
    }
  }

  // Modal delete
  const deleteModal  = document.getElementById('deleteModal');
  const deleteForm   = document.getElementById('deleteForm');
  const deleteNombre = document.getElementById('deleteNombre');

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      deleteForm.setAttribute('action', btn.getAttribute('data-url'));
      deleteNombre.textContent = btn.getAttribute('data-nombre');
      deleteModal.classList.remove('hidden');
      deleteModal.classList.add('flex');
    });
  });
  document.getElementById('cancelDelete').addEventListener('click', () => {
    deleteModal.classList.add('hidden');
    deleteModal.classList.remove('flex');
  });
  deleteModal.addEventListener('click', (e) => {
    if (e.target === deleteModal) {
      deleteModal.classList.add('hidden');
      deleteModal.classList.remove('flex');
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && deleteModal.classList.contains('flex')) {
      deleteModal.classList.add('hidden');
      deleteModal.classList.remove('flex');
    }
  });
});
</script>
{% endblock %}