{% extends "dashboard_admin/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Transactions Ledger{% endblock %}

{% block dashboard_content %}
<div class="w-full mx-auto bg-white p-6 rounded-2xl shadow mt-6">

<style>
  .campo-filtro{
    border:2px solid #1f2937;padding:.25rem .75rem;border-radius:.75rem;font-size:.875rem;height:2.25rem;background:#fff;transition:border-color .2s
  }
  .campo-filtro:focus{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.3);outline:none}
  .filtros-compactos .campo-filtro{width:auto;min-width:8.5rem;max-width:12rem}
  @media (max-width:640px){.filtros-compactos .campo-filtro{max-width:10.5rem}}
  .tabla-responsive{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    width:100%;
  }
  .tabla-responsive table{
    white-space:nowrap;
    min-width:100%;
  }

  /* ====== Cabecera tipo Excel ====== */
  .excel-header-btn{
    width:100%;
    justify-content:center;
    font-size:0.875rem;
  }
  .excel-header-btn .excel-arrow{
    font-size:0.65rem;
    margin-left:2px;
  }
  .excel-header-btn:hover .excel-arrow{
    color:#111827;
  }

  .excel-panel{
    position:fixed;
    z-index:50;
    width:260px;
    background:#fff;
    border-radius:0.75rem;
    border:1px solid #d1d5db;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    padding:0.75rem;
    font-size:0.8rem;
  }
  .excel-panel h3{
    font-weight:600;
    margin-bottom:0.5rem;
  }
  .excel-panel small{
    font-size:0.7rem;
    color:#6b7280;
  }
  .excel-panel .excel-options{
    max-height:180px;
    overflow-y:auto;
    border:1px solid #e5e7eb;
    border-radius:0.5rem;
    padding:0.25rem 0.5rem;
    margin-top:0.25rem;
    background:#f9fafb;
  }

    .excel-col-filtered .excel-header-btn{
    background:#e0f2fe;          /* celestito */
    border-radius:999px;
  }
  .excel-col-filtered .excel-arrow{
    color:#2563eb !important;    /* flecha azul cuando hay filtro */
  }
</style>

<div class="flex flex-wrap items-center gap-3 mb-4">
  <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
    üìë Transactions Ledger
  </h2>

  <div class="flex flex-wrap items-center gap-2">
    <a href="{% url 'facturacion:crear_tipo' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Create Type
    </a>
    <a href="{% url 'facturacion:crear_proyecto' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Create Project
    </a>
    <a href="{% url 'facturacion:registrar_abono' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Register Credit
    </a>
    <a id="exportLink"
       href="{% url 'facturacion:exportar_cartola' %}?{{ request.GET.urlencode }}"
       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow flex items-center gap-1">
      üìÑ Export to Excel
    </a>
  </div>
</div>

<div class="flex justify-start mb-2">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-gray-700 px-3 py-1 border rounded-full bg-gray-50 hover:bg-gray-100 select-none">
      ‚öôÔ∏è Columns
    </summary>
    <div id="columnToggles" class="absolute left-0 mt-1 w-56 bg-white border rounded-xl shadow-lg p-3 z-10">
      <p class="text-xs text-gray-500 mb-2">Show / hide columns</p>

      <!-- ‚úÖ Master checkbox -->
      <label class="flex items-center gap-2 mb-2 pb-2 border-b">
        <input type="checkbox" id="col-toggle-all" checked>
        <span class="font-semibold text-xs">Show all columns</span>
      </label>

      <div class="space-y-1 text-sm">
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="0" checked> <span>User</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="1" checked> <span>Date</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="2" checked> <span>Project</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="3" checked> <span>Category</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="4" checked> <span>Type</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="5" checked> <span>Remarks</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="6" checked> <span>Transfer N¬∫</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="7" checked> <span>Receipt(s)</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="8" checked> <span>Odometer</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="9" checked> <span>Expenses</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="10" checked> <span>Credits</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="11" checked> <span>Status</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="12" checked> <span>Actions</span>
        </label>
      </div>
    </div>
  </details>
</div>

<div class="flex justify-start mb-2">
  <button type="button"
          id="btnExcelClearAll"
          class="px-3 py-1 text-xs border rounded-full bg-white hover:bg-blue-50">
    ‚ùå Clear filters
  </button>
</div>

<div id="zonaTabla" data-excel-global='{{ excel_global_json|safe }}'>
  <div class="rounded-xl border border-gray-200 tabla-responsive">
    <table id="tabla-cartola" class="table-auto border border-gray-300 rounded-xl text-sm w-full">
      <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
        <tr>
          <!-- üëâ filtros Excel en TODAS las columnas menos Actions -->
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>User</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Date</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Project</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Category</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Type</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Remarks</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Transfer Number</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Receipt(s)</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Odometer (km)</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border text-right" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Expenses (USD)</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border text-right" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Credits (USD)</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Status</span>
              <span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <!-- Sin filtro Excel -->
          <th class="p-2 border">Actions</th>
        </tr>
      </thead>

      <tbody class="text-center">
        {% for mov in pagina %}
        <tr class="border-t" data-mov-id="{{ mov.id }}">
          <td class="p-2 border">{{ mov.usuario }}</td>
          <td class="p-2 border"data-excel-value="{{ mov.fecha|date:'d-m-Y' }}">{{ mov.fecha|date:"d-m-Y" }}</td>
          <td class="p-2 border">{{ mov.proyecto }}</td>
          <td class="p-2 border">{{ mov.tipo.categoria|title }}</td>
          <td class="p-2 border">{{ mov.tipo }}</td>
          <td class="p-2 border">{{ mov.observaciones }}</td>
          <td class="p-2 border">{{ mov.numero_transferencia|default:"‚Äî" }}</td>

          <!-- Receipt(s): apilado en Fuel, simple en otros -->
          <td class="p-2 border">
            {% if mov.tipo and mov.tipo.nombre|lower == "fuel" %}
              <div class="flex flex-col items-center gap-1">
                {% if mov.comprobante %}
                  <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">üìÑ Receipt</a>
                {% endif %}
                {% if mov.foto_tablero %}
                  <a href="{{ mov.foto_tablero.url }}" target="_blank" class="text-blue-600 underline">üì∑ Odometer</a>
                {% endif %}
                {% if not mov.comprobante and not mov.foto_tablero %} ‚Äî {% endif %}
              </div>
            {% else %}
              {% if mov.comprobante %}
                <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">View</a>
              {% else %} ‚Äî {% endif %}
            {% endif %}
          </td>

          <!-- Kilometraje -->
          <td class="p-2 border text-right">
            {% if mov.kilometraje %}{{ mov.kilometraje|intcomma }}{% else %}‚Äî{% endif %}
          </td>

          <td class="p-2 border text-right">{{ mov.cargos|default:0|formato_usd }}</td>
          <td class="p-2 border text-right">{{ mov.abonos|default:0|formato_usd }}</td>

          <!-- üîπ valor "limpio" para el filtro Excel -->
          <td class="p-2 text-sm" data-excel-value="{{ mov.get_status_display }}">
            <div class="flex flex-col gap-1 text-left leading-tight">
              {% if mov.status == 'pendiente_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚è≥ Pending Supervisor Approval</span>
              {% elif mov.status == 'aprobado_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚è≥ Pending PM Approval</span>
              {% elif mov.status == 'rechazado_supervisor' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by Supervisor</span>
              {% elif mov.status == 'aprobado_pm' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br> ‚è≥ Pending Finance Approval</span>
              {% elif mov.status == 'rechazado_pm' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by PM</span>
              {% elif mov.status == 'aprobado_finanzas' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br> ‚úÖ Finance: {{ mov.aprobado_por_finanzas.get_full_name }}</span>
              {% elif mov.status == 'rechazado_finanzas' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by Finance</span>
              {% elif mov.status == 'pendiente_abono_usuario' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚è≥ Pending User Approval</span>
              {% elif mov.status == 'aprobado_abono_usuario' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">‚úÖ Credit Approved by User</span>
              {% elif mov.status == 'rechazado_abono_usuario' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Credit Rejected by User</span>
              {% else %}{{ mov.get_status_display }}{% endif %}

              {% if 'rechazado' in mov.status and mov.motivo_rechazo %}
                <div class="mt-1 text-xs text-red-700 whitespace-pre-wrap break-words editable-motivo" style="word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; max-width: 100%;">
                  <strong>Reason:</strong> <span class="motivo-text">{{ mov.motivo_rechazo }}</span>
                </div>
              {% endif %}
            </div>
          </td>

          <td class="p-2 border">
  {% if user.is_superuser %}
    <a href="{% url 'facturacion:editar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
       class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200 transition">‚úèÔ∏è Edit</a>
    <a href="{% url 'facturacion:eliminar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
       class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">üóëÔ∏è Delete</a>

    {% if mov.tipo.categoria == "abono" and mov.status == 'pendiente_abono_usuario' %}
      <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
         data-url="{% url 'facturacion:aprobar_abono_como_usuario' mov.id %}">‚úÖ Approve Credit as User</a>
    {% elif mov.tipo.categoria != "abono" %}
      {% if mov.status == 'pendiente_supervisor' or mov.status == 'aprobado_supervisor' or mov.status == 'aprobado_pm' %}
        <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
           data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">‚úÖ Approve Expense</a>
        <a href="#" onclick="abrirModalRechazo({{ mov.id }})"
           class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">‚ùå Reject Expense</a>
      {% endif %}
    {% endif %}

  {% else %}
    {% if mov.tipo.categoria == "abono" %}
      {% if user.es_facturacion %}
        {% if mov.status == 'pendiente_abono_usuario' or mov.status == 'rechazado_abono_usuario' %}
          <a href="{% url 'facturacion:editar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
             class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200 transition">‚úèÔ∏è Edit</a>
          <a href="{% url 'facturacion:eliminar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
             class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">üóëÔ∏è Delete</a>
        {% endif %}
      {% endif %}
    {% else %}
      {% if user.es_supervisor and mov.status == 'pendiente_supervisor' %}
        <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
           data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">‚úÖ Approve Expense</a>
        <a href="#" onclick="abrirModalRechazo({{ mov.id }})"
           class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">‚ùå Reject Expense</a>
      {% endif %}

      {% if user.es_pm and mov.status == 'aprobado_supervisor' %}
        <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
           data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">‚úÖ Approve Expense</a>
        <a href="#" onclick="abrirModalRechazo({{ mov.id }})"
           class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">‚ùå Reject Expense</a>
      {% endif %}

      {% if user.es_facturacion and mov.status == 'aprobado_pm' %}
        <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
           data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">‚úÖ Approve Expense</a>
        <a href="#" onclick="abrirModalRechazo({{ mov.id }})"
           class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">‚ùå Reject Expense</a>
      {% endif %}
    {% endif %}
  {% endif %}
</td>
        </tr>
        {% empty %}
        <tr><td colspan="15" class="p-4 text-center">No transactions registered.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-4 flex flex-wrap justify-between items-center text-sm">
    <form id="formCantidad" class="flex items-center gap-2">
      <label for="cantidad" class="text-sm font-medium text-gray-700">Show:</label>
      <select name="cantidad" id="cantidad" class="border rounded-lg px-3 py-1">
        <option value="5"  {% if cantidad == '5' %}selected{% endif %}>5</option>
        <option value="10" {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20" {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="50" {% if cantidad == '50' %}selected{% endif %}>50</option>
        <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
      </select>
    </form>
  </div>

  <div class="mt-2 flex justify-center text-sm">
    <span>Page {{ pagina.number }} of {{ pagina.paginator.num_pages }}</span>
  </div>

  <div class="mt-2 flex justify-center gap-2 text-sm">
    {% if pagina.has_previous %}
      <a class="pg-link px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" href="?{{ base_qs }}&page=1">¬´ First</a>
      <a class="pg-link px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" href="?{{ base_qs }}&page={{ pagina.previous_page_number }}">‚Äπ Previous</a>
    {% endif %}
    {% if pagina.has_next %}
      <a class="pg-link px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" href="?{{ base_qs }}&page={{ pagina.next_page_number }}">Next ‚Ä∫</a>
      <a class="pg-link px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" href="?{{ base_qs }}&page={{ pagina.paginator.num_pages }}">Last ¬ª</a>
    {% endif %}
  </div>
</div>

<!-- Modal de rechazo -->
<div id="modalRechazo" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Rejection Reason</h2>
    <form id="formRechazo" method="POST">
      {% csrf_token %}
      <textarea name="motivo_rechazo" rows="4" required class="w-full border rounded-lg p-2 mb-4" placeholder="Write the rejection reason"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="cerrarModalRechazo()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Reject</button>
      </div>
    </form>
  </div>
</div>

<!-- Panel flotante tipo Excel -->
<div id="excelFilterPanel" class="excel-panel hidden">
  <h3 id="excelPanelTitle">Column</h3>
  <small>Filter values</small>

  <div class="mt-2">
    <input id="excelFilterSearch"
           type="text"
           placeholder="Search..."
           class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs">
  </div>

  <div class="mt-2 excel-options" id="excelFilterOptions">
    <!-- opciones din√°micas -->
  </div>

  <div class="mt-3 flex justify-end gap-2">
    <button type="button"
            id="excelFilterClearAll"
            class="px-2 py-1 border rounded-md text-xs">
      Clear
    </button>
    <button type="button"
            id="excelFilterApply"
            class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs">
      Apply
    </button>
  </div>
</div>

<script>
(function(){
  const zona        = document.getElementById('zonaTabla');
  const filtrosForm = document.getElementById('form-filtros'); // puede no existir
  const exportLink  = document.getElementById('exportLink');
  let debounceTimer = null, controller = null;

  /* =================== Helpers para guardar / cargar filtros Excel =================== */

  function loadExcelFilters(){
    try{
      const key = 'ledgerExcelFilters:' + location.pathname;
      const raw = sessionStorage.getItem(key);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      const result = {};
      Object.entries(obj).forEach(([col, arr])=>{
        result[col] = new Set(arr);
      });
      return result;
    }catch(_){
      return {};
    }
  }

  function saveExcelFilters(active){
    try{
      const key = 'ledgerExcelFilters:' + location.pathname;
      const plain = {};
      Object.entries(active).forEach(([col, set])=>{
        plain[col] = Array.from(set);
      });
      sessionStorage.setItem(key, JSON.stringify(plain));
    }catch(_){}
  }

  // üëâ Empuja los filtros Excel al querystring (?excel_filters=...)
  function addExcelFiltersToParams(p){
    if(!p) return p;
    const plain = {};
    Object.entries(excel.activeFilters || {}).forEach(([col, set])=>{
      if(set && set.size){
        plain[col] = Array.from(set);
      }
    });
    if(Object.keys(plain).length){
      p.set('excel_filters', JSON.stringify(plain));
    }else{
      p.delete('excel_filters');
    }
    return p;
  }

  /* =================== Excel globals desde el servidor =================== */

  function loadExcelGlobalFromZona(){
    try{
      if(!zona) return {};
      const raw = zona.dataset.excelGlobal || '{}';
      return JSON.parse(raw);
    }catch(_){
      return {};
    }
  }

  let excelGlobalValues = loadExcelGlobalFromZona(); // üëà todos los registros (no s√≥lo la p√°gina)

  /* ======== Estado filtros tipo Excel ======== */
  const excel = {
    panel: document.getElementById('excelFilterPanel'),
    titleEl: document.getElementById('excelPanelTitle'),
    searchInput: document.getElementById('excelFilterSearch'),
    optsBox: document.getElementById('excelFilterOptions'),
    btnApply: document.getElementById('excelFilterApply'),
    btnClearAll: document.getElementById('excelFilterClearAll'),
    table: null,
    tbody: null,
    headers: [],
    allRows: [],
    distinctValues: {},
    activeFilters: loadExcelFilters(),   // üëà recupera filtros guardados
    currentColIndex: null,
    panelEventsBound: false
  };

  /* ======== Mantener scroll horizontal ======== */
  const SCROLL_KEY = 'ledgerScrollX:' + location.pathname;

  function getScrollBox(){
    return zona.querySelector('.tabla-responsive');
  }
  function readSavedX(){
    return Number(sessionStorage.getItem(SCROLL_KEY) || 0);
  }
  function saveX(x){
    sessionStorage.setItem(SCROLL_KEY, String(x));
  }
  function hookScrollSaver(){
    const box = getScrollBox();
    if(!box) return;
    let t=null;
    box.addEventListener('scroll', ()=>{
      if(t) return;
      t=setTimeout(()=>{ t=null; saveX(box.scrollLeft); }, 120);
    }, {passive:true});
  }
  function restoreX(x){
    const box = getScrollBox();
    if(!box) return;
    requestAnimationFrame(()=>{ box.scrollLeft = x; });
  }

  /* ======== Visibilidad de columnas (localStorage + "Show all") ======== */
  const COL_KEY = 'ledgerCols:' + location.pathname;

  function loadColsState(){
    try{
      const raw = localStorage.getItem(COL_KEY);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === 'object') ? obj : {};
    }catch(_){
      return {};
    }
  }

  function saveColsState(state){
    try{
      localStorage.setItem(COL_KEY, JSON.stringify(state));
    }catch(_){}
  }

  function applyColumnVisibility(){
    if (!zona) return;
    const table = zona.querySelector('table');
    if (!table) return;

    const state = loadColsState();

    const headerCells = table.querySelectorAll('thead tr th');
    headerCells.forEach((th, idx)=>{
      const visible = state[idx] !== false;
      th.style.display = visible ? '' : 'none';
    });

    table.querySelectorAll('tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      tds.forEach((td, idx)=>{
        const visible = state[idx] !== false;
        td.style.display = visible ? '' : 'none';
      });
    });

    const panel  = document.getElementById('columnToggles');
    const master = panel ? panel.querySelector('#col-toggle-all') : null;
    if(panel){
      const checks = panel.querySelectorAll('.col-toggle');
      let allOn = true;
      checks.forEach(cb=>{
        const idx = parseInt(cb.dataset.col || '0', 10);
        const visible = state[idx] !== false;
        cb.checked = visible;
        if(!visible) allOn = false;
      });
      if(master){
        master.checked = allOn;
      }
    }
  }

  function engancharColumnToggles(){
    const panel = document.getElementById('columnToggles');
    if(!panel) return;

    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    checks.forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const idx   = parseInt(cb.dataset.col || '0', 10);
        const state = loadColsState();
        state[idx]  = cb.checked;
        saveColsState(state);
        applyColumnVisibility();
      });
    });

    if(master){
      master.addEventListener('change', ()=>{
        const state = loadColsState();
        const val   = master.checked;
        checks.forEach(cb=>{
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });
        saveColsState(state);
        applyColumnVisibility();
      });
    }
  }

  function initColumnsDropdown(){
    const details = document.querySelector('details.relative');
    if(!details) return;

    document.addEventListener('click', (e)=>{
      if(!details.open) return;
      if(details.contains(e.target)) return;
      details.open = false;
    });
  }

  function syncCantidad(){
    if (!filtrosForm || !zona) return;
    const sel    = zona.querySelector('#cantidad');
    const hidden = filtrosForm.querySelector('input[name="cantidad"]');
    if (sel && hidden) {
      hidden.value = sel.value;
    }
  }

  function paramsFromFilters(resetPage){
    if (filtrosForm){
      syncCantidad();
      const p = new URLSearchParams(new FormData(filtrosForm));
      if (resetPage) p.set('page','1');
      return p;
    } else {
      const p = new URLSearchParams(window.location.search);
      if (resetPage) p.set('page','1');
      return p;
    }
  }

  async function cargarTablaCon(qs, push=true){
    const prevX = (getScrollBox()?.scrollLeft) ?? readSavedX();
    saveX(prevX);

    const url = `${location.pathname}?${qs}`;
    if (push) history.replaceState(null, '', url);
    exportLink.href = `{% url 'facturacion:exportar_cartola' %}?` + qs;

    if (controller) controller.abort();
    controller = new AbortController();

    const resp = await fetch(url, { signal: controller.signal });
    const html = await resp.text();
    const doc  = new DOMParser().parseFromString(html, 'text/html');
    const nuevaZona = doc.getElementById('zonaTabla');
    if (!nuevaZona) return;

    zona.innerHTML = nuevaZona.innerHTML;

    // actualizar excel_global
    zona.dataset.excelGlobal = nuevaZona.dataset.excelGlobal || '{}';
    excelGlobalValues = loadExcelGlobalFromZona();

    engancharPaginacion();
    engancharAprobar();
    engancharCantidad();
    engancharColumnToggles();
    initColumnsDropdown();
    engancharFiltros();
    initExcelFilters();          // reaplica filtros Excel

    applyColumnVisibility();
    restoreX(prevX);
    hookScrollSaver();
  }

  function refiltrar(resetPage=true){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>{
      const p = paramsFromFilters(resetPage);
      addExcelFiltersToParams(p);              // üëà incluir filtros Excel
      cargarTablaCon(p.toString(), true);
    }, 300);
  }

  function engancharFiltros(){
    if (!filtrosForm) return;
    filtrosForm.querySelectorAll('.filtro').forEach(el=>{
      const evt = el.tagName === 'SELECT' ? 'change' : 'input';
      el.addEventListener(evt, ()=>refiltrar(true));
      el.addEventListener('keydown', e=>{
        if(e.key==='Enter'){ e.preventDefault(); refiltrar(true); }
      });
    });
  }

  function engancharPaginacion(){
    zona.querySelectorAll('a.pg-link').forEach(a=>{
      a.addEventListener('click', ev=>{
        ev.preventDefault();
        const href = new URL(a.getAttribute('href'), location.href);
        const p = paramsFromFilters(false);
        p.set('page', href.searchParams.get('page') || '1');
        addExcelFiltersToParams(p);            // üëà mantener filtros Excel
        cargarTablaCon(p.toString(), true);
      });
    });
  }

  function engancharCantidad(){
    const sel = zona.querySelector('#cantidad');
    if(!sel) return;
    sel.addEventListener('change', ()=>{
      const p = paramsFromFilters(true);
      p.set('cantidad', sel.value);
      addExcelFiltersToParams(p);              // üëà mantener filtros Excel
      cargarTablaCon(p.toString(), true);
    });
  }

  function engancharAprobar(){
    zona.querySelectorAll('.js-approve').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();

        const url    = btn.dataset.url;
        const method = (btn.dataset.method || 'POST').toUpperCase();
        const row    = btn.closest('tr');

        if (!url || !row) return;
        if (btn.dataset.loading === '1') return;
        btn.dataset.loading = '1';

        const originalText = btn.textContent;
        btn.textContent    = 'Approving...';

        try {
          const fd = new FormData();
          fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');

          const resp = await fetch(url, {
            method: method,
            body: fd,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          });

          if (!resp.ok) {
            throw new Error('Error approving movement.');
          }

          row.style.transition = 'opacity 0.2s ease';
          row.style.opacity = '0.4';
          setTimeout(() => {
            row.remove();
          }, 200);

          // re-aplicar filtros sobre filas restantes de la p√°gina
          if (excel.table && excel.tbody){
            excel.allRows = Array.from(excel.tbody.rows);
            excelApplyFilters();
          }

        } catch (err) {
          console.error(err);
          alert(err.message || 'Error approving movement.');
          btn.textContent    = originalText;
          btn.dataset.loading = '';
          return;
        }
      });
    });
  }

  window.abrirModalRechazo = function(id){
    const modal = document.getElementById('modalRechazo');
    const form  = document.getElementById('formRechazo');
    form.dataset.movId = id;
    modal.classList.remove('hidden'); modal.classList.add('flex');
  };
  window.cerrarModalRechazo = function(){
    const modal = document.getElementById('modalRechazo');
    modal.classList.add('hidden'); modal.classList.remove('flex');
  };
  document.getElementById('formRechazo').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.currentTarget;
    const id   = form.dataset.movId;
    if(!id) return;
    const url  = `/facturacion/cartola/rechazar/${id}/`;
    const fd   = new FormData(form);
    fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    await fetch(url, { method:'POST', body: fd });
    cerrarModalRechazo();
    const p = paramsFromFilters(false);
    addExcelFiltersToParams(p);
    await cargarTablaCon(p.toString(), false);
  });

  /* ================== L√ìGICA FILTROS TIPO EXCEL ================== */

  function excelGetCellValue(td){
    if(!td) return '(Vac√≠as)';
    let text = '';
    if (td.dataset && td.dataset.excelValue){
      text = td.dataset.excelValue;
    } else {
      text = (td.textContent || '');
    }
    text = text.trim();
    return text || '(Vac√≠as)';
  }

  // construir distinct usando:
  //  - valores globales del servidor (todos los registros)
  //  - y como fallback, lo que haya en la p√°gina actual
  function excelBuildDistinctValues(){
    excel.distinctValues = {};

    if (excelGlobalValues){
      Object.entries(excelGlobalValues).forEach(([idx, arr])=>{
        excel.distinctValues[idx] = new Set(arr);
      });
    }

    excel.allRows.forEach(row=>{
      Array.from(row.cells).forEach((td, idx)=>{
        if(!excel.distinctValues[idx]) excel.distinctValues[idx] = new Set();
        const text = excelGetCellValue(td);
        excel.distinctValues[idx].add(text);
      });
    });
  }

  function excelUpdateHeaderStates(){
    if(!excel.headers) return;
    excel.headers.forEach((th, idx)=>{
      if(!th.hasAttribute('data-excel-col')) return;
      const hasFilter = !!(excel.activeFilters[idx] && excel.activeFilters[idx].size > 0);
      th.classList.toggle('excel-col-filtered', hasFilter);
    });
  }

  function excelApplyFilters(){
    excel.allRows.forEach(row=>{
      let visible = true;
      for (const [colIndexStr, values] of Object.entries(excel.activeFilters)){
        const idx = parseInt(colIndexStr, 10);
        if(!values || values.size === 0) continue;
        const cell = row.cells[idx];
        const text = excelGetCellValue(cell);
        if(!values.has(text)){
          visible = false;
          break;
        }
      }
      row.style.display = visible ? '' : 'none';
    });

    excelUpdateHeaderStates();
    saveExcelFilters(excel.activeFilters);
  }

  // Clear global (todos los filtros)
  function excelClearAll(){
    excel.activeFilters = {};
    excelApplyFilters();
    if(excel.panel) excel.panel.classList.add('hidden');
  }

  function excelFilterOptionList(query){
    if(!excel.optsBox) return;
    const q = query.trim().toLowerCase();
    excel.optsBox.querySelectorAll('label[data-option-label]').forEach(lbl=>{
      const text = lbl.textContent.toLowerCase();
      lbl.style.display = text.includes(q) ? '' : 'none';
    });
  }

  function excelRenderOptions(colIndex){
    if(!excel.optsBox) return;
    excel.optsBox.innerHTML = '';

    const valuesSet = excel.distinctValues[colIndex] || new Set();
    const values = Array.from(valuesSet).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
    const selected = excel.activeFilters[colIndex];

    const allLabel = document.createElement('label');
    allLabel.className = 'flex items-center gap-1 mb-1 text-xs';
    const allCb = document.createElement('input');
    allCb.type = 'checkbox';
    allCb.dataset.selectAll = '1';
    allCb.checked = !selected || selected.size === values.length;
    allCb.addEventListener('change', ()=>{
      const checks = excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]');
      checks.forEach(cb=> cb.checked = allCb.checked);
    });
    allLabel.appendChild(allCb);
    allLabel.appendChild(document.createTextNode(' (Select all)'));
    excel.optsBox.appendChild(allLabel);

    values.forEach(val=>{
      const label = document.createElement('label');
      label.className = 'flex items-center gap-1 text-xs mt-0.5';
      label.dataset.optionLabel = '1';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.value = val;
      cb.checked = !selected || selected.has(val);

      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + val));
      excel.optsBox.appendChild(label);
    });
  }

  function excelOpenForHeader(th){
    if(!excel.panel) return;

    excel.currentColIndex = parseInt(th.dataset.excelIndex, 10);
    excel.titleEl.textContent = th.innerText.trim();

    excelBuildDistinctValues();
    excelRenderOptions(excel.currentColIndex);

    const rect = th.getBoundingClientRect();
    const panelWidth  = excel.panel.offsetWidth || 260;
    const panelHeight = excel.panel.offsetHeight || 220;

    let left = rect.left + (rect.width - panelWidth) / 2;
    let top  = rect.bottom + 4;

    const minLeft = 8;
    const maxLeft = window.innerWidth - panelWidth - 8;
    if (left < minLeft) left = minLeft;
    if (left > maxLeft) left = maxLeft;

    const maxTop = window.innerHeight - panelHeight - 8;
    if (top > maxTop) top = maxTop;

    excel.panel.style.left = left + 'px';
    excel.panel.style.top  = top + 'px';

    excel.panel.classList.remove('hidden');
    excel.searchInput.value = '';
    excelFilterOptionList('');
    excel.searchInput.focus();
  }

  function excelBindPanelEventsOnce(){
    if(excel.panelEventsBound || !excel.panel) return;

    excel.searchInput.addEventListener('input', ()=>{
      excelFilterOptionList(excel.searchInput.value);
    });

    // Apply del popup -> s√≥lo la columna actual
    excel.btnApply.addEventListener('click', ()=>{
      if(excel.currentColIndex == null){
        excel.panel.classList.add('hidden');
        return;
      }
      const checks = excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]');
      const selected = new Set();
      checks.forEach(cb=>{
        if(cb.checked) selected.add(cb.dataset.value);
      });

      const fullSet = excel.distinctValues[excel.currentColIndex] || new Set();
      if(selected.size === 0 || selected.size === fullSet.size){
        delete excel.activeFilters[excel.currentColIndex];
      }else{
        excel.activeFilters[excel.currentColIndex] = selected;
      }
      excelApplyFilters();
      excel.panel.classList.add('hidden');

      // üîÑ recargar desde servidor con estos filtros Excel
      const p = paramsFromFilters(true);
      addExcelFiltersToParams(p);
      cargarTablaCon(p.toString(), true);
    });

    // Clear del popup -> limpia SOLO la columna actual
    excel.btnClearAll.addEventListener('click', ()=>{
      if (excel.currentColIndex == null){
        excel.panel.classList.add('hidden');
        return;
      }
      delete excel.activeFilters[excel.currentColIndex];

      const checks = excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]');
      checks.forEach(cb => { cb.checked = true; });

      excelApplyFilters();
      excel.panel.classList.add('hidden');

      const p = paramsFromFilters(true);
      addExcelFiltersToParams(p);
      cargarTablaCon(p.toString(), true);
    });

    // cerrar panel al hacer clic fuera
    document.addEventListener('click', (e)=>{
      if(excel.panel.classList.contains('hidden')) return;
      if(excel.panel.contains(e.target)) return;
      if(e.target.closest('.excel-header-btn')) return;
      excel.panel.classList.add('hidden');
    });

    excel.panelEventsBound = true;
  }

  function initExcelFilters(){
    excelBindPanelEventsOnce();

    if(!zona) return;
    const table = zona.querySelector('#tabla-cartola');
    if(!table) return;

    excel.table   = table;
    excel.tbody   = table.querySelector('tbody');
    excel.headers = table.querySelectorAll('thead th');
    excel.allRows = Array.from(excel.tbody.rows);

    excelBuildDistinctValues();
    excelApplyFilters();

    excel.headers.forEach((th, idx)=>{
      if(th.hasAttribute('data-excel-col')){
        th.dataset.excelIndex = idx;
        const btn = th.querySelector('.excel-header-btn');
        if(btn){
          btn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            excelOpenForHeader(th);
          });
        }
      }
    });
  }

  // Bot√≥n global "‚ùå Clear filters"
  function engancharClearExcelGlobal(){
    const btn = document.getElementById('btnExcelClearAll');
    if(!btn) return;
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      excelClearAll();
      const p = paramsFromFilters(true);
      addExcelFiltersToParams(p);
      cargarTablaCon(p.toString(), true);
    });
  }

  /* ================== Inicial ================== */

  engancharPaginacion();
  engancharAprobar();
  engancharCantidad();
  engancharColumnToggles();
  initColumnsDropdown();
  engancharFiltros();
  applyColumnVisibility();
  restoreX(readSavedX());
  hookScrollSaver();
  initExcelFilters();
  engancharClearExcelGlobal();
})();
</script>
</div>
{% endblock %}