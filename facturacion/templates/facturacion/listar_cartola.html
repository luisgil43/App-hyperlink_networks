{% extends "dashboard_admin/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Transactions Ledger{% endblock %}

{% block dashboard_content %}
<div class="w-full mx-auto bg-white p-6 rounded-2xl shadow mt-6">

<style>
  .campo-filtro{
    border:2px solid #1f2937;padding:.25rem .75rem;border-radius:.75rem;font-size:.875rem;height:2.25rem;background:#fff;transition:border-color .2s
  }
  .campo-filtro:focus{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.3);outline:none}
  .filtros-compactos .campo-filtro{width:auto;min-width:8.5rem;max-width:12rem}
  @media (max-width:640px){.filtros-compactos .campo-filtro{max-width:10.5rem}}
  .tabla-responsive{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  width:100%;
}
.tabla-responsive table{
  white-space:nowrap;
  min-width:100%;   /* usa el ancho del contenedor, pero crece si hace falta */
}
</style>

<div class="flex flex-wrap items-center gap-3 mb-4">
  <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
    üìë Transactions Ledger
  </h2>

  <div class="flex flex-wrap items-center gap-2">
    <a href="{% url 'facturacion:crear_tipo' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Create Type
    </a>
    <a href="{% url 'facturacion:crear_proyecto' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Create Project
    </a>
    <a href="{% url 'facturacion:registrar_abono' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Register Credit
    </a>
    <a id="exportLink"
       href="{% url 'facturacion:exportar_cartola' %}?{{ request.GET.urlencode }}"
       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow flex items-center gap-1">
      üìÑ Export to Excel
    </a>
  </div>
</div>

<form id="form-filtros" method="get" class="filtros-compactos mb-6">
  <div class="grid grid-cols-2 sm:flex sm:flex-wrap items-center gap-2">
    <input type="text" name="du"        value="{{ filtros.du }}"        placeholder="Filter by User"                     class="campo-filtro filtro">
    <input type="text" name="fecha"     value="{{ filtros.fecha }}"     placeholder="DD-MM-YYYY (ej. 20)"          class="campo-filtro filtro">
    <input type="text" name="proyecto"  value="{{ filtros.proyecto }}"  placeholder="Filter by Project"                  class="campo-filtro filtro">
    <input type="text" name="categoria" value="{{ filtros.categoria }}" placeholder="Filter by Category"                 class="campo-filtro filtro">
    <input type="text" name="tipo"      value="{{ filtros.tipo }}"      placeholder="Filter by Type"                     class="campo-filtro filtro">

    <div class="flex gap-2 w-full sm:w-auto">
      <a href="{% url 'facturacion:listar_cartola' %}" class="bg-red-100 hover:bg-red-200 text-red-600 text-sm font-medium px-4 py-2 rounded-full shadow flex-none">‚ùå Clear</a>
    </div>

    <select name="estado" class="campo-filtro filtro">
      <option value="">All statuses</option>
      {% for codigo, nombre in estado_choices %}
        <option value="{{ codigo }}" {% if filtros.estado == codigo %}selected{% endif %}>{{ nombre }}</option>
      {% endfor %}
    </select>

    <input type="hidden" name="cantidad" value="{{ cantidad }}">
  </div>
</form>

<div class="flex justify-start mb-2">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-gray-700 px-3 py-1 border rounded-full bg-gray-50 hover:bg-gray-100 select-none">
      ‚öôÔ∏è Columns
    </summary>
    <div id="columnToggles" class="absolute left-0 mt-1 w-56 bg-white border rounded-xl shadow-lg p-3 z-10">
      <p class="text-xs text-gray-500 mb-2">Show / hide columns</p>

      <!-- ‚úÖ Master checkbox -->
      <label class="flex items-center gap-2 mb-2 pb-2 border-b">
        <input type="checkbox" id="col-toggle-all" checked>
        <span class="font-semibold text-xs">Show all columns</span>
      </label>

      <div class="space-y-1 text-sm">
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="0" checked> <span>User</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="1" checked> <span>Date</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="2" checked> <span>Project</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="3" checked> <span>Category</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="4" checked> <span>Type</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="5" checked> <span>Remarks</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="6" checked> <span>Transfer N¬∫</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="7" checked> <span>Receipt(s)</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="8" checked> <span>Odometer</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="9" checked> <span>Expenses</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="10" checked> <span>Credits</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="11" checked> <span>Status</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="12" checked> <span>Actions</span>
        </label>
      </div>
    </div>
  </details>
</div>

<div id="zonaTabla">
  <div class="rounded-xl border border-gray-200 tabla-responsive">
    <table class="table-auto border border-gray-300 rounded-xl text-sm w-full">
      <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
        <tr>
          <th class="p-2 border">User</th>
          <th class="p-2 border">Date</th>
          <th class="p-2 border">Project</th>
          <th class="p-2 border">Category</th>
          <th class="p-2 border">Type</th>
          <th class="p-2 border">Remarks</th>
          <th class="p-2 border">Transfer Number</th>
          <th class="p-2 border">Receipt(s)</th>            <!-- üëà renombrado -->
          <th class="p-2 border">Odometer (km)</th>         <!-- üëà NUEVA COLUMNA -->
          <th class="p-2 border text-right">Expenses (USD)</th>
          <th class="p-2 border text-right">Credits (USD)</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Actions</th>
        </tr>
      </thead>
      <tbody class="text-center">
        {% for mov in pagina %}
        <tr class="border-t">
          <td class="p-2 border">{{ mov.usuario }}</td>
          <td class="p-2 border">{{ mov.fecha }}</td>
          <td class="p-2 border">{{ mov.proyecto }}</td>
          <td class="p-2 border">{{ mov.tipo.categoria|title }}</td>
          <td class="p-2 border">{{ mov.tipo }}</td>
          <td class="p-2 border">{{ mov.observaciones }}</td>
          <td class="p-2 border">{{ mov.numero_transferencia|default:"‚Äî" }}</td>

          <!-- Receipt(s): apilado en Fuel, simple en otros -->
          <td class="p-2 border">
            {% if mov.tipo and mov.tipo.nombre|lower == "fuel" %}
              <div class="flex flex-col items-center gap-1">
                {% if mov.comprobante %}
                  <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">üìÑ Receipt</a>
                {% endif %}
                {% if mov.foto_tablero %}
                  <a href="{{ mov.foto_tablero.url }}" target="_blank" class="text-blue-600 underline">üì∑ Odometer</a>
                {% endif %}
                {% if not mov.comprobante and not mov.foto_tablero %} ‚Äî {% endif %}
              </div>
            {% else %}
              {% if mov.comprobante %}
                <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">View</a>
              {% else %} ‚Äî {% endif %}
            {% endif %}
          </td>

          <!-- Kilometraje -->
          <td class="p-2 border text-right">
            {% if mov.kilometraje %}{{ mov.kilometraje|intcomma }}{% else %}‚Äî{% endif %}
          </td>

          <td class="p-2 border text-right">{{ mov.cargos|default:0|formato_usd }}</td>
          <td class="p-2 border text-right">{{ mov.abonos|default:0|formato_usd }}</td>

          <td class="p-2 text-sm">
            <div class="flex flex-col gap-1 text-left leading-tight">
              {% if mov.status == 'pendiente_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚è≥ Pending Supervisor Approval</span>
              {% elif mov.status == 'aprobado_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚è≥ Pending PM Approval</span>
              {% elif mov.status == 'rechazado_supervisor' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by Supervisor</span>
              {% elif mov.status == 'aprobado_pm' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br> ‚è≥ Pending Finance Approval</span>
              {% elif mov.status == 'rechazado_pm' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by PM</span>
              {% elif mov.status == 'aprobado_finanzas' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br> ‚úÖ Finance: {{ mov.aprobado_por_finanzas.get_full_name }}</span>
              {% elif mov.status == 'rechazado_finanzas' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by Finance</span>
              {% elif mov.status == 'pendiente_abono_usuario' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚è≥ Pending User Approval</span>
              {% elif mov.status == 'aprobado_abono_usuario' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">‚úÖ Credit Approved by User</span>
              {% elif mov.status == 'rechazado_abono_usuario' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Credit Rejected by User</span>
              {% else %}{{ mov.get_status_display }}{% endif %}

              {% if 'rechazado' in mov.status and mov.motivo_rechazo %}
                <div class="mt-1 text-xs text-red-700 whitespace-pre-wrap break-words editable-motivo" style="word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; max-width: 100%;">
                  <strong>Reason:</strong> <span class="motivo-text">{{ mov.motivo_rechazo }}</span>
                </div>
              {% endif %}
            </div>
          </td>

          <td class="p-2 border">
  {% if user.is_superuser %}
    <a href="{% url 'facturacion:editar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
       class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200 transition">‚úèÔ∏è Edit</a>
    <a href="{% url 'facturacion:eliminar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
       class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">üóëÔ∏è Delete</a>

    {% if mov.tipo.categoria == "abono" and mov.status == 'pendiente_abono_usuario' %}
      <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
         data-url="{% url 'facturacion:aprobar_abono_como_usuario' mov.id %}">‚úÖ Approve Credit as User</a>
    {% elif mov.tipo.categoria != "abono" %}
      {% if mov.status == 'pendiente_supervisor' or mov.status == 'aprobado_supervisor' or mov.status == 'aprobado_pm' %}
        <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
           data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">‚úÖ Approve Expense</a>
        <a href="#" onclick="abrirModalRechazo({{ mov.id }})"
           class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">‚ùå Reject Expense</a>
      {% endif %}
    {% endif %}

  {% else %}
    {% if mov.tipo.categoria == "abono" %}
      {% if user.es_facturacion %}
        {% if mov.status == 'pendiente_abono_usuario' or mov.status == 'rechazado_abono_usuario' %}
          <a href="{% url 'facturacion:editar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
             class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200 transition">‚úèÔ∏è Edit</a>
          <a href="{% url 'facturacion:eliminar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
             class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">üóëÔ∏è Delete</a>
        {% endif %}
      {% endif %}
    {% else %}
      {% if user.es_supervisor and mov.status == 'pendiente_supervisor' %}
        <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
           data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">‚úÖ Approve Expense</a>
        <a href="#" onclick="abrirModalRechazo({{ mov.id }})"
           class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">‚ùå Reject Expense</a>
      {% endif %}

      {% if user.es_pm and mov.status == 'aprobado_supervisor' %}
        <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
           data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">‚úÖ Approve Expense</a>
        <a href="#" onclick="abrirModalRechazo({{ mov.id }})"
           class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">‚ùå Reject Expense</a>
      {% endif %}

      {% if user.es_facturacion and mov.status == 'aprobado_pm' %}
        <a href="#" class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
           data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">‚úÖ Approve Expense</a>
        <a href="#" onclick="abrirModalRechazo({{ mov.id }})"
           class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">‚ùå Reject Expense</a>
      {% endif %}
    {% endif %}
  {% endif %}
</td>
        </tr>
        {% empty %}
        <tr><td colspan="15" class="p-4 text-center">No transactions registered.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-4 flex flex-wrap justify-between items-center text-sm">
    <form id="formCantidad" class="flex items-center gap-2">
      <label for="cantidad" class="text-sm font-medium text-gray-700">Show:</label>
      <select name="cantidad" id="cantidad" class="border rounded-lg px-3 py-1">
        <option value="5"  {% if cantidad == '5' %}selected{% endif %}>5</option>
        <option value="10" {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20" {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="50" {% if cantidad == '50' %}selected{% endif %}>50</option>
        <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>

        
      </select>
    </form>
  </div>

<div class="mt-2 flex justify-center text-sm">
  <span>Page {{ pagina.number }} of {{ pagina.paginator.num_pages }}</span>
</div>

  <div class="mt-2 flex justify-center gap-2 text-sm">
    {% if pagina.has_previous %}
      <a class="pg-link px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" href="?{{ base_qs }}&page=1">¬´ First</a>
      <a class="pg-link px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" href="?{{ base_qs }}&page={{ pagina.previous_page_number }}">‚Äπ Previous</a>
    {% endif %}
    {% if pagina.has_next %}
      <a class="pg-link px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" href="?{{ base_qs }}&page={{ pagina.next_page_number }}">Next ‚Ä∫</a>
      <a class="pg-link px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" href="?{{ base_qs }}&page={{ pagina.paginator.num_pages }}">Last ¬ª</a>
    {% endif %}
  </div>
</div>

<!-- Modal de rechazo -->
<div id="modalRechazo" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Rejection Reason</h2>
    <form id="formRechazo" method="POST">
      {% csrf_token %}
      <textarea name="motivo_rechazo" rows="4" required class="w-full border rounded-lg p-2 mb-4" placeholder="Write the rejection reason"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="cerrarModalRechazo()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Reject</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const zona        = document.getElementById('zonaTabla');
  const filtrosForm = document.getElementById('form-filtros');
  const exportLink  = document.getElementById('exportLink');
  let debounceTimer = null, controller = null;

  /* ======== Mantener scroll horizontal ======== */
  const SCROLL_KEY = 'ledgerScrollX:' + location.pathname;

  function getScrollBox(){           // contenedor con overflow-x
    return zona.querySelector('.tabla-responsive');
  }
  function readSavedX(){
    return Number(sessionStorage.getItem(SCROLL_KEY) || 0);
  }
  function saveX(x){
    sessionStorage.setItem(SCROLL_KEY, String(x));
  }
  function hookScrollSaver(){
    const box = getScrollBox();
    if(!box) return;
    let t=null;
    box.addEventListener('scroll', ()=>{
      if(t) return;
      t=setTimeout(()=>{ t=null; saveX(box.scrollLeft); }, 120);
    }, {passive:true});
  }
  function restoreX(x){
    const box = getScrollBox();
    if(!box) return;
    requestAnimationFrame(()=>{ box.scrollLeft = x; });
  }
  /* =========================================== */

  /* ======== Visibilidad de columnas (localStorage + "Show all") ======== */
  const COL_KEY = 'ledgerCols:' + location.pathname;

  function loadColsState(){
    try{
      const raw = localStorage.getItem(COL_KEY);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === 'object') ? obj : {};
    }catch(_){
      return {};
    }
  }

  function saveColsState(state){
    try{
      localStorage.setItem(COL_KEY, JSON.stringify(state));
    }catch(_){}
  }

  function applyColumnVisibility(){
    if (!zona) return;
    const table = zona.querySelector('table');
    if (!table) return;

    const state = loadColsState();   // {0:true, 1:false, ...}

    const headerCells = table.querySelectorAll('thead tr th');
    headerCells.forEach((th, idx)=>{
      const visible = state[idx] !== false;   // default: visible
      th.style.display = visible ? '' : 'none';
    });

    table.querySelectorAll('tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      tds.forEach((td, idx)=>{
        const visible = state[idx] !== false;
        td.style.display = visible ? '' : 'none';
      });
    });

    // Sincronizar checkboxes del panel (individuales + master)
    const panel  = document.getElementById('columnToggles');
    const master = panel ? panel.querySelector('#col-toggle-all') : null;
    if(panel){
      const checks = panel.querySelectorAll('.col-toggle');
      let allOn = true;
      checks.forEach(cb=>{
        const idx = parseInt(cb.dataset.col || '0', 10);
        const visible = state[idx] !== false;
        cb.checked = visible;
        if(!visible) allOn = false;
      });
      if(master){
        master.checked = allOn;
      }
    }
  }

  function engancharColumnToggles(){
    const panel = document.getElementById('columnToggles');
    if(!panel) return;

    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    // Individuales
    checks.forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const idx   = parseInt(cb.dataset.col || '0', 10);
        const state = loadColsState();
        state[idx]  = cb.checked;     // true/false
        saveColsState(state);
        applyColumnVisibility();      // esto tambi√©n actualiza el master
      });
    });

    // ‚úÖ Master: "Show all columns"
    if(master){
      master.addEventListener('change', ()=>{
        const state = loadColsState();
        const val   = master.checked;   // true = mostrar todas, false = ocultar todas

        checks.forEach(cb=>{
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });

        saveColsState(state);
        applyColumnVisibility();
      });
    }
  }
  /* ======================================================== */

  /* ======== Cerrar el dropdown al hacer clic fuera ======== */
  function initColumnsDropdown(){
    const details = document.querySelector('details.relative');
    if(!details) return;

    document.addEventListener('click', (e)=>{
      if(!details.open) return;
      // Si el clic fue dentro del <details>, no cerramos
      if(details.contains(e.target)) return;
      // Clic fuera ‚Üí cerramos
      details.open = false;
    });
  }
  /* ======================================================== */

  // üëá SIEMPRE mantener sincronizado el hidden "cantidad" con el select #cantidad
  function syncCantidad(){
    if (!filtrosForm || !zona) return;
    const sel    = zona.querySelector('#cantidad');
    const hidden = filtrosForm.querySelector('input[name="cantidad"]');
    if (sel && hidden) {
      hidden.value = sel.value;
    }
  }

  function paramsFromFilters(resetPage){
    // antes de leer filtros, aseguramos que cantidad est√© sincronizado
    syncCantidad();
    const p = new URLSearchParams(new FormData(filtrosForm));
    if (resetPage) p.set('page','1');
    return p;
  }

  async function cargarTablaCon(qs, push=true){
    // üëá guardar scroll actual antes de refrescar (para NO perder la posici√≥n)
    const prevX = (getScrollBox()?.scrollLeft) ?? readSavedX();
    saveX(prevX);

    const url = `${location.pathname}?${qs}`;
    if (push) history.replaceState(null, '', url);
    exportLink.href = `{% url 'facturacion:exportar_cartola' %}?` + qs;

    if (controller) controller.abort();
    controller = new AbortController();

    const resp = await fetch(url, { signal: controller.signal });
    const html = await resp.text();
    const doc  = new DOMParser().parseFromString(html, 'text/html');
    const nuevaZona = doc.getElementById('zonaTabla');
    if (!nuevaZona) return;

    zona.innerHTML = nuevaZona.innerHTML;

    // Re-enganchar handlers
    engancharPaginacion();
    engancharAprobar();
    engancharCantidad();
    engancharColumnToggles();

    // üëá sincronizar cantidad despu√©s del re-render
    syncCantidad();

    // üëá aplicar visibilidad de columnas despu√©s de re-render
    applyColumnVisibility();

    // üëá restaurar scroll horizontal y volver a escuchar
    restoreX(prevX);
    hookScrollSaver();
  }

  function refiltrar(resetPage=true){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>{
      const p = paramsFromFilters(resetPage);
      cargarTablaCon(p.toString(), true);
    }, 300);
  }

  filtrosForm.querySelectorAll('.filtro').forEach(el=>{
    const evt = el.tagName === 'SELECT' ? 'change' : 'input';
    el.addEventListener(evt, ()=>refiltrar(true));
    el.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); refiltrar(true); }
    });
  });

  function engancharPaginacion(){
    zona.querySelectorAll('a.pg-link').forEach(a=>{
      a.addEventListener('click', ev=>{
        ev.preventDefault();
        const href = new URL(a.getAttribute('href'), location.href);
        const p = paramsFromFilters(false);
        p.set('page', href.searchParams.get('page') || '1');
        cargarTablaCon(p.toString(), true);
      });
    });
  }

  function engancharCantidad(){
    const sel = zona.querySelector('#cantidad');
    if(!sel) return;

    // al cargar, sincronizar hidden con el valor actual del select
    syncCantidad();

    sel.addEventListener('change', ()=>{
      // cada vez que cambie el select, actualizamos el hidden
      syncCantidad();
      const p = paramsFromFilters(true);
      p.set('cantidad', sel.value);   // por si acaso, lo reforzamos en el QS
      cargarTablaCon(p.toString(), true);
    });
  }

  function engancharAprobar(){
    zona.querySelectorAll('.js-approve').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.preventDefault();
        const url = btn.dataset.url;
        const method = (btn.dataset.method || 'POST').toUpperCase();
        try{
          if(method === 'GET'){
            await fetch(url, { method: 'GET' });
          }else{
            const fd  = new FormData();
            fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            await fetch(url, { method:'POST', body: fd });
          }
          // üëá aqu√≠ usamos paramsFromFilters(false) que ya respeta "cantidad"
          const p = paramsFromFilters(false);
          await cargarTablaCon(p.toString(), false);
        }catch(_){}
      });
    });
  }

  window.abrirModalRechazo = function(id){
    const modal = document.getElementById('modalRechazo');
    const form  = document.getElementById('formRechazo');
    form.dataset.movId = id;
    modal.classList.remove('hidden'); modal.classList.add('flex');
  };
  window.cerrarModalRechazo = function(){
    const modal = document.getElementById('modalRechazo');
    modal.classList.add('hidden'); modal.classList.remove('flex');
  };
  document.getElementById('formRechazo').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.currentTarget;
    const id   = form.dataset.movId;
    if(!id) return;
    const url  = `/facturacion/cartola/rechazar/${id}/`;
    const fd   = new FormData(form);
    fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    await fetch(url, { method:'POST', body: fd });
    cerrarModalRechazo();
    const p = paramsFromFilters(false);
    await cargarTablaCon(p.toString(), false);
  });

  // Inicial
  engancharPaginacion();
  engancharAprobar();
  engancharCantidad();
  engancharColumnToggles();
  initColumnsDropdown();

  // üëá aplicar visibilidad de columnas en la carga inicial
  applyColumnVisibility();

  // üëá aplicar estado de scroll al cargar y seguir guard√°ndolo
  restoreX(readSavedX());
  hookScrollSaver();

  // üëá y dejar "cantidad" sincronizado desde el inicio
  syncCantidad();
})();
</script>

</div>
{% endblock %}