{% extends "dashboard_admin/base.html" %}

{% block dashboard_content %}
<div class="max-w-8xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">New Invoice</h2>
      <p class="text-slate-600 text-sm">Loaded with your selected template and branding.</p>
    </div>
    <div class="flex items-center gap-2">
      <a href="{% url 'invoicing:invoices_list' %}" class="px-3 py-2 rounded-lg border text-sm">Back</a>
      <button id="btn-save" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-full text-sm shadow">
        ðŸ’¾ Save
      </button>
    </div>
  </div>

  <div class="rounded-xl overflow-hidden ring-1 ring-slate-200">
    <iframe id="invoice-frame" src="{{ preview_url }}" class="w-full h-[820px] bg-slate-50" loading="lazy"></iframe>
  </div>
</div>

<script>
  // Flags que vienen desde la view invoice_new
  const EDIT_MODE       = {{ edit_mode|yesno:"true,false" }};
  const EDIT_INVOICE_ID = "{{ edit_invoice_id|default:'' }}";
</script>

<script>
function getCSRF(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:""; }

/* === Forzar fecha HOY dentro del iframe (SOLO en modo NUEVO / DUPLICAR) === */
(function(){
  const iframe = document.getElementById('invoice-frame');

  function toYMD(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function forceDefaultDates(){
    try{
      // â—ï¸Si estamos en modo ediciÃ³n, NO tocamos las fechas
      if (EDIT_MODE) return true;

      const fdoc = iframe.contentDocument || iframe.contentWindow.document;
      if(!fdoc) return false;

      const inputDate = fdoc.querySelector('#inv-date');
      const inputDue  = fdoc.querySelector('#inv-due');

      if(!inputDate) return false; // aÃºn no estÃ¡ renderizado

      // Siempre forzar a HOY (solo nueva/duplicar)
      const today = toYMD(new Date());
      inputDate.value = today;

      // Due = hoy + 30
      if (inputDue){
        const d = new Date();
        d.setDate(d.getDate()+30);
        inputDue.value = toYMD(d);
      }

      // Evitar autocompletado del navegador
      inputDate.setAttribute('autocomplete','off');
      if (inputDue) inputDue.setAttribute('autocomplete','off');

      return true;
    }catch(e){ return false; }
  }

  // Si el iframe termina de cargar despuÃ©s:
  iframe.addEventListener('load', ()=> {
    if (!forceDefaultDates()){
      const t0 = Date.now();
      const timer = setInterval(()=>{
        if (forceDefaultDates() || Date.now() - t0 > 3000) clearInterval(timer);
      }, 100);
    }
  });

  // Si el iframe ya estaba listo cuando se aÃ±adiÃ³ el listener:
  try{
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    if (doc && doc.readyState !== 'loading'){
      if (!forceDefaultDates()){
        const t0 = Date.now();
        const timer = setInterval(()=>{
          if (forceDefaultDates() || Date.now() - t0 > 3000) clearInterval(timer);
        }, 100);
      }
    }
  }catch(e){}
})();

/* === Guardar (crear vs actualizar) === */
document.getElementById('btn-save').addEventListener('click', async ()=>{
  const iframe = document.getElementById('invoice-frame');
  const fdoc = iframe.contentDocument || iframe.contentWindow.document;

  // --- lectores genÃ©ricos para notas/tÃ©rminos ---
  function readField(fdoc, selectors){
    for (const sel of selectors){
      const el = fdoc.querySelector(sel);
      if (!el) continue;
      if ('value' in el) return (el.value || '').trim();
      if (el.isContentEditable) return (el.innerText || el.textContent || '').trim();
      return (el.textContent || '').trim();
    }
    return '';
  }
  const NOTES_SELECTORS = [
    '#notes-area','textarea[name="notes"]','#notes','.notes-area',
    '[data-field="notes"]','[data-role="notes"]','[name="notes"]',
    '[contenteditable][data-field="notes"]'
  ];
  const TERMS_SELECTORS = [
    '#terms-area','textarea[name="terms"]','#terms','.terms-area',
    '[data-field="terms"]','[data-role="terms"]','[name="terms"]',
    '[contenteditable][data-field="terms"]'
  ];

  // --- tomar desde iframe (si existen) ---
  let number   = fdoc.querySelector('#inv-number')?.value?.trim() || '';
  let issue    = fdoc.querySelector('#inv-date')?.value || '';
  let due      = fdoc.querySelector('#inv-due')?.value || '';
  let notes    = readField(fdoc, NOTES_SELECTORS);
  let terms    = readField(fdoc, TERMS_SELECTORS);
  let taxPct   = parseFloat(fdoc.querySelector('#tax-percent')?.value || '0') || 0;
  let currency = fdoc.getElementById('invoice-root')?.dataset?.currency || '$';
  const profileId = {{ profile.id|default:'null' }};
  const templateKey =
    fdoc.querySelector('meta[name="template-key"]')?.content ||
    fdoc.getElementById('invoice-root')?.dataset?.templateKey ||
    "{{ profile.template_key|default:'classic' }}";

  // customer id dentro del iframeâ€¦ o desde PREFILL de respaldo
  let custId = fdoc.querySelector('#billto-addr strong')?.dataset?.customerId
            || (window.__PREFILL__?.customer_id ? String(window.__PREFILL__.customer_id) : '');

  // Respaldo de currency/tax/due desde PREFILL si no hay en iframe
  if (!currency && window.__PREFILL__?.currency_symbol) currency = window.__PREFILL__.currency_symbol;
  if ((!taxPct || isNaN(taxPct)) && window.__PREFILL__?.tax_percent != null) {
    taxPct = parseFloat(window.__PREFILL__.tax_percent) || 0;
  }
  if (!due && window.__PREFILL__?.due_date) {
    due = window.__PREFILL__.due_date;
  }

  // â—ï¸Solo NUEVA / DUPLICAR generan nÃºmero automÃ¡tico si falta
  if (!EDIT_MODE && !number) {
    try{
      const q = custId ? `?customer_id=${custId}` : '';
      const r = await fetch("{% url 'invoicing:api_invoice_next_number' %}"+q, {credentials:'same-origin'});
      const j = await r.json();
      if (j.ok && j.number) number = j.number;
    }catch(_){}
  }

  if (!custId) { alert('Select a customer first.'); return; }
  if (!number) { alert('Invoice number is required.'); return; }

  // Buscar filas de items en el iframe
  const rows = Array.from(fdoc.querySelectorAll('#items-body tr.row'));
  let items = rows.map(tr=>{
    const g = s=> tr.querySelector(s);
    const qty  = parseFloat(g('.i-qty')?.value || '0') || 0;
    const rate = parseFloat(g('.i-rate')?.value || '0') || 0;
    const amt  = +(qty*rate).toFixed(2);
    return {
      daily:       g('.i-daily')?.value?.trim() || '',
      job_code:    g('.i-job')?.value?.trim() || '',
      description: g('.i-desc')?.value?.trim() || '',
      qty, uom:    g('.i-unit')?.value?.trim() || '',
      rate, amount: amt
    };
  }).filter(x=> x.job_code || x.description || x.amount);

  // --- RESPALDO: si no hay items en el iframe, usa los del PREFILL ---
  if (!items.length && window.__PREFILL__?.items?.length) {
    items = window.__PREFILL__.items.map(it => {
      const qty  = parseFloat(it.qty || '0')  || 0;
      const rate = parseFloat(it.rate || '0') || 0;
      return {
        daily:       (it.daily || ''),
        job_code:    (it.job_code || ''),
        description: (it.description || ''),
        qty, uom:    (it.uom || ''),
        rate, amount: +(qty*rate).toFixed(2)
      };
    }).filter(x=> x.job_code || x.description || x.amount);
  }

  // --- payload base ---
  const payload = {
    number,
    issue_date: issue,
    due_date:   due,
    customer_id: Number(custId),
    currency_symbol: currency || '$',
    tax_percent: taxPct || 0,
    items,
    notes,
    terms,
    profile_id: profileId,
    template_key: templateKey
  };

  // --- decidir si CREAR o ACTUALIZAR ---
  let url;
  if (EDIT_MODE && EDIT_INVOICE_ID) {
    payload.id = Number(EDIT_INVOICE_ID);
    url = "{% url 'invoicing:api_invoice_update' %}";
  } else {
    url = "{% url 'invoicing:api_invoice_create' %}";
  }

  try{
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json", "X-CSRFToken": getCSRF() },
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || 'Error');
    window.location.href = "{% url 'invoicing:invoices_list' %}";
  }catch(e){
    alert('Could not save invoice.');
    console.error(e);
  }
});
</script>
<script>window.__PREFILL__ = null;</script>
{% if prefill_api %}
<script>
(function(){
  const iframe = document.getElementById('invoice-frame');
  const PREFILL_URL = "{{ prefill_api|escapejs }}";
  if (!PREFILL_URL) return;

  /* -------- Fallback de totales desde el padre (si el template no expone recalcTotals) -------- */
  function parentRecalcTotals(){
    try{
      const fdoc = iframe.contentDocument || iframe.contentWindow?.document;
      if (!fdoc) return;
      const rows = Array.from(fdoc.querySelectorAll('#items-body tr.row'));
      const subtotalNum = rows.reduce((acc,tr)=>{
        const qty  = parseFloat(tr.querySelector('.i-qty')?.value || '0') || 0;
        const rate = parseFloat(tr.querySelector('.i-rate')?.value || '0') || 0;
        return acc + (qty * rate);
      }, 0);

      const taxPctEl = fdoc.querySelector('#tax-percent');
      const taxPct = parseFloat(taxPctEl?.value || '0') || 0;
      const taxNum = +(subtotalNum * (taxPct/100)).toFixed(2);
      const totalNum = +(subtotalNum + taxNum).toFixed(2);

      const write = (sel, val)=>{
        const el = fdoc.querySelector(sel);
        if (!el) return false;
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = val;
        else el.textContent = val;
        return true;
      };
      const fmt = (n)=> (isNaN(n) ? '0.00' : n.toFixed(2));

      ['#subtotal-val','.subtotal-val','#subtotal','[data-field="subtotal"]','input[name="subtotal"]']
        .some(s => write(s, fmt(subtotalNum)));
      ['#tax-amount','.tax-amount','#tax','#tax-val','.tax-val','[data-field="tax_amount"]','input[name="tax_amount"]']
        .some(s => write(s, fmt(taxNum)));
      ['#total-val','.total-val','#total','[data-field="total"]','input[name="total"]']
        .some(s => write(s, fmt(totalNum)));

      iframe.contentWindow.__parentTotals = { subtotal: subtotalNum, taxAmt: taxNum, total: totalNum };
      (fdoc).dispatchEvent(new CustomEvent('invoice:totals', { bubbles: true, detail: { subtotal: subtotalNum, taxAmt: taxNum, total: totalNum } }));
    }catch(_){}
  }

  /* -------- Utilidades para precargar notas y tÃ©rminos con reintentos -------- */
  function setInto(el, text){
    if (!el) return false;
    if ('value' in el) {
      el.value = text;
    } else if (el.isContentEditable) {
      el.innerHTML = String(text).replace(/\n/g, '<br>');
    } else {
      el.textContent = text;
    }
    try {
      el.dispatchEvent(new Event('input', {bubbles:true}));
      el.dispatchEvent(new Event('change', {bubbles:true}));
    } catch(_) {}
    return true;
  }

  function fillNotesTermsOnce(fdoc, prefill){
    let okNotes = true, okTerms = true;

    if (typeof prefill.notes === 'string' && prefill.notes) {
      okNotes = [
        '#notes-area','textarea[name="notes"]','#notes','.notes-area',
        '[data-field="notes"]','[data-role="notes"]','[name="notes"]',
        '[contenteditable][data-field="notes"]'
      ].some(sel => setInto(fdoc.querySelector(sel), prefill.notes));
      try { if (!okNotes && fdoc.defaultView?.setNotes) { fdoc.defaultView.setNotes(prefill.notes); okNotes = true; } } catch(_){}
    }

    if (typeof prefill.terms === 'string' && prefill.terms) {
      okTerms = [
        '#terms-area','textarea[name="terms"]','#terms','.terms-area',
        '[data-field="terms"]','[data-role="terms"]','[name="terms"]',
        '[contenteditable][data-field="terms"]'
      ].some(sel => setInto(fdoc.querySelector(sel), prefill.terms));
      try { if (!okTerms && fdoc.defaultView?.setTerms) { fdoc.defaultView.setTerms(prefill.terms); okTerms = true; } } catch(_){}
    }

    return okNotes && okTerms;
  }

  function fillNotesTermsWithRetries(fdoc, prefill, ms=100, maxTries=40){
    let tries = 0;
    const tryFill = ()=>{
      const done = fillNotesTermsOnce(fdoc, prefill);
      tries++;
      if (done || tries >= maxTries) clearInterval(timer);
    };
    const timer = setInterval(tryFill, ms);
    tryFill(); // primer intento inmediato
  }

  async function applyPrefill(){
    const fdoc = iframe.contentDocument || iframe.contentWindow?.document;
    if (!fdoc) return;

    const res = await fetch(PREFILL_URL, {credentials: 'same-origin'});
    const {ok, prefill} = await res.json();
    if (!ok || !prefill) return;
    window.__PREFILL__ = prefill;

    // --- CUSTOMER (full card) ---
    const bill = fdoc.querySelector('#billto-addr');
    const C = (prefill.customer || {});
    if (bill && (C.name || prefill.customer_name)) {
      bill.innerHTML = `
        <strong data-customer-id="${C.id || prefill.customer_id || ''}">${C.name || prefill.customer_name || ''}</strong><br>
        ${(C.street_1 || '')}<br>
        ${(C.city || '')}${C.state ? (', ' + C.state) : ''} ${(C.zip_code || '')}<br>
        ${(C.email || '')}${C.phone ? (' Â· ' + C.phone) : ''}
      `;
    }

    const custHidden = fdoc.querySelector('input[name="customer_id"]');
    if (custHidden && prefill.customer_id) custHidden.value = prefill.customer_id;

    // --- DATES / TAX / CURRENCY ---
    if (EDIT_MODE) {
      // âžœ EDITAR: respetar fechas y nÃºmero de la factura original
      if (prefill.issue_date){
        const issue = fdoc.getElementById('inv-date');
        if (issue){
          issue.value = prefill.issue_date;
          issue.dispatchEvent(new Event('input',{bubbles:true}));
        }
      }
      if (prefill.due_date){
        const due = fdoc.getElementById('inv-due');
        if (due){
          due.value = prefill.due_date;
          due.dispatchEvent(new Event('input',{bubbles:true}));
        }
      }
      if (prefill.number){
        const num = fdoc.getElementById('inv-number');
        if (num){
          num.value = prefill.number;
          num.dispatchEvent(new Event('input',{bubbles:true}));
        }
      }
    } else {
      // âžœ NUEVA / DUPLICAR:
      // las fechas se ponen en el script exterior (HOY / HOY+30)
      // aquÃ­ solo podrÃ­as tocar due_date si quisieras, pero lo dejamos tal cual.
    }

    if (prefill.tax_percent != null){
      const tax = fdoc.getElementById('tax-percent');
      if (tax){
        tax.value = prefill.tax_percent;
        tax.dispatchEvent(new Event('input',{bubbles:true}));
      }
    }
    if (prefill.currency_symbol){
      const root = fdoc.getElementById('invoice-root');
      if (root){ root.dataset.currency = prefill.currency_symbol; }
    }

    // --- NÃšMERO DE FACTURA ---
    if (!EDIT_MODE) {
      // âžœ DUPLICAR / NUEVA: sugerir nÃºmero nuevo
      try{
        const q = prefill.customer_id ? `?customer_id=${prefill.customer_id}` : '';
        const r = await fetch("{% url 'invoicing:api_invoice_next_number' %}"+q, {credentials:'same-origin'});
        const j = await r.json();
        if (j.ok && j.number){
          const num = fdoc.getElementById('inv-number');
          if (num){
            num.value = j.number;
            num.dispatchEvent(new Event('input',{bubbles:true}));
          }
        }
      }catch(_){}
    }
    // En EDIT_MODE el nÃºmero ya lo pusimos arriba desde prefill.number

    // --- ITEMS ---
    const tbody = fdoc.querySelector('#items-body');
    if (tbody){
      // Limpia filas actuales
      Array.from(tbody.querySelectorAll('tr.row')).forEach(tr => tr.remove());
      const currency = (fdoc.getElementById('invoice-root')?.dataset?.currency || '$');

      (prefill.items || []).forEach((it, idx) => {
        const tr = fdoc.createElement('tr');
        tr.className = 'row';

        const q = parseFloat(it.qty || '0') || 0;
        const r = parseFloat(it.rate || '0') || 0;
        const amount = (q * r).toFixed(2);
        const dlId = `jobcodes-list-pre-${idx}`;

        tr.innerHTML = `
          <td><input class="line-input i-daily" value="${(it.daily||'').replace(/"/g,'&quot;')}"></td>
          <td class="jobcell">
            <input class="line-input i-job" value="${(it.job_code||'').replace(/"/g,'&quot;')}" list="${dlId}" autocomplete="off">
            <datalist id="${dlId}"></datalist>
            <div class="sugmenu" hidden></div>
          </td>
          <td><input class="line-input i-desc" value="${(it.description||'').replace(/"/g,'&quot;')}" readonly></td>
          <td class="num"><input class="line-input i-qty" type="number" min="0" step="0.01" style="text-align:right" value="${q || ''}"></td>
          <td><input class="line-input i-unit" value="${(it.uom||'').replace(/"/g,'&quot;')}" readonly></td>
          <td class="num"><input class="line-input i-rate" value="${r || ''}" readonly style="text-align:right"></td>
          <td class="num">
            <span class="i-amount-show">${currency}${amount}</span>
            <input class="i-amount" type="hidden" value="${amount}">
          </td>
          <td class="row-actions"><button type="button" class="btn" data-del>âœ•</button></td>
        `;
        tbody.appendChild(tr);
      });

      // --- Enlazar recalculo para filas nuevas (delegaciÃ³n) ---
      const rootWin = iframe.contentWindow;
      const itemsBody = fdoc.getElementById('items-body');

      if (itemsBody && !rootWin.__rowsBound) {
        const onRowChange = (ev) => {
          const t = ev.target;
          if (!t.classList) return;
          if (!(t.classList.contains('i-qty') || t.classList.contains('i-rate'))) return;

          const tr = t.closest('tr.row');
          if (!tr) return;
          const g = (sel) => tr.querySelector(sel);

          const qty  = parseFloat(g('.i-qty')?.value || '0')  || 0;
          const rate = parseFloat(g('.i-rate')?.value || '0') || 0;
          const amount = +(qty * rate).toFixed(2);

          const cur = (fdoc.getElementById('invoice-root')?.dataset?.currency || '$');

          // Actualiza columna de monto de la fila
          const amtHidden = g('.i-amount');
          if (amtHidden) amtHidden.value = amount.toFixed(2);
          const amtShow = g('.i-amount-show');
          if (amtShow)  amtShow.textContent = `${cur}${amount.toFixed(2)}`;

          // Recalcular totales generales
          if (typeof rootWin.recalcTotals === 'function') {
            try { rootWin.recalcTotals(); } catch (_) { parentRecalcTotals(); }
          } else {
            parentRecalcTotals();
          }
        };

        itemsBody.addEventListener('input', onRowChange);
        itemsBody.addEventListener('change', onRowChange);
        itemsBody.addEventListener('keyup', onRowChange);

        // Borrar fila y recalcular
        itemsBody.addEventListener('click', (ev) => {
          const btn = ev.target.closest('[data-del]');
          if (!btn) return;
          const tr = btn.closest('tr.row');
          if (tr) tr.remove();
          if (typeof rootWin.recalcTotals === 'function') {
            try { rootWin.recalcTotals(); } catch (_) { parentRecalcTotals(); }
          } else {
            parentRecalcTotals();
          }
        });

        // marca para no duplicar listeners si se reinyecta
        rootWin.__rowsBound = true;
      }

      // Escucha cambios del impuesto
      const taxInput = fdoc.getElementById('tax-percent');
      if (taxInput && !iframe.contentWindow.__taxBound) {
        ['input','change','keyup'].forEach(evt => {
          taxInput.addEventListener(evt, () => {
            if (typeof iframe.contentWindow.recalcTotals === 'function') {
              try { iframe.contentWindow.recalcTotals(); } catch (_) { parentRecalcTotals(); }
            } else {
              parentRecalcTotals();
            }
          });
        });
        iframe.contentWindow.__taxBound = true;
      }

      // Recalcular totales despuÃ©s de inyectar
      if (typeof iframe.contentWindow.recalcTotals === 'function'){
        try{ iframe.contentWindow.recalcTotals(); }catch(_){ parentRecalcTotals(); }
      } else {
        parentRecalcTotals();
      }

      // === Reaplicar notas/tÃ©rminos *despuÃ©s* del primer recÃ¡lculo ===
      fillNotesTermsWithRetries(fdoc, prefill, 120, 40);

      // Observa cambios del DOM para re-aplicar si el template re-renderiza
      if (!iframe.contentWindow.__notesObserver) {
        const target = fdoc.getElementById('invoice-root') || fdoc.body;
        const obs = new MutationObserver(() => {
          if (window.__PREFILL__) {
            fillNotesTermsOnce(fdoc, window.__PREFILL__);
          }
        });
        obs.observe(target, { childList: true, subtree: true });
        iframe.contentWindow.__notesObserver = obs;
      }
    }
  }

  // Corre DESPUÃ‰S de que el iframe y sus scripts internos hayan pintado defaults
  iframe.addEventListener('load', ()=>{
    setTimeout(applyPrefill, 180);
  });

  // si ya estaba cargado (cache), aplica igual
  try{
    const doc = iframe.contentDocument || iframe.contentWindow?.document;
    if (doc && doc.readyState !== 'loading'){
      setTimeout(applyPrefill, 180);
    }
  }catch(_){}
})();
</script>
{% endif %}
{% endblock %}