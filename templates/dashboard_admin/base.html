<!DOCTYPE html>
{% load static %}
{% load humanize %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .rotate-90 { transform: rotate(90deg); }
        .bg-sidebar { background-color: #1e293b; }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 min-h-screen">

<!-- HEADER SUPERIOR FIJO -->
<header class="bg-white shadow-md fixed top-0 left-0 w-full z-50 px-4 py-2">
  <div class="relative flex flex-col sm:flex-row sm:items-center sm:justify-between w-full">

    <!-- Campanita de notificaciones -->
    <div class="absolute top-2 right-4 z-50">
      <button onclick="toggleNotifications()" class="relative text-gray-700">
        <i data-lucide="bell" class="w-6 h-6"></i>
        {% if notificaciones_no_leidas > 0 %}
          <span class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">
            {{ notificaciones_no_leidas }}
          </span>
        {% endif %}
      </button>

      <!-- Panel desplegable de notificaciones -->
      <div id="notification-panel"
           class="hidden absolute right-0 mt-2 w-72 bg-white border rounded-lg shadow-lg z-50">
        <div class="p-2 max-h-80 overflow-y-auto">
          {% for n in notificaciones_recientes %}
            <div id="notificacion-{{ n.id }}">
              <a href="{% url 'usuarios:leer_notificacion' n.id %}"
                 class="block p-2 text-sm border-b w-full text-left {% if not n.leido %}bg-yellow-100{% else %}hover:bg-gray-100{% endif %}">
                <div class="flex flex-col">
                  <span>{{ n.mensaje }}</span>
                  <span class="text-xs text-gray-400">{{ n.fecha|naturaltime }}</span>
                </div>
              </a>
            </div>
          {% empty %}
            <p class="text-sm text-gray-500 p-2">No notification history.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Contenido principal del header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between w-full pr-16 gap-2 sm:gap-0 mt-[-8px]">

      <!-- IZQUIERDA: Logo y nombre -->
      <div class="flex items-center gap-3">
        <button onclick="toggleSidebar()" class="md:hidden text-gray-800 text-2xl">☰</button>
        <img src="{% static 'images/logoh.png' %}" alt="Logo" class="h-12">
        <strong class="text-gray-800 text-sm md:text-base whitespace-nowrap">HYPERLINK NETWORKS PLATFORM</strong>
      </div>

      <!-- DERECHA: Nombre del usuario y botón de logout -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-end sm:gap-4 items-start text-sm md:text-base text-right leading-tight">
        <span class="text-gray-800 font-medium break-words sm:whitespace-nowrap">
          {{ request.user.get_full_name|default:request.user.username }}
        </span>
        <form method="post" action="{% url 'dashboard_admin:logout' %}">
          {% csrf_token %}
          <button type="submit" class="text-red-600 font-semibold hover:text-red-800 whitespace-nowrap">
            Log Out
          </button>
        </form>
      </div>

    </div>
  </div>
</header>

<!-- CONTENEDOR PRINCIPAL -->
<div class="pt-14 flex flex-col md:flex-row min-h-screen relative content-wrapper">

  <!-- MENÚ LATERAL -->
  <nav id="side-nav"
    class="bg-gray-800 text-white w-72 p-4 fixed top-14 left-0 bottom-0 overflow-y-auto z-40 transition-transform transform -translate-x-full md:translate-x-0">
    <h2 class="text-2xl font-bold mb-8">Menu</h2>
    <ul class="space-y-4 text-base">
      <li>
        <a href="{% url 'dashboard_admin:inicio_admin' %}" class="font-bold flex items-center hover:text-emerald-400">🏠 Home</a>
      </li>

      <!-- SECCIÓN: Operations -->
      {% if request.user.es_admin_general or request.user.es_supervisor or request.user.es_pm %}
      <li class="group">
        <div class="flex justify-between items-center cursor-pointer hover:text-emerald-400"
            onclick="toggleMenu(this)">
            <span class="flex items-center gap-2">🛠 Operations</span>
            <span class="flecha transition-transform duration-200">▶</span>
        </div>
        <ul class="ml-4 submenu space-y-1 hidden">
          <li><a href="#" class="hover:text-emerald-400">Overtime</a></li>
          <li><a href="#" class="hover:text-emerald-400">Productions</a></li>
          <li><a href="{% url 'operaciones:vista_rendiciones' %}" class="hover:text-emerald-400">Expense Reports</a></li>
          <li><a href="#" class="hover:text-emerald-400">Assign Services</a></li>
        </ul>
      </li>
      {% endif %}

      <!-- SECCIÓN: Human Resources -->
      {% if request.user.es_admin_general or request.user.es_rrhh or request.user.es_pm or request.user.es_supervisor %}
      <li class="group">
        <div class="flex justify-between items-center cursor-pointer hover:text-emerald-400" onclick="toggleMenu(this)">
          <span class="flex items-center gap-2">🧑‍💼 Human Resources</span>
          <span class="flecha transition-transform duration-200">▶</span>
        </div>
        <ul class="ml-4 submenu space-y-1 hidden">
          {% if request.user.es_admin_general or request.user.es_rrhh or request.user.es_pm %}
            <li><a href="#" class="hover:text-emerald-400">Rate Sheets</a></li>
            <li><a href="#" class="hover:text-emerald-400">Employment Agreement</a></li>
          {% endif %}
          {% if request.user.es_admin_general or request.user.es_rrhh or request.user.es_pm %}
            <li><a href="#" class="hover:text-emerald-400">Employee Onboarding</a></li>
            <li><a href="#" class="hover:text-emerald-400">Employee Documents</a></li>
            <li><a href="#" class="hover:text-emerald-400">Signature Records</a></li>
            <li><a href="#" class="hover:text-emerald-400">Upload Legal Representative Signature</a></li>
          {% endif %}
        </ul>
      </li>
      {% endif %}

      <!-- SECCIÓN: Subcontract -->
      {% if request.user.es_admin_general or request.user.es_logistica or request.user.es_subcontrato or request.user.es_pm or request.user.es_supervisor %}
      <li class="group">
          <div class="flex justify-between items-center cursor-pointer hover:text-emerald-400" onclick="toggleMenu(this)">
              <span class="flex items-center gap-2">🤝 Subcontractors</span>
              <span class="flecha transition-transform duration-200">▶</span>
          </div>
          <ul class="ml-4 submenu space-y-1 hidden">
              <li><a href="#" class="hover:text-emerald-400">Upload Production</a></li>
            <li><a href="#" class="hover:text-emerald-400">Onboarding Documents</a></li>   
          </ul>
      </li>
      {% endif %}

      <!-- SECCIÓN: Logistics -->
      {% if request.user.es_admin_general or request.user.es_logistica or request.user.es_pm %}
      <li class="group">
          <div class="flex justify-between items-center cursor-pointer hover:text-emerald-400"
              onclick="toggleMenu(this)">
              <span class="flex items-center gap-2">📦 Logistics</span>
              <span class="flecha transition-transform duration-200">▶</span>
          </div>
          <ul class="ml-4 submenu space-y-1 hidden">
              <li><a href="#" class="hover:text-emerald-400">Material Return</a></li>
              <li><a href="#" class="hover:text-emerald-400">Material Delivery</a></li>
              <li><a href="#" class="hover:text-emerald-400">Material Transfer</a></li>
              <li><a href="#" class="hover:text-emerald-400"Material Receiving</a></li>   
      	<li><a href="#" class="hover:text-emerald-400">Equipment Assignment</a></li>
	<li><a href="#" class="hover:text-emerald-400">Assigned PPE</a></li>
          </ul>
      </li>
      {% endif %}

      <!-- SECCIÓN: Finance -->
      {% if request.user.es_admin_general or request.user.es_pm or request.user.es_facturacion %}
      <li class="group">
          <div class="flex justify-between items-center cursor-pointer hover:text-emerald-400"
              onclick="toggleMenu(this)">
              <span class="flex items-center gap-2">📑 Finance</span>
              <span class="flecha transition-transform duration-200">▶</span>
          </div>
          <ul class="ml-4 submenu space-y-1 hidden">
              <li><a href="#" class="hover:text-emerald-400">Purchase Orders</a></li>
              <li><a href="#" class="hover:text-emerald-400">Invoices</a></li>
              <li><a href="{% url 'facturacion:listar_cartola' %}" class="hover:text-emerald-400">Account Transactions</a></li>
              <li><a href="{% url 'facturacion:listar_saldos_usuarios' %}" class="hover:text-emerald-400">Available Balances</a></li>
          </ul>
      </li>
      {% endif %}

      <!-- SECCIÓN: User Management -->
      {% if request.user.es_admin_general or request.user.es_pm or request.user.es_rrhh %}
      <li class="group">
          <div class="flex justify-between items-center cursor-pointer hover:text-emerald-400"
              onclick="toggleMenu(this)">
              <span class="flex items-center gap-2">👤 User Management</span>
              <span class="flecha transition-transform duration-200">▶</span>
          </div>
          <ul class="ml-4 submenu space-y-1 hidden">
              <li><a href="#" class="hover:text-emerald-400">Groups</a></li>
              <li><a href="{% url 'dashboard_admin:listar_usuarios' %}" class="hover:text-emerald-400">Users</a></li>
          </ul>
      </li>
      {% endif %}
    </ul>

    <!-- Pie de menú -->
    <div class="mt-10 text-center text-gray-400 text-xs">
      <p class="mb-1">Developed by</p>
      <img src="{% static 'images/planixb.png' %}" alt="Planix" class="h-12 mx-auto max-w-[100px] object-contain">
    </div>
  </nav>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="md:ml-72 flex-1 p-6 z-10 bg-gray-100">
    {% block dashboard_content %}{% endblock %}
  </main>
</div>

<!-- SCRIPTS -->
<script>
  // Abrir/cerrar submenús
  function toggleMenu(el) {
    const submenu = el.nextElementSibling;
    const flecha = el.querySelector('.flecha');
    if (submenu && flecha) {
      submenu.classList.toggle('hidden');
      flecha.classList.toggle('rotate-90');
    }
  }

  // Mostrar/ocultar menú lateral
  function toggleSidebar() {
    const nav = document.getElementById('side-nav');
    nav.classList.toggle('-translate-x-full');
  }

  // Mostrar/ocultar panel de notificaciones
  function toggleNotifications() {
    const panel = document.getElementById('notification-panel');
    if (panel) panel.classList.toggle('hidden');
  }
</script>

<script src="https://unpkg.com/lucide@latest"></script>
<script> lucide.createIcons(); </script>

</body>
</html>
