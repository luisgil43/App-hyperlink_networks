{% extends "dashboard_admin/base.html" %}
{% load static %}
{% load underground_extras %}

{% block title %}Underground Route{% endblock %}

{% block dashboard_content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">

  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-4">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">ğŸ§± {{ route.name }}</h2>
      <p class="text-sm text-gray-600">
        Start: <span class="font-semibold">{{ route.start_ft }}</span> ft â€”
        End: <span class="font-semibold">{{ route.end_ft }}</span> ft â€”
        Total: <span class="font-semibold">{{ route.total_length_ft }}</span> ft â€”
        Segment: <span class="font-semibold">{{ route.segment_length_ft }}</span> ft
      </p>
    </div>

    <div class="flex items-center gap-2">
      <form method="post" action="{% url 'underground:route_regenerate_segments' route.id %}">
        {% csrf_token %}
        <button class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm">
          ğŸ” Regenerate segments
        </button>
      </form>

      <a href="{% url 'underground:route_list' %}" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm">
        â† Back
      </a>
    </div>
  </div>

  <!-- Stage selector + summaries -->
  <div class="flex flex-col md:flex-row md:items-center gap-3 mb-4">
    <div class="flex items-center gap-2">
      <span class="text-sm text-gray-700 font-medium">Stage:</span>
      <select id="stageSelect" class="rounded-lg border p-2 text-sm">
        {% for s in stages %}
          <option value="{{ s.code }}" {% if s.id == stage.id %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="flex flex-wrap gap-2">
      {% for ss in stage_summaries %}
        <a href="?stage={{ ss.stage.code }}"
           class="px-3 py-1 rounded-full text-xs border {% if ss.stage.id == stage.id %}bg-blue-50 border-blue-200 text-blue-800{% else %}bg-gray-50 border-gray-200 text-gray-700 hover:bg-gray-100{% endif %}">
          {{ ss.stage.code|upper }}: <span class="font-semibold">{{ ss.done_ft }}</span>/<span>{{ ss.total_ft }}</span> ft
        </a>
      {% endfor %}
    </div>
  </div>

  <!-- Legend -->
  <div class="flex flex-wrap gap-2 text-xs mb-3">
    <span class="inline-flex items-center gap-2 bg-gray-50 border border-gray-200 px-3 py-1 rounded-full">
      <span class="w-3 h-3 rounded bg-gray-300 inline-block"></span> Not started
    </span>
    <span class="inline-flex items-center gap-2 bg-gray-50 border border-gray-200 px-3 py-1 rounded-full">
      <span class="w-3 h-3 rounded bg-amber-400 inline-block"></span> In progress
    </span>
    <span class="inline-flex items-center gap-2 bg-gray-50 border border-gray-200 px-3 py-1 rounded-full">
      <span class="w-3 h-3 rounded bg-emerald-500 inline-block"></span> Done
    </span>
    <span class="inline-flex items-center gap-2 bg-gray-50 border border-gray-200 px-3 py-1 rounded-full">
      <span class="w-3 h-3 rounded bg-red-500 inline-block"></span> Blocked
    </span>
  </div>

  <!-- PIPE -->
  <div class="border rounded-2xl p-4 bg-gradient-to-b from-gray-50 to-white">
    <div class="text-sm text-gray-700 mb-2">
      Viewing stage: <span class="font-semibold">{{ stage.name }}</span>
      â€” click segments to toggle (Done â†” Not started). Right-click for â€œBlockedâ€.
    </div>

    <div class="overflow-x-auto">
      <div class="min-w-[900px]">
        <div class="flex justify-between text-xs text-gray-500 mb-2">
          <div>{{ route.start_ft }} ft</div>
          <div>{{ route.end_ft }} ft</div>
        </div>

        <div id="pipe"
             class="flex items-stretch rounded-full border border-gray-200 bg-white shadow-sm overflow-hidden select-none"
             style="height: 44px;">
          {% for seg in segments %}
            {% with prog=progress_map|get_item:seg.id %}
              {% if prog %}
                {% if prog.status == "done" %}
                  <div class="group relative flex-1 border-r border-white/70 cursor-pointer bg-emerald-500"
                {% elif prog.status == "in_progress" %}
                  <div class="group relative flex-1 border-r border-white/70 cursor-pointer bg-amber-400"
                {% elif prog.status == "blocked" %}
                  <div class="group relative flex-1 border-r border-white/70 cursor-pointer bg-red-500"
                {% else %}
                  <div class="group relative flex-1 border-r border-white/70 cursor-pointer bg-gray-300"
                {% endif %}
              {% else %}
                <div class="group relative flex-1 border-r border-white/70 cursor-pointer bg-gray-300"
              {% endif %}
                   data-segment-id="{{ seg.id }}"
                   title="Seg {{ seg.index }}: {{ seg.from_ft }}â€“{{ seg.to_ft }} ft">
                <div class="hidden group-hover:block absolute -top-9 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-[11px] px-2 py-1 rounded-lg whitespace-nowrap shadow">
                  Seg {{ seg.index }} â€¢ {{ seg.from_ft }}â€“{{ seg.to_ft }} ft
                </div>
              </div>
            {% endwith %}
          {% endfor %}
        </div>

        <div class="flex mt-2 text-[11px] text-gray-500">
          {% for seg in segments %}
            <div class="flex-1 text-center">
              {% if forloop.first %}0{% elif forloop.counter0|divisibleby:2 %}{{ seg.to_ft }}{% else %}&nbsp;{% endif %}
            </div>
          {% endfor %}
        </div>

      </div>
    </div>

    <div id="msg" class="mt-3 text-sm"></div>
  </div>

</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrfToken = (window.getCsrfToken && window.getCsrfToken()) || getCookie('csrftoken') || '';
  const routeId = {{ route.id }};
  const stageSelect = document.getElementById('stageSelect');
  const pipe = document.getElementById('pipe');
  const msg = document.getElementById('msg');

  stageSelect.addEventListener('change', () => {
    const st = stageSelect.value;
    window.location = `?stage=${encodeURIComponent(st)}`;
  });

  function setMsg(text, ok=true) {
    msg.className = ok
      ? "mt-3 text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg p-2"
      : "mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-2";
    msg.textContent = text;
  }

  function colorForStatus(status) {
    if (status === "done") return "bg-emerald-500";
    if (status === "in_progress") return "bg-amber-400";
    if (status === "blocked") return "bg-red-500";
    return "bg-gray-300";
  }

  function updateSegmentEl(el, status) {
    el.classList.remove("bg-emerald-500","bg-amber-400","bg-red-500","bg-gray-300");
    el.classList.add(colorForStatus(status));
  }

  async function postUpdate(segmentId, stageCode, status) {
    const body = new URLSearchParams();
    body.set("segment_id", segmentId);
    body.set("stage_code", stageCode);
    body.set("status", status);

    const res = await fetch(`/underground/${routeId}/update-segment/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrfToken,
      },
      body: body.toString()
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || "Error updating segment.");
    return data;
  }

  pipe.addEventListener('click', async (e) => {
    const el = e.target.closest("[data-segment-id]");
    if (!el) return;

    const stageCode = stageSelect.value;
    const isDone = el.classList.contains("bg-emerald-500");
    const newStatus = isDone ? "not_started" : "done";

    try {
      const data = await postUpdate(el.dataset.segmentId, stageCode, newStatus);
      updateSegmentEl(el, data.status);
      setMsg(`Updated segment â†’ ${stageCode.toUpperCase()} = ${data.status}`);
    } catch (err) {
      setMsg(err.message, false);
    }
  });

  pipe.addEventListener('contextmenu', async (e) => {
    const el = e.target.closest("[data-segment-id]");
    if (!el) return;
    e.preventDefault();

    const stageCode = stageSelect.value;
    try {
      const data = await postUpdate(el.dataset.segmentId, stageCode, "blocked");
      updateSegmentEl(el, data.status);
      setMsg(`Blocked segment on ${stageCode.toUpperCase()}`);
    } catch (err) {
      setMsg(err.message, false);
    }
  });
</script>
{% endblock %}