{% extends "dashboard_admin/base.html" %}
{% load static %}

{% block dashboard_content %}
<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6 mt-6">
  <h1 class="text-2xl font-semibold text-slate-900 mb-2">
    Security
  </h1>

  <p class="text-sm text-slate-600 mb-4">
    Manage your security settings, enable two-factor authentication, and review your trusted devices.
  </p>

  {% if messages %}
    <div class="mb-4 space-y-2">
      {% for message in messages %}
        <div class="text-sm px-3 py-2 rounded
                    {% if message.tags == 'error' %}bg-red-100 text-red-800
                    {% elif message.tags == 'success' %}bg-green-100 text-green-800
                    {% elif message.tags == 'warning' %}bg-amber-100 text-amber-800
                    {% else %}bg-slate-100 text-slate-800{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Sección 1: Two-factor authentication -->
  <div class="border border-slate-200 rounded-xl p-4 mb-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h2 class="text-sm font-semibold text-slate-800">
          Two-factor authentication (2FA)
        </h2>
        <p class="text-xs text-slate-500 mt-1">
          Add an extra layer of security by requiring a verification code from an authentication app when you sign in.
        </p>
      </div>
      {% if two_factor_enabled %}
        <span class="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-800">
          Enabled
        </span>
      {% else %}
        <span class="inline-flex items-center rounded-full bg-amber-100 px-3 py-1 text-xs font-medium text-amber-800">
          Not enabled
        </span>
      {% endif %}
    </div>

    <div class="border border-slate-200 rounded-xl p-4 mb-4">
      <h3 class="text-xs font-semibold text-slate-700 mb-2">
        1. Scan the QR code
      </h3>
      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        <img
          src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={{ otp_uri|urlencode }}"
          alt="2FA QR code"
          class="border border-slate-200 rounded-lg"
        >
        <div class="text-xs text-slate-600 space-y-2">
          <p>
            Open your authentication app (for example <strong>Google Authenticator</strong> or <strong>Authy</strong>)
            and scan this QR code to add your account.
          </p>
          <p>
            If you cannot scan the QR code, you can add the account manually using this key:
          </p>
          <code class="block text-sm font-mono bg-slate-100 px-2 py-1 rounded">
            {{ secret }}
          </code>
        </div>
      </div>
    </div>

    <form method="post" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="action" value="enable_2fa">
      <div>
        <h3 class="text-xs font-semibold text-slate-700 mb-1">
          2. Enter a verification code
        </h3>
        <p class="text-xs text-slate-500 mb-2">
          Enter one of the 6-digit codes generated by your authentication app to confirm that everything is set up correctly.
        </p>
        <input type="text"
               name="code"
               class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
               placeholder="123 456"
               required>
      </div>

      <button type="submit"
              class="inline-flex justify-center px-4 py-2 rounded-lg bg-sky-600 text-white text-sm font-medium hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2">
        Enable two-factor authentication
      </button>
    </form>

    {% if two_factor_enabled %}
      <p class="mt-3 text-xs text-green-700">
        ✅ Two-factor authentication is currently <strong>enabled</strong> for your account.
      </p>
    {% else %}
      <p class="mt-3 text-xs text-amber-700">
        ⚠ Two-factor authentication is <strong>not enabled</strong> yet. It will become mandatory soon. 
        We strongly recommend enabling it now.
      </p>
    {% endif %}
  </div>

  <!-- Sección 2: Trusted devices -->
  <div class="border border-slate-200 rounded-xl p-4">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h2 class="text-sm font-semibold text-slate-800">
          Trusted devices
        </h2>
        <p class="text-xs text-slate-500 mt-1">
          These devices can sign in with your password and 2FA, and will not be asked for a verification code again until they expire.
        </p>
      </div>
    </div>

    {% if devices %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-xs text-left text-slate-700">
          <thead class="bg-slate-50 text-slate-500 uppercase tracking-wide">
            <tr>
              <th class="px-3 py-2">Device</th>
              <th class="px-3 py-2">IP address</th>
              <th class="px-3 py-2">Created</th>
              <th class="px-3 py-2">Last used</th>
              <th class="px-3 py-2">Expires</th>
              <th class="px-3 py-2 text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for d in devices %}
              <tr>
                <td class="px-3 py-2 align-top">
                  <div class="max-w-xs truncate" title="{{ d.user_agent }}">
                    {{ d.user_agent|default:"Unknown device" }}
                  </div>
                </td>
                <td class="px-3 py-2 align-top">
                  {{ d.ip_address|default:"-" }}
                </td>
                <td class="px-3 py-2 align-top whitespace-nowrap">
                  {{ d.created_at|date:"Y-m-d H:i" }}
                </td>
                <td class="px-3 py-2 align-top whitespace-nowrap">
                  {{ d.last_used_at|date:"Y-m-d H:i" }}
                </td>
                <td class="px-3 py-2 align-top whitespace-nowrap">
                  {{ d.expires_at|date:"Y-m-d H:i" }}
                </td>
                <td class="px-3 py-2 text-right align-top">
                  <form method="post" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_device">
                    <input type="hidden" name="device_id" value="{{ d.id }}">
                    <button type="submit"
                            class="text-xs text-red-600 hover:text-red-800">
                      Remove
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-xs text-slate-500">
        There are no trusted devices registered for your account yet.
      </p>
    {% endif %}
  </div>
</div>
{% endblock %}