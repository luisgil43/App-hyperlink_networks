{% extends "dashboard/base.html" %}
{% load humanize %}
{% block title %}My Production{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto bg-white p-4 sm:p-6 rounded-2xl shadow mt-6">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
    <h1 class="text-2xl font-bold">üë∑‚Äç‚ôÇÔ∏è Salary/My Production</h1>

    <div class="text-sm text-gray-600">
      Current week: <b>{{ current_week }}</b> ¬∑
      Total production payable (current week): <b>${{ total_semana_actual|floatformat:2 }}</b>
    </div>
  </div>

  <!-- Week picker -->
  <form id="week-form" method="get"
        class="mb-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
    <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto">
      <label for="week_display" class="text-sm text-gray-700">Select week:</label>
      <input id="week_display" type="text" class="border rounded px-3 py-1 w-40" placeholder="Pick a week" autocomplete="off">
      <input id="week" name="week" type="hidden" value="{{ week_filter|default:'all' }}">
      <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded">Apply</button>
      <a href="?week=all" class="text-blue-600 underline">Show all</a>
    </div>

    <div class="w-full sm:w-auto">
      <a href="{% url 'operaciones:user_weekly_payments' %}"
         class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow
                w-full sm:w-auto text-center whitespace-nowrap">
        <span class="sm:hidden">üíµ My payment</span>
        <span class="hidden sm:inline">üíµ Approve my payment</span>
      </a>
    </div>
  </form>

  <div class="rounded-xl border border-gray-200 overflow-x-auto">
    <table class="table-auto text-sm w-full min-w-[1400px]">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 border w-10"></th>
          <th class="p-2 border text-left">Project ID</th>
          <th class="p-2 border text-left">Real pay week</th>
          <th class="p-2 border text-left">Status</th>
          <th class="p-2 border text-left">Client</th>
          <th class="p-2 border text-left">City</th>
          <th class="p-2 border text-left">Project</th>
          <th class="p-2 border text-left">Office</th>
          <th class="p-2 border text-right">Salary/Technical Billing</th>
        </tr>
      </thead>
      <tbody>
        {% if cantidad == 'todos' %}
          {% for r in pagina.object_list %}
            <tr class="border-t align-top">
              <td class="p-2 border text-center">
                <button type="button" class="btn-toggle inline-flex w-7 h-7 items-center justify-center rounded hover:bg-gray-100" data-target="det-{{ forloop.counter }}">
                  <svg class="chev w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.293 7.293a1 1 0 011.414 0L10 9.586l2.293-2.293a1 1 0 111.414 1.414L10 12.414 6.293 8.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                </button>
              </td>

              <!-- Project ID: si es ajuste -> '-' -->
              <td class="p-2 border">
                {% if r.adjustment_type %}
                  -
                {% else %}
                  {{ r.project_id|default:"-" }}
                {% endif %}
              </td>

              <td class="p-2 border">{{ r.real_week }}</td>

              <td class="p-2 border">
                {% if r.is_discount %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-amber-100 text-amber-800">Direct discount</span>
                {% elif r.adjustment_type == "fixed_salary" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-800">Fixed salary</span>
                {% elif r.adjustment_type == "bonus" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-800">Bonus</span>
                {% elif r.adjustment_type == "advance" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-purple-100 text-purple-800">Advance</span>
                {% elif r.status == "aprobado_pm" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-green-100 text-green-800">Approved by PM</span>
                {% elif r.status == "aprobado_supervisor" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-green-100 text-green-800">Approved by Supervisor</span>
                {% elif r.status == "aprobado_finanzas" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-800">Approved by Finance</span>
                {% elif r.status == "rechazado_pm" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-red-100 text-red-800">Rejected by PM</span>
                {% elif r.status == "rechazado_supervisor" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-red-100 text-red-800">Rejected by Supervisor</span>
                {% elif r.status == "en_revision_supervisor" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">In Supervisor Review</span>
                {% elif r.status == "finalizado" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-amber-100 text-amber-800">Finished (pending review)</span>
                {% elif r.status == "en_proceso" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-800">In Progress</span>
                {% else %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-gray-800">Assigned</span>
                {% endif %}
              </td>

              <td class="p-2 border">{{ r.client|default:"-" }}</td>
              <td class="p-2 border">{{ r.city|default:"-" }}</td>
              <td class="p-2 border">{{ r.project|default:"-" }}</td>
              <td class="p-2 border">{{ r.office|default:"-" }}</td>

              <td class="p-2 border text-right">
                {% if r.total_tecnico < 0 %}
                  <span class="text-red-600">-${{ r.total_tecnico|floatformat:2|cut:"-" }}</span>
                {% else %}
                  ${{ r.total_tecnico|floatformat:2 }}
                {% endif %}
              </td>
            </tr>

            <!-- Detalle -->
            <tr id="det-{{ forloop.counter }}" class="hidden">
              <td class="border"></td>
              <td class="p-3 border bg-gray-50" colspan="9">
                <div class="overflow-x-auto rounded border">
                  <table class="min-w-[900px] w-full text-xs">
                    <thead class="bg-gray-100">
                      <tr>
                        <th class="p-2 text-left">Job Code</th>
                        <th class="p-2 text-left">Work Type</th>
                        <th class="p-2 text-left">Description</th>
                        <th class="p-2 text-left">UOM</th>
                        <th class="p-2 text-right">Quantity</th>
                        <th class="p-2 text-right">Technical Rate</th>
                        <th class="p-2 text-right">Subtotal Technical</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in r.detalle %}
                        <tr class="border-t">
                          <td class="p-2">{{ d.codigo }}</td>
                          <td class="p-2">{{ d.tipo }}</td>
                          <td class="p-2">{{ d.desc }}</td>
                          <td class="p-2">{{ d.uom }}</td>
                          <td class="p-2 text-right">{{ d.qty|floatformat:2 }}</td>
                          <td class="p-2 text-right">{{ d.rate_tec|floatformat:2 }}</td>
                          <td class="p-2 text-right">
                            {% if d.subtotal_tec < 0 %}
                              <span class="text-red-600">-${{ d.subtotal_tec|floatformat:2|cut:"-" }}</span>
                            {% else %}
                              {{ d.subtotal_tec|floatformat:2 }}
                            {% endif %}
                          </td>
                        </tr>
                      {% empty %}
                        <tr><td colspan="7" class="p-2 text-center text-gray-500">No items.</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="10" class="p-4 text-center text-gray-500">No production to show.</td></tr>
          {% endfor %}
        {% else %}
          {% for r in pagina %}
            <tr class="border-t align-top">
              <td class="p-2 border text-center">
                <button type="button" class="btn-toggle inline-flex w-7 h-7 items-center justify-center rounded hover:bg-gray-100" data-target="det-{{ forloop.counter }}">
                  <svg class="chev w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.293 7.293a1 1 0 011.414 0L10 9.586l2.293-2.293a1 1 0 111.414 1.414L10 12.414 6.293 8.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                </button>
              </td>

              <!-- Project ID: si es ajuste -> '-' -->
              <td class="p-2 border">
                {% if r.adjustment_type %}-{% else %}{{ r.project_id|default:"-" }}{% endif %}
              </td>

              <td class="p-2 border">{{ r.real_week }}</td>

              <td class="p-2 border">
                {% if r.is_discount %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-amber-100 text-amber-800">Direct discount</span>
                {% elif r.adjustment_type == "fixed_salary" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-800">Fixed salary</span>
                {% elif r.adjustment_type == "bonus" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-800">Bonus</span>
                {% elif r.adjustment_type == "advance" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-purple-100 text-purple-800">Advance</span>
                {% elif r.status == "aprobado_pm" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-green-100 text-green-800">Approved by PM</span>
                {% elif r.status == "aprobado_supervisor" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-green-100 text-green-800">Approved by Supervisor</span>
                {% elif r.status == "aprobado_finanzas" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-emerald-100 text-emerald-800">Approved by Finance</span>
                {% elif r.status == "rechazado_pm" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-red-100 text-red-800">Rejected by PM</span>
                {% elif r.status == "rechazado_supervisor" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-red-100 text-red-800">Rejected by Supervisor</span>
                {% elif r.status == "en_revision_supervisor" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">In Supervisor Review</span>
                {% elif r.status == "finalizado" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-amber-100 text-amber-800">Finished (pending review)</span>
                {% elif r.status == "en_proceso" %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-800">In Progress</span>
                {% else %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-gray-800">Assigned</span>
                {% endif %}
              </td>

              <td class="p-2 border">{{ r.client|default:"-" }}</td>
              <td class="p-2 border">{{ r.city|default:"-" }}</td>
              <td class="p-2 border">{{ r.project|default:"-" }}</td>
              <td class="p-2 border">{{ r.office|default:"-" }}</td>

              <td class="p-2 border text-right">
                {% if r.total_tecnico < 0 %}
                  <span class="text-red-600">-${{ r.total_tecnico|floatformat:2|cut:"-" }}</span>
                {% else %}
                  ${{ r.total_tecnico|floatformat:2 }}
                {% endif %}
              </td>
            </tr>

            <tr id="det-{{ forloop.counter }}" class="hidden">
              <td class="border"></td>
              <td class="p-3 border bg-gray-50" colspan="9">
                <div class="overflow-x-auto rounded border">
                  <table class="min-w-[900px] w-full text-xs">
                    <thead class="bg-gray-100">
                      <tr>
                        <th class="p-2 text-left">Job Code</th>
                        <th class="p-2 text-left">Work Type</th>
                        <th class="p-2 text-left">Description</th>
                        <th class="p-2 text-left">UOM</th>
                        <th class="p-2 text-right">Quantity</th>
                        <th class="p-2 text-right">Technical Rate</th>
                        <th class="p-2 text-right">Subtotal Technical</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in r.detalle %}
                        <tr class="border-t">
                          <td class="p-2">{{ d.codigo }}</td>
                          <td class="p-2">{{ d.tipo }}</td>
                          <td class="p-2">{{ d.desc }}</td>
                          <td class="p-2">{{ d.uom }}</td>
                          <td class="p-2 text-right">{{ d.qty|floatformat:2 }}</td>
                          <td class="p-2 text-right">{{ d.rate_tec|floatformat:2 }}</td>
                          <td class="p-2 text-right">
                            {% if d.subtotal_tec < 0 %}
                              <span class="text-red-600">-${{ d.subtotal_tec|floatformat:2|cut:"-" }}</span>
                            {% else %}
                              {{ d.subtotal_tec|floatformat:2 }}
                            {% endif %}
                          </td>
                        </tr>
                      {% empty %}
                        <tr><td colspan="7" class="p-2 text-center text-gray-500">No items.</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="10" class="p-4 text-center text-gray-500">No production to show.</td></tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>

  {% if cantidad != 'todos' and pagina.paginator.num_pages > 1 %}
    <div class="mt-4 flex flex-wrap justify-between items-center text-sm">
      <form method="get" class="flex items-center gap-2">
        <label for="cantidad" class="text-sm font-medium text-gray-700">Show:</label>
        <select name="cantidad" id="cantidad" class="border rounded-lg px-3 py-1"
                onchange="location.search='?{{ filters_qs }}&cantidad='+this.value">
          <option value="5"    {% if cantidad == '5' %}selected{% endif %}>5</option>
          <option value="10"   {% if cantidad == '10' %}selected{% endif %}>10</option>
          <option value="20"   {% if cantidad == '20' %}selected{% endif %}>20</option>
          <option value="todos" {% if cantidad == 'todos' %}selected{% endif %}>All</option>
        </select>
      </form>
    </div>

    <div class="mt-2 flex justify-center text-sm">
      <span>Page {{ pagina.number }} of {{ pagina.paginator.num_pages }}</span>
    </div>

    <div class="mt-2 flex justify-center gap-2 text-sm">
      {% if pagina.has_previous %}
        <a href="?{{ filters_qs }}&page=1" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ First</a>
        <a href="?{{ filters_qs }}&page={{ pagina.previous_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Previous</a>
      {% endif %}
      {% if pagina.has_next %}
        <a href="?{{ filters_qs }}&page={{ pagina.next_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next ‚Ä∫</a>
        <a href="?{{ filters_qs }}&page={{ pagina.paginator.num_pages }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Last ¬ª</a>
      {% endif %}
    </div>
  {% else %}
    <div class="mt-4 flex flex-wrap justify-between items-center text-sm">
      <form method="get" class="flex items-center gap-2">
        <label for="cantidad" class="text-sm font-medium text-gray-700">Show:</label>
        <select name="cantidad" id="cantidad" class="border rounded-lg px-3 py-1"
                onchange="location.search='?{{ filters_qs }}&cantidad='+this.value">
          <option value="5"    {% if cantidad == '5' %}selected{% endif %}>5</option>
          <option value="10"   {% if cantidad == '10' %}selected{% endif %}>10</option>
          <option value="20"   {% if cantidad == '20' %}selected{% endif %}>20</option>
          <option value="todos" {% if cantidad == 'todos' %}selected{% endif %}>All</option>
        </select>
      </form>
    </div>
  {% endif %}
</div>

<!-- Toggle filas -->
<script>
document.addEventListener('click', function(e){
  const b = e.target.closest('.btn-toggle');
  if(!b) return;
  const id = b.getAttribute('data-target');
  const row = document.getElementById(id);
  const chev = b.querySelector('.chev');
  if(row.classList.contains('hidden')){ row.classList.remove('hidden'); chev.style.transform='rotate(90deg)'; }
  else{ row.classList.add('hidden'); chev.style.transform='rotate(0deg)'; }
});
</script>

<!-- Flatpickr (week picker) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/weekSelect/weekSelect.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/weekSelect/weekSelect.js"></script>

<script>
function isoWeekString(d){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart)/86400000) + 1)/7);
  const year = date.getUTCFullYear();
  const ww = String(weekNo).padStart(2, '0');
  return `${year}-W${ww}`;
}

(function(){
  const hiddenInput  = document.getElementById('week');
  const displayInput = document.getElementById('week_display');

  function dateFromIsoWeek(iso){
    const [y, w] = iso.replace('W','').split('-');
    const year = parseInt(y,10), week = parseInt(w,10);
    const simple = new Date(Date.UTC(year,0,1 + (week - 1) * 7));
    const dow = simple.getUTCDay();
    const ISOweekStart = new Date(simple);
    if (dow <= 4) ISOweekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
    else          ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
    return new Date(ISOweekStart);
  }

  const initial = (hiddenInput.value && hiddenInput.value.toLowerCase() !== 'all') ? hiddenInput.value : '{{ current_week }}';
  const initialDate = dateFromIsoWeek(initial);

  flatpickr(displayInput, {
    plugins: [new weekSelect({})],
    dateFormat: "F j, Y",
    defaultDate: initialDate,
    allowInput: false,
    onChange(selectedDates){
      if (selectedDates && selectedDates[0]){
        hiddenInput.value = isoWeekString(selectedDates[0]);
      }
    },
    onReady(){
      if (!hiddenInput.value || hiddenInput.value.toLowerCase() === 'all'){
        hiddenInput.value = '{{ current_week }}';
      }
    }
  });
})();
</script>
{% endblock %}
