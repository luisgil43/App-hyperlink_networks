{% extends "dashboard_admin/base.html" %}
{% load widget_tweaks %}
{% load static %}

{% block title %}Import Technician Prices{% endblock %}

{% block dashboard_content %}
<div class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">ðŸ“¥ Import Technician Prices</h1>

  {% if form.errors %}
    <div class="mb-4 p-4 bg-red-100 text-red-800 rounded">
      <strong>There was a problem with your submission:</strong>
      <ul>
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="import-form">
    {% csrf_token %}

    <!-- Project selection (requerido) -->
    <div class="mb-4">
      <label for="proyecto_id" class="block font-medium text-sm text-gray-700 mb-1">Project</label>
      <select name="proyecto_id" id="proyecto_id" class="w-full border rounded-lg px-3 py-2" required>
        <option value="">-- Select Project --</option>
        {% if proyectos %}
          {% for p in proyectos %}
            <option value="{{ p.id }}" {% if proyecto_sel and p.id == proyecto_sel.id %}selected{% endif %}>
              {{ p.nombre }}{% if p.codigo %} [{{ p.codigo }}]{% endif %}
            </option>
          {% endfor %}
        {% endif %}
      </select>
      <p class="text-xs text-gray-500 mt-1">All imported prices will be linked to this Project.</p>
    </div>

    <!-- File input -->
    <div class="mb-4">
      <label class="block font-medium text-sm text-gray-700 mb-1">Excel File</label>
      <div class="flex items-center gap-3">
        <label for="archivo" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded cursor-pointer shadow">
          Choose File
        </label>
        <span id="file-name" class="text-gray-500 text-sm" aria-live="polite">No file selected</span>
      </div>
      <input id="archivo" type="file" name="archivo" accept=".xlsx" class="hidden" required onchange="updateFileName(this)">
      <p class="text-xs text-gray-500 mt-1">Format: .xlsx</p>
    </div>

    <!-- Technician selection (carga dinÃ¡mica por proyecto) -->
    <div class="mb-4">
      <label class="block font-medium text-sm text-gray-700 mb-1">Technicians</label>

      <!-- aquÃ­ metemos el HTML que devuelve el endpoint -->
      <div id="tecnicos-container"
           class="grid grid-cols-2 gap-2 rounded-lg border border-slate-200 p-3">
        <p class="text-sm text-gray-500 col-span-2">Select a project to load techniciansâ€¦</p>
      </div>

      <p class="text-xs text-gray-500 mt-1">Select one or more technicians to assign these prices to.</p>
    </div>

    <!-- Buttons -->
    <div class="flex items-center justify-between mt-6">
      <a href="{% url 'operaciones:listar_precios_tecnico' %}"
         class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded shadow">
        Back
      </a>

      <div class="flex items-center gap-3">
        <a href="{% static 'Technician_Prices_Template.xlsx' %}" download
           class="text-blue-600 text-sm hover:underline flex items-center gap-1">
          <i class="lucide lucide-download w-4 h-4"></i> ðŸ“¥ Download Template
        </a>

        <button type="button" onclick="validateAndSubmit()"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded shadow">
          Import Prices
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Pretty Message Modal -->
<div id="message-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/40">
  <div class="mx-4 max-w-md w-full rounded-2xl border shadow-xl bg-red-50 border-red-200 text-red-800">
    <div class="p-5">
      <div class="flex items-start gap-3">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-white/70">
          <!-- icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10.29 3.86L1.82 18a1 1 0 00.86 1.5h18.64a1 1 0 00.86-1.5L13.71 3.86a1 1 0 00-1.72 0zM12 9v4m0 4h.01"/>
          </svg>
        </span>
        <div class="flex-1">
          <p id="message-text" class="text-base font-semibold leading-6"></p>
          <div class="mt-4 flex justify-end">
            <button type="button" class="px-4 py-2 rounded-xl bg-white/80 hover:bg-white text-gray-800 font-medium"
                    onclick="hideMessage()">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function updateFileName(input) {
    const name = input.files && input.files.length ? input.files[0].name : "No file selected";
    document.getElementById("file-name").textContent = name;
  }

  function showError(text) {
    document.getElementById('message-text').textContent = text;
    document.getElementById('message-modal').classList.remove('hidden');
  }
  function hideMessage() {
    document.getElementById('message-modal').classList.add('hidden');
  }

  // Carga dinÃ¡mica de tÃ©cnicos por proyecto
  async function loadTecnicos(projectId) {
    const box = document.getElementById('tecnicos-container');
    if (!box) return;

    if (!projectId) {
      box.innerHTML = '<p class="text-sm text-gray-500 col-span-2">Select a project to load techniciansâ€¦</p>';
      return;
    }

    box.innerHTML = '<p class="text-sm text-gray-500 col-span-2">Loading techniciansâ€¦</p>';

    try {
      const resp = await fetch(
        "{% url 'operaciones:api_tecnicos_por_proyecto' %}?proyecto_id=" + encodeURIComponent(projectId),
        { headers: { 'X-Requested-With': 'XMLHttpRequest' } }
      );

      if (!resp.ok) {
        throw new Error('HTTP ' + resp.status);
      }

      const data = await resp.json();
      const tecnicos = data.tecnicos || [];

      if (!tecnicos.length) {
        box.innerHTML = '<p class="text-sm text-gray-500 col-span-2">This project has no technicians assigned.</p>';
        return;
      }

      // Construimos el checklist de tÃ©cnicos
      box.innerHTML = tecnicos.map(t => `
        <label class="flex items-center gap-2 text-sm">
          <input
            type="checkbox"
            name="tecnicos"
            value="${t.id}"
            class="rounded border-slate-300"
          >
          <span>${t.name}</span>
        </label>
      `).join("");
    } catch (err) {
      console.error(err);
      box.innerHTML = '<p class="text-sm text-red-600 col-span-2">Could not load technicians.</p>';
    }
  }

  // Carga inicial + listener de cambio del proyecto
  document.addEventListener('DOMContentLoaded', function () {
    const sel = document.getElementById('proyecto_id');
    if (!sel) return;

    // Si viene preseleccionado (?proyecto_id=...) cargamos tÃ©cnicos de una vez
    if (sel.value) {
      loadTecnicos(sel.value);
    }

    sel.addEventListener('change', function (e) {
      loadTecnicos(e.target.value);
    });
  });

  function validateAndSubmit() {
    const form = document.getElementById('import-form');
    const fileInput = document.getElementById('archivo');
    const projectSel = document.getElementById('proyecto_id');

    if (!projectSel || !projectSel.value) {
      showError("Please select a Project.");
      return;
    }
    if (!fileInput || !fileInput.files || !fileInput.files.length) {
      showError("Please select an Excel file to import.");
      return;
    }
    const checked = document.querySelectorAll('input[name="tecnicos"]:checked');
    if (!checked.length) {
      showError("Please select at least one technician.");
      return;
    }
    form.submit();
  }
</script>
{% endblock %}