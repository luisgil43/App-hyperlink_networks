{# templates/operaciones/billing_upload_evidencias.html #}
{% extends "dashboard/base.html" %}
{% block title %}Upload Photos{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">

  <div class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      {# Back: intenta volver con history; si no hay referrer, va al listado #}
      <button type="button"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded"
              onclick="if (document.referrer) { history.back(); } else { window.location.href='/operaciones/billing/my/'; }">
        â¬…ï¸ Back
      </button>

      <h1 class="text-2xl font-bold">ğŸ“¸ Upload Photos â€” Billing #{{ a.sesion.id }}</h1>
    </div>

    {% if can_finish %}
      <a href="{% url 'operaciones:finish_assignment' a.pk %}"
         class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">
        Finish
      </a>
    {% else %}
      <button type="button"
              class="bg-indigo-300 text-white px-4 py-2 rounded cursor-not-allowed"
              title="You must upload all required photos to finish">
        Finish
      </button>
    {% endif %}
  </div>

  {% if faltantes %}
    <div class="mt-3 p-3 rounded bg-yellow-50 text-yellow-800 text-sm">
      Required photos pending:
      <ul class="list-disc ml-5">
        {% for r in faltantes %}
          <li>{{ r.orden }}. {{ r.titulo }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="grid md:grid-cols-2 gap-6 mt-4">
    <div>
      <h2 class="font-semibold mb-2">Requirements</h2>
      <ul class="space-y-2">
        {% for r in requisitos %}
          <li class="border rounded p-3">
            <div class="flex items-center justify-between">
              <div class="font-medium">
                {{ r.orden }}. {{ r.titulo }} {% if r.obligatorio %}<span class="text-red-600">*</span>{% endif %}
                <span class="ml-2 text-xs px-2 py-0.5 rounded
                             {% if r.uploaded > 0 %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                  {% if r.uploaded > 0 %}Done{% else %}Pending{% endif %}
                </span>
              </div>
              <div class="text-xs text-gray-500">
                {{ r.uploaded }} uploaded
              </div>
            </div>

            <div class="text-sm text-gray-600">{{ r.descripcion }}</div>

            <form method="post" enctype="multipart/form-data" class="mt-2 geo-upload-form">
              {% csrf_token %}
              <input type="hidden" name="req_id" value="{{ r.id }}">

              <!-- HIDDEN META (se llena por JS) -->
              <input type="hidden" name="lat">
              <input type="hidden" name="lng">
              <input type="hidden" name="acc">
              <input type="hidden" name="client_taken_at">

              <div class="flex items-center gap-2">
                <!-- GALERÃA (visible) -> sin capture -->
                <input id="file-gallery-{{ r.id }}" type="file" name="imagenes[]" accept="image/*" multiple class="sr-only file-input">
                <label for="file-gallery-{{ r.id }}" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm cursor-pointer">ğŸ“ Choose files</label>
                <span class="text-xs text-gray-600 filename" data-empty="No files selected">No files selected</span>

                <!-- CÃMARA (oculta) -> capture -->
                <input id="file-camera-{{ r.id }}" type="file" name="imagenes[]" accept="image/*" capture="environment" class="sr-only file-input-camera">

                <!-- BotÃ³n cÃ¡mara -->
                <button type="button" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm trigger-camera" data-target="file-camera-{{ r.id }}">ğŸ“· Take</button>
              </div>

              <div class="flex items-center justify-between mt-2 text-xs text-gray-600">
                <span class="gps-status">ğŸ“ Awaiting locationâ€¦</span>
                <span class="time-status">ğŸ•’ â€”</span>
              </div>

              <div class="flex items-center gap-2 mt-2">
                <input type="text" name="nota" placeholder="Note (optional)" class="w-full border rounded p-2">
                <button type="button" class="grant-location px-3 py-2 rounded bg-blue-50 text-blue-700 hover:bg-blue-100 text-sm">Grant Location</button>
              </div>

              <button class="mt-2 bg-blue-600 text-white px-3 py-1 rounded">Upload</button>
            </form>
          </li>
        {% endfor %}
      </ul>

      <div class="mt-6">
        <h3 class="font-semibold mb-2">Extra Photos</h3>
        <form method="post" enctype="multipart/form-data" class="geo-upload-form">
          {% csrf_token %}

          <!-- HIDDEN META -->
          <input type="hidden" name="lat">
          <input type="hidden" name="lng">
          <input type="hidden" name="acc">
          <input type="hidden" name="client_taken_at">

          <div class="flex items-center gap-2">
            <!-- GALERÃA (visible) -->
            <input id="file-gallery-extra" type="file" name="imagenes[]" accept="image/*" multiple class="sr-only file-input">
            <label for="file-gallery-extra" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm cursor-pointer">ğŸ“ Choose files</label>
            <span class="text-xs text-gray-600 filename" data-empty="No files selected">No files selected</span>

            <!-- CÃMARA (oculta) -->
            <input id="file-camera-extra" type="file" name="imagenes[]" accept="image/*" capture="environment" class="sr-only file-input-camera">

            <!-- BotÃ³n Take -->
            <button type="button" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm trigger-camera" data-target="file-camera-extra">ğŸ“· Take</button>
          </div>

          <div class="flex items-center justify-between mt-2 text-xs text-gray-600">
            <span class="gps-status">ğŸ“ Awaiting locationâ€¦</span>
            <span class="time-status">ğŸ•’ â€”</span>
          </div>

          <div class="flex items-center gap-2 mt-2">
            <input type="text" name="nota" placeholder="Note (optional)" class="w-full border rounded p-2">
            <button type="button" class="grant-location px-3 py-2 rounded bg-blue-50 text-blue-700 hover:bg-blue-100 text-sm">Grant Location</button>
          </div>

          <button class="mt-2 bg-gray-800 text-white px-3 py-1 rounded">Upload</button>
        </form>
      </div>
    </div>

    {# -------- Columna derecha: Fotos subidas (con eliminar) -------- #}
    <div>
      <h2 class="font-semibold mb-2">Uploaded</h2>
      <div class="grid grid-cols-2 gap-3 max-h-[600px] overflow-auto">
        {% for ev in evidencias %}
          <figure class="border rounded p-2 relative">
            {# X para eliminar (usa modal personalizado) #}
            {% if can_delete %}
              <button type="button"
                      class="absolute right-2 top-2 z-10 w-7 h-7 leading-none rounded-full bg-red-600 text-white text-sm hover:bg-red-700 btn-open-delete"
                      data-delete-url="{% url 'operaciones:eliminar_evidencia' a.pk ev.id %}"
                      data-label="{{ ev.requisito.titulo|default:'Extra' }}"
                      data-img="{{ ev.imagen.url }}"
                      title="Delete photo">âœ•</button>
            {% endif %}

            <img src="{{ ev.imagen.url }}" class="w-full h-32 object-cover rounded" loading="lazy" alt="photo">
            <figcaption class="text-xs mt-1 space-y-0.5">
              <div class="font-medium">{{ ev.requisito.titulo|default:"Extra" }}</div>
              <div>ğŸ•’ {% if ev.client_taken_at %}{{ ev.client_taken_at|date:"Y-m-d H:i" }}{% else %}{{ ev.tomada_en|date:"Y-m-d H:i" }}{% endif %}</div>
              {% if ev.lat and ev.lng %}
                <div>ğŸ“ {{ ev.lat }}, {{ ev.lng }}{% if ev.gps_accuracy_m %} (Â±{{ ev.gps_accuracy_m }}m){% endif %}</div>
                <a class="text-blue-600 hover:underline" target="_blank" rel="noopener" href="https://maps.google.com/?q={{ ev.lat }},{{ ev.lng }}">Open in Maps</a>
              {% else %}
                <div class="text-gray-400">ğŸ“ No GPS</div>
              {% endif %}
              <div class="text-gray-600">{{ ev.nota }}</div>
            </figcaption>
          </figure>
        {% empty %}
          <div class="text-gray-500">No photos yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{# --- Modal de consentimiento de ubicaciÃ³n --- #}
<div id="geo-consent" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/40" data-close-modal></div>
  <div class="relative max-w-md mx-auto bg-white rounded-2xl shadow p-6 mt-40">
    <h3 class="text-lg font-semibold">Allow location with photos?</h3>
    <p class="mt-2 text-sm text-gray-600">
      We attach your location (GPS) to each photo for supervision and quality control. This helps validate work at the correct site.
    </p>
    <div class="mt-4 flex justify-end gap-2">
      <button type="button" class="btn-consent-deny px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Not now</button>
      <button type="button" class="btn-consent-allow px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Allow</button>
    </div>
  </div>
</div>

{# --- Modal bonito para eliminar foto --- #}
<div id="modal-delete" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/40" data-close-modal></div>

  <div class="relative max-w-md mx-auto bg-white rounded-2xl shadow p-6 mt-40">
    <div class="flex items-start gap-3">
      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
        <svg class="w-5 h-5 text-red-600" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8.257 3.099c.366-.446.92-.699 1.506-.699s1.14.253 1.506.7l6.347 7.736c.777.947.09 2.364-1.134 2.364H3.044c-1.223 0-1.91-1.417-1.133-2.364L8.257 3.1zM10 7.5a.75.75 0 00-.75.75v3.5a.75.75 0 001.5 0v-3.5A.75.75 0 0010 7.5zm0 7a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
        </svg>
      </div>
      <div class="flex-1">
        <h3 class="text-lg font-semibold">Delete photo?</h3>
        <p class="mt-1 text-sm text-gray-600">
          This action cannot be undone. The selected photo will be permanently removed.
        </p>
      </div>
    </div>

    <div class="mt-4 flex items-center gap-3">
      <img id="delete-thumb" src="" alt="photo preview" class="w-20 h-20 object-cover rounded border">
      <div class="text-sm">
        <div class="text-gray-600">Label</div>
        <div id="delete-label" class="font-medium">â€”</div>
      </div>
    </div>

    <form id="delete-form" method="post" action="#" class="mt-5 flex justify-end gap-2">
      {% csrf_token %}
      <button type="button" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200" data-close-modal>Cancel</button>
      <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Delete</button>
    </form>
  </div>
</div>

<script>
(function(){
  const GEO_OPTS = { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 };
  const CONSENT_KEY = "photo_loc_consent"; // "granted" | "denied" | null
  const getConsent = () => { try { return localStorage.getItem(CONSENT_KEY); } catch(e){ return null; } };
  const setConsent = (v) => { try { localStorage.setItem(CONSENT_KEY, v); } catch(e){} };

  // Modal
  const modal = document.getElementById('geo-consent');
  const btnAllow = modal.querySelector('.btn-consent-allow');
  const btnDeny  = modal.querySelector('.btn-consent-deny');
  const openModal  = () => modal.classList.remove('hidden');
  const closeModal = () => modal.classList.add('hidden');

  // Captura geo+h timestamp y pinta estado
  async function captureGeo(form){
    const latEl   = form.querySelector('input[name="lat"]');
    const lngEl   = form.querySelector('input[name="lng"]');
    const accEl   = form.querySelector('input[name="acc"]');
    const takenEl = form.querySelector('input[name="client_taken_at"]');
    const gpsStatus  = form.querySelector('.gps-status');
    const timeStatus = form.querySelector('.time-status');

    function setTimeNow(){
      const now = new Date();
      if (takenEl) takenEl.value = now.toISOString();
      if (timeStatus) timeStatus.textContent = "ğŸ•’ " + now.toLocaleString();
    }
    function setGps(text){ if (gpsStatus) gpsStatus.textContent = text; }

    if (!('geolocation' in navigator)){
      setTimeNow(); setGps("ğŸ“ Geolocation not supported");
      throw new Error("Geolocation not supported");
    }

    setGps("ğŸ“ Getting locationâ€¦");
    return new Promise((resolve, reject)=>{
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const { latitude, longitude, accuracy } = pos.coords || {};
          if (latEl) latEl.value = (latitude ?? "").toFixed ? latitude.toFixed(6) : "";
          if (lngEl) lngEl.value = (longitude ?? "").toFixed ? longitude.toFixed(6) : "";
          if (accEl) accEl.value = (accuracy ?? 0).toFixed ? accuracy.toFixed(2) : "";
          setTimeNow();
          if (latEl.value && lngEl.value){
            setGps(`ğŸ“ ${latEl.value}, ${lngEl.value}${accEl.value ? " (Â±"+accEl.value+"m)" : ""}`);
            resolve(true);
          } else {
            setGps("ğŸ“ Location unavailable");
            reject(new Error("Location unavailable"));
          }
        },
        (err)=>{
          setTimeNow();
          setGps("ğŸ“ Location denied/unavailable");
          reject(err || new Error("Location denied"));
        },
        GEO_OPTS
      );
    });
  }

  // Refresca texto de consentimiento por formulario
  function notifyFormsConsentChange(){
    document.querySelectorAll('.geo-upload-form').forEach(form=>{
      const gpsStatus = form.querySelector('.gps-status');
      if (!gpsStatus) return;
      const granted = getConsent() === 'granted';
      gpsStatus.textContent = granted
        ? (gpsStatus.textContent.includes("ğŸ“") ? gpsStatus.textContent : "ğŸ“ Ready to capture")
        : "ğŸ“ Location not granted (tap Grant or Allow)";
    });
  }

  // Inicial: si no hay decisiÃ³n, muestra modal
  document.addEventListener('DOMContentLoaded', ()=>{
    if (!getConsent()) openModal();
    notifyFormsConsentChange();
  });

  // Al pulsar Allow en nuestro modal: guardamos y DISPARAMOS una captura en el form activo
  btnAllow.addEventListener('click', async ()=>{
    setConsent('granted'); closeModal(); notifyFormsConsentChange();
    // intenta capturar en el primer form visible (gesto acaba de ocurrir)
    const form = document.querySelector('.geo-upload-form');
    if (form) try { await captureGeo(form); } catch(_) {}
  });

  btnDeny.addEventListener('click', ()=>{
    setConsent('denied');
    // No cerramos: el submit quedarÃ¡ bloqueado igualmente.
  });

  // Por cada formulario
  document.querySelectorAll('.geo-upload-form').forEach(form=>{
    const fileInputGallery = form.querySelector('.file-input');         // visible (galerÃ­a)
    const fileInputCam     = form.querySelector('.file-input-camera');  // oculto (cÃ¡mara)
    const filenameEl       = form.querySelector('.filename');

    // Texto inicial en inglÃ©s
    if (filenameEl) filenameEl.textContent = filenameEl.getAttribute('data-empty') || 'No files selected';

    // BotÃ³n ğŸ“· Take -> abre input de cÃ¡mara
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.trigger-camera');
      if(!btn) return;
      if(btn.closest('form') !== form) return;
      const id = btn.getAttribute('data-target');
      const inputCam = document.getElementById(id);
      if(inputCam) inputCam.click();
    });

    // Al seleccionar en GALERÃA â†’ muestra nombres y CAPTURA GEO (siempre intentamos: esto lanza el prompt del sistema)
    if (fileInputGallery){
      fileInputGallery.addEventListener('change', async ()=>{
        const n = fileInputGallery.files ? fileInputGallery.files.length : 0;
        if (filenameEl){
          filenameEl.textContent = n===0 ? (filenameEl.dataset.empty || 'No files selected')
                                : n===1 ? fileInputGallery.files[0].name
                                        : `${n} files selected`;
        }
        try { await captureGeo(form); } catch(_) {}
      });
    }

    // Al tomar con CÃMARA â†’ intenta capturar geo
    if (fileInputCam){
      fileInputCam.addEventListener('change', async ()=>{
        try { await captureGeo(form); } catch(_) {}
      });
    }

    // BotÃ³n "Grant Location" -> fuerza captura
    const btnGrant = form.querySelector('.grant-location');
    if (btnGrant){
      btnGrant.addEventListener('click', async ()=>{
        if (getConsent() !== 'granted') { openModal(); return; }
        try { await captureGeo(form); } catch(_) {}
      });
    }

    // EnvÃ­o: BLOQUEA si falta geo/hora; intenta una vez mÃ¡s
    form.addEventListener('submit', async (e)=>{
      const latEl   = form.querySelector('input[name="lat"]');
      const lngEl   = form.querySelector('input[name="lng"]');
      const takenEl = form.querySelector('input[name="client_taken_at"]');

      const ok = latEl && latEl.value && lngEl && lngEl.value && takenEl && takenEl.value;
      if (!ok){
        e.preventDefault();
        try {
          await captureGeo(form);
        } catch(_) { /* ignore */ }
        const ok2 = latEl && latEl.value && lngEl && lngEl.value && takenEl && takenEl.value;
        if (!ok2){
          // Mensaje discreto en el status; evita alert bloqueante
          const gpsStatus = form.querySelector('.gps-status');
          if (gpsStatus) gpsStatus.textContent = "ğŸ“ We couldn't get your location. Check HTTPS, GPS and permissions, then try again.";
          return; // no envÃ­a
        }
        form.submit(); // ahora sÃ­
      }
    });
  });

  // ---------- Modal eliminar foto ----------
  const delModal   = document.getElementById('modal-delete');
  const delForm    = document.getElementById('delete-form');
  const delThumb   = document.getElementById('delete-thumb');
  const delLabelEl = document.getElementById('delete-label');
  function openDelete(){ delModal.classList.remove('hidden'); }
  function closeDelete(){ delModal.classList.add('hidden'); }
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-open-delete');
    if(!btn) return;
    delForm.action = btn.getAttribute('data-delete-url');
    delThumb.src   = btn.getAttribute('data-img') || '';
    delLabelEl.textContent = btn.getAttribute('data-label') || 'â€”';
    openDelete();
  });
  document.addEventListener('click', (e)=>{ if (e.target.hasAttribute('data-close-modal')) closeDelete(); });
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeDelete(); });
})();
</script>
{% endblock %}
