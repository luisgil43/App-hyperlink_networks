{# templates/operaciones/billing_configurar_requisitos.html #}
{% extends "dashboard_admin/base.html" %}
{% load humanize %}

{% block title %}Configure Photo Requirements{% endblock %}

{% block dashboard_content %}
<div class="max-w-6xl mx-auto bg-white p-4 sm:p-6 rounded-2xl shadow mt-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      üìã Photo Requirements ‚Äî Billing #{{ sesion.id }}
    </h1>

    <div class="flex items-center gap-2">
      <a href="{{ request.META.HTTP_REFERER|default:'#' }}" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700">
        ‚Üê Back
      </a>
    </div>
  </div>

  <form method="post" class="space-y-6" id="req-form">
    {% csrf_token %}

    {% for a in asignaciones %}
      <div class="border rounded-2xl p-4 sm:p-5">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
          <div class="font-semibold text-lg">
            {{ a.tecnico.get_full_name|default:a.tecnico.username }}
          </div>
          <div class="flex items-center gap-2">
            <button type="button"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-full text-sm"
                    onclick="addReq({{ a.tecnico_id }})">
              + Add Requirement
            </button>
          </div>
        </div>

        <div id="list-{{ a.tecnico_id }}" class="space-y-3">
          {# Requisitos existentes #}
          {% for r in a.requisitos.all %}
            <div class="grid grid-cols-1 sm:grid-cols-12 gap-2 items-start req-row" data-existing="1" data-id="{{ r.id }}">
              <!-- ID oculto para actualizar -->
              <input type="hidden" name="t{{ a.tecnico_id }}_id[]" value="{{ r.id }}">

              <input name="t{{ a.tecnico_id }}_titulo[]" class="sm:col-span-3 border rounded-xl p-2"
                     placeholder="Title" value="{{ r.titulo }}" required>

              <input name="t{{ a.tecnico_id }}_desc[]" class="sm:col-span-6 border rounded-xl p-2"
                     placeholder="Description (optional)" value="{{ r.descripcion|default:'' }}">

              <input name="t{{ a.tecnico_id }}_ord[]" class="sm:col-span-1 border rounded-xl p-2"
                     type="number" value="{{ r.orden|default:forloop.counter0 }}" min="0">

              <label class="sm:col-span-1 flex items-center gap-2 bg-gray-50 border rounded-xl px-3 py-2">
                <input type="checkbox" class="obl-toggle" data-hidden-name="t{{ a.tecnico_id }}_obl[]"
                       {% if r.obligatorio %}checked{% endif %}>
                <span class="text-sm">Required</span>
                <!-- valor sincronizado por JS -->
                <input type="hidden" name="t{{ a.tecnico_id }}_obl[]" value="{% if r.obligatorio %}1{% else %}0{% endif %}">
              </label>

              <div class="sm:col-span-1 flex sm:justify-end">
                <button type="button"
                        class="remove-btn px-3 py-2 rounded-xl border text-red-700 border-red-200 hover:bg-red-50"
                        onclick="removeReq(this, {{ a.tecnico_id }}, {{ r.id }})">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          {% empty %}
            <div class="text-gray-500 text-sm">No requirements yet. Add your first one.</div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    <!-- Contenedor de IDs a eliminar -->
    <div id="delete-bag"></div>

    <!-- Barra de acciones (pegajosa en mobile) -->
    <div class="sticky bottom-2 sm:static">
      <div class="bg-white/90 backdrop-blur border rounded-2xl p-3 sm:p-0 sm:border-0 sm:bg-transparent sm:backdrop-blur-0 flex justify-end gap-3">
        <button class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-xl">
          Save
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  // Agregar fila
  function addReq(tid) {
    const list = document.getElementById('list-' + tid);
    const idx = list.querySelectorAll('.req-row').length;

    const wrap = document.createElement('div');
    wrap.className = "grid grid-cols-1 sm:grid-cols-12 gap-2 items-start req-row";
    wrap.dataset.existing = "0";

    // fila nueva (sin ID)
    wrap.innerHTML = `
      <input type="hidden" name="t${tid}_id[]" value="">
      <input name="t${tid}_titulo[]" class="sm:col-span-3 border rounded-xl p-2" placeholder="Title" required>
      <input name="t${tid}_desc[]" class="sm:col-span-6 border rounded-xl p-2" placeholder="Description (optional)">
      <input name="t${tid}_ord[]" class="sm:col-span-1 border rounded-xl p-2" type="number" value="${idx}" min="0">
      <label class="sm:col-span-1 flex items-center gap-2 bg-gray-50 border rounded-xl px-3 py-2">
        <input type="checkbox" class="obl-toggle" data-hidden-name="t${tid}_obl[]" checked>
        <span class="text-sm">Required</span>
        <input type="hidden" name="t${tid}_obl[]" value="1">
      </label>
      <div class="sm:col-span-1 flex sm:justify-end">
        <button type="button"
                class="remove-btn px-3 py-2 rounded-xl border text-red-700 border-red-200 hover:bg-red-50"
                onclick="removeReq(this, ${tid}, null)">
          üóëÔ∏è
        </button>
      </div>
    `;

    list.appendChild(wrap);
  }

  // Eliminar fila (si es existente, marcar para borrar; si es nueva, solo quitar del DOM)
  function removeReq(btn, tid, reqId) {
    const row = btn.closest('.req-row');
    if (reqId) {
      // crear hidden para backend
      const bag = document.getElementById('delete-bag');
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = `t${tid}_delete_id[]`;
      hidden.value = String(reqId);
      bag.appendChild(hidden);
    }
    row.remove();
    reindexOrders(tid);
  }

  // Reindexar campo "orden" despu√©s de quitar/agregar
  function reindexOrders(tid) {
    const list = document.getElementById('list-' + tid);
    const ords = list ? list.querySelectorAll('input[name="t' + tid + '_ord[]"]') : [];
    ords.forEach((inp, i) => { inp.value = i; });
  }

  // Sincroniza checkbox "Required" con el hidden (0/1)
  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('obl-toggle')) {
      const hiddenName = e.target.dataset.hiddenName;
      // el hidden est√° como hermano dentro del mismo label
      const label = e.target.closest('label');
      const hidden = label.querySelector('input[type="hidden"][name="' + hiddenName + '"]');
      if (hidden) hidden.value = e.target.checked ? "1" : "0";
    }
  });
</script>
{% endblock %}
