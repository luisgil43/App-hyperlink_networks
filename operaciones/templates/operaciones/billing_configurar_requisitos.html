{% extends "dashboard_admin/base.html" %}
{% load humanize %}

{% block title %}Configure Photo Requirements{% endblock %}

{% block dashboard_content %}
<div class="max-w-6xl mx-auto bg-white p-4 sm:p-6 rounded-2xl shadow mt-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      📋 Photo Requirements — Billing #{{ sesion.id }}
    </h1>

    <div class="flex items-center gap-2">
      <!-- Open import screen -->
      <a href="{% url 'operaciones:import_requirements_page' sesion.id %}"
         class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow focus:outline-none focus:ring-2 focus:ring-blue-400">
        Import Requirements (CSV/XLSX)
      </a>

 <!-- NEW: Upload Plan / List Plans -->
      <a href="{% url 'operaciones:list_plans' sesion.id %}"
         class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full text-sm shadow focus:outline-none focus:ring-2 focus:ring-indigo-400">
        Upload Plan
      </a>
 
    </div>
  </div>

  <form method="post" class="space-y-6" id="req-form" autocomplete="off">
    {% csrf_token %}

    <!-- NEW: Special project toggle -->
    <div class="border rounded-2xl p-4 sm:p-5">
      <label class="inline-flex items-start gap-3">
        <input type="checkbox"
               name="proyecto_especial"
               value="1"
               {% if sesion.proyecto_especial %}checked{% endif %}
               class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded">
        <span>
          <span class="font-semibold">Special project</span>
          <span class="block text-sm text-gray-600 mt-0.5">
            If enabled, “Extra” photos will require Title and Address, and the report will use those fields.
          </span>
        </span>
      </label>
    </div>

    <div class="border rounded-2xl p-4 sm:p-5">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold text-lg">Project shared requirements</div>
        <button type="button"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-full text-sm"
                onclick="addReq()">
          + Add Requirement
        </button>
      </div>

      <div id="req-list" class="space-y-3">{% for r in requirements %}
  <div class="grid grid-cols-1 sm:grid-cols-12 gap-2 items-start req-row" data-existing="1" data-id="{{ r.id }}">
    <input type="hidden" name="id[]" value="{{ r.id }}">

    <!-- Nombre del requisito -->
    <input name="name[]" class="sm:col-span-6 border rounded-xl p-2"
           placeholder="Name" value="{{ r.titulo }}" required autocomplete="off">

    <!-- Orden -->
    <input name="order[]" class="sm:col-span-2 border rounded-xl p-2"
           type="number" value="{{ r.orden|default:forloop.counter0 }}" min="0" inputmode="numeric" autocomplete="off">

    <!-- Obligatorio -->
    <label class="sm:col-span-3 flex items-center gap-2 bg-gray-50 border rounded-xl px-3 py-2">
      <input type="checkbox" class="obl-toggle" {% if r.obligatorio %}checked{% endif %}>
      <span class="text-sm">Required</span>
      <input type="hidden" name="mandatory[]" value="{% if r.obligatorio %}1{% else %}0{% endif %}">
    </label>

    <div class="sm:col-span-1 flex sm:justify-end">
      <button type="button"
              class="remove-btn px-3 py-2 rounded-xl border text-red-700 border-red-200 hover:bg-red-50"
              onclick="removeReq(this, {{ r.id }})">
        🗑️
      </button>
    </div>
  </div>
{% empty %}
  <div class="text-gray-500 text-sm">No requirements yet. Add your first one.</div>
{% endfor %}

      </div>
    </div>

    <!-- Delete-bag for existing rows -->
    <div id="delete-bag"></div>

    <!-- Actions -->
    <div class="sticky bottom-2 sm:static">
      <div class="bg-white/90 backdrop-blur border rounded-2xl p-3 sm:p-0 sm:border-0 sm:bg-transparent sm:backdrop-blur-0 flex justify-end gap-3">
<a href="{% url 'operaciones:listar_billing' %}"
   class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700">
  ← Back
</a>
        <button class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-xl">
          Save
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  // --- Util: próximo valor de orden (máximo + 1) ---
  function nextOrderValue() {
    const vals = Array.from(document.querySelectorAll('input[name="order[]"]'))
      .map(el => parseInt(el.value, 10))
      .filter(Number.isFinite);
    return vals.length ? Math.max(...vals) + 1 : 0;
  }

  // --- Reindexa todos los "order[]" (0..N-1) ---
  function reindexOrders() {
    const ords = document.querySelectorAll('input[name="order[]"]');
    ords.forEach((el, i) => { el.value = i; });
  }

  // --- Sincroniza checkbox visible con hidden mandatory[] ---
  function syncMandatory(row) {
    const cb = row.querySelector('input.obl-toggle');
    const hidden = row.querySelector('input[name="mandatory[]"]');
    if (!cb || !hidden) return;
    hidden.value = cb.checked ? "1" : "0";
  }

  // --- Crea una fila desde cero (sin innerHTML) ---
  function createEmptyRow() {
    const row = document.createElement('div');
    row.className = 'grid grid-cols-1 sm:grid-cols-12 gap-2 items-start req-row';
    row.dataset.existing = '0';

    // oculto id[]
    const idHidden = document.createElement('input');
    idHidden.type = 'hidden';
    idHidden.name = 'id[]';
    idHidden.value = '';

    // name[]
    const nameInp = document.createElement('input');
    nameInp.name = 'name[]';
    nameInp.className = 'sm:col-span-6 border rounded-xl p-2';
    nameInp.placeholder = 'Nombre del requisito';
    nameInp.autocomplete = 'off';
    nameInp.required = true;
    nameInp.value = '';

    // order[]
    const orderInp = document.createElement('input');
    orderInp.name = 'order[]';
    orderInp.type = 'number';
    orderInp.min = '0';
    orderInp.inputMode = 'numeric';
    orderInp.autocomplete = 'off';
    orderInp.className = 'sm:col-span-2 border rounded-xl p-2';
    orderInp.value = String(nextOrderValue());

    // label contenedor del "Obligatorio"
    const lab = document.createElement('label');
    lab.className = 'sm:col-span-3 flex items-center gap-2 bg-gray-50 border rounded-xl px-3 py-2';

    // checkbox visible
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'obl-toggle';
    cb.checked = true;

    const spanTxt = document.createElement('span');
    spanTxt.className = 'text-sm';
    spanTxt.textContent = 'Required';

    // hidden mandatory[]
    const mandHidden = document.createElement('input');
    mandHidden.type = 'hidden';
    mandHidden.name = 'mandatory[]';
    mandHidden.value = '1';

    cb.addEventListener('change', () => { mandHidden.value = cb.checked ? '1' : '0'; });

    lab.appendChild(cb);
    lab.appendChild(spanTxt);
    lab.appendChild(mandHidden);

    // acciones (eliminar)
    const actions = document.createElement('div');
    actions.className = 'sm:col-span-1 flex sm:justify-end';

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'remove-btn px-3 py-2 rounded-xl border text-red-700 border-red-200 hover:bg-red-50';
    delBtn.textContent = '🗑️';
    delBtn.addEventListener('click', () => removeReq(delBtn, null));
    actions.appendChild(delBtn);

    // ensamblar
    row.appendChild(idHidden);
    row.appendChild(nameInp);
    row.appendChild(orderInp);
    row.appendChild(lab);
    row.appendChild(actions);

    return row;
  }

  // --- Agregar fila ---
  function addReq() {
    const list = document.getElementById('req-list');
    const last = list.querySelector('.req-row:last-of-type');

    let row;
    if (last) {
      // clonar estructura existente (por si cambiaste clases), pero limpiando valores
      row = last.cloneNode(true);
      row.dataset.existing = '0';

      const idInput   = row.querySelector('input[name="id[]"]');
      const nameInput = row.querySelector('input[name="name[]"]');
      const orderInp  = row.querySelector('input[name="order[]"]');
      const cbYN      = row.querySelector('input.obl-toggle');
      const hiddenMan = row.querySelector('input[name="mandatory[]"]');
      const delBtn    = row.querySelector('.remove-btn');

      if (idInput)   idInput.value = '';
      if (nameInput) { nameInput.value = ''; nameInput.placeholder = 'Nombre del requisito'; }
      if (orderInp)  orderInp.value = String(nextOrderValue());
      if (cbYN)      cbYN.checked = true;
      if (hiddenMan) hiddenMan.value = '1';
      if (delBtn) {
        // quitar listeners inline anteriores
        const newBtn = delBtn.cloneNode(true);
        newBtn.addEventListener('click', () => removeReq(newBtn, null));
        delBtn.replaceWith(newBtn);
      }
    } else {
      row = createEmptyRow();
    }

    list.appendChild(row);
  }

  // --- Eliminar fila ---
  function removeReq(btn, reqId) {
    const row = btn.closest('.req-row');
    if (reqId) {
      const bag = document.getElementById('delete-bag') || document.body.appendChild(Object.assign(document.createElement('div'), { id:'delete-bag' }));
      const h = document.createElement('input');
      h.type = 'hidden'; h.name = 'delete_id[]'; h.value = String(reqId);
      bag.appendChild(h);
    }
    row.remove();
    reindexOrders();
  }

  // --- Limpieza al cargar: si hay "${name}" residuales, limpiarlos ---
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[name="name[]"]').forEach(inp => {
      if (/\$\{\s*name\s*\}/i.test(inp.value)) inp.value = '';
      if (!inp.placeholder) inp.placeholder = 'Nombre del requisito';
    });

    // Asegurar que todos los checkboxes sincronicen con su hidden
    document.querySelectorAll('.req-row').forEach(row => {
      const cb = row.querySelector('input.obl-toggle');
      if (cb) {
        cb.addEventListener('change', () => syncMandatory(row));
        syncMandatory(row);
      }
    });
  });

  // Exponer funciones si las llamas desde atributos HTML
  window.addReq = addReq;
  window.removeReq = removeReq;
</script>


{% endblock %}
