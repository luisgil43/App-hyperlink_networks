{% extends "dashboard_admin/base.html" %}
{% load humanize %}

{% block title %}Configure Photo Requirements{% endblock %}

{% block dashboard_content %}
<div class="max-w-6xl mx-auto bg-white p-4 sm:p-6 rounded-2xl shadow mt-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      üìã Photo Requirements ‚Äî Billing #{{ sesion.id }}
    </h1>

<div class="flex items-center gap-2">
  <!-- Open import screen -->
  <a href="{% url 'operaciones:import_requirements_page' sesion.id %}"
     class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow focus:outline-none focus:ring-2 focus:ring-blue-400">
    Import Requirements (CSV/XLSX)
  </a>
</div>

  </div>

  <form method="post" class="space-y-6" id="req-form" autocomplete="off">
    {% csrf_token %}

    <div class="border rounded-2xl p-4 sm:p-5">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold text-lg">Project shared requirements</div>
        <button type="button"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-full text-sm"
                onclick="addReq()">
          + Add Requirement
        </button>
      </div>

      <div id="req-list" class="space-y-3">{% for r in requirements %}
  <div class="grid grid-cols-1 sm:grid-cols-12 gap-2 items-start req-row" data-existing="1" data-id="{{ r.id }}">
    <input type="hidden" name="id[]" value="{{ r.id }}">

    <!-- Nombre del requisito -->
    <input name="name[]" class="sm:col-span-6 border rounded-xl p-2"
           placeholder="Name" value="{{ r.titulo }}" required autocomplete="off">

    <!-- Orden -->
    <input name="order[]" class="sm:col-span-2 border rounded-xl p-2"
           type="number" value="{{ r.orden|default:forloop.counter0 }}" min="0" inputmode="numeric" autocomplete="off">

    <!-- Obligatorio -->
    <label class="sm:col-span-3 flex items-center gap-2 bg-gray-50 border rounded-xl px-3 py-2">
      <input type="checkbox" class="obl-toggle" {% if r.obligatorio %}checked{% endif %}>
      <span class="text-sm">Required</span>
      <input type="hidden" name="mandatory[]" value="{% if r.obligatorio %}1{% else %}0{% endif %}">
    </label>

    <div class="sm:col-span-1 flex sm:justify-end">
      <button type="button"
              class="remove-btn px-3 py-2 rounded-xl border text-red-700 border-red-200 hover:bg-red-50"
              onclick="removeReq(this, {{ r.id }})">
        üóëÔ∏è
      </button>
    </div>
  </div>
{% empty %}
  <div class="text-gray-500 text-sm">No requirements yet. Add your first one.</div>
{% endfor %}

      </div>
    </div>

    <!-- Delete-bag for existing rows -->
    <div id="delete-bag"></div>

    <!-- Actions -->
    <div class="sticky bottom-2 sm:static">
      <div class="bg-white/90 backdrop-blur border rounded-2xl p-3 sm:p-0 sm:border-0 sm:bg-transparent sm:backdrop-blur-0 flex justify-end gap-3">
<a href="{% url 'operaciones:listar_billing' %}"
   class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700">
  ‚Üê Back
</a>
        <button class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-xl">
          Save
        </button>
      </div>
    </div>
  </form>
</div>

<script>
  // Initialize checkbox state on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.req-row').forEach(row => {
      const hidden = row.querySelector('input[type="hidden"][name="mandatory[]"]');
      const cb = row.querySelector('.obl-toggle');
      if (hidden && cb) cb.checked = (hidden.value === "1");
    });
  });

  function addReq() {
    const list = document.getElementById('req-list');
    const idx = list.querySelectorAll('.req-row').length;

    const wrap = document.createElement('div');
    wrap.className = "grid grid-cols-1 sm:grid-cols-12 gap-2 items-start req-row";
    wrap.dataset.existing = "0";

    wrap.innerHTML = `
      <input type="hidden" name="id[]" value="">
      <input name="name[]" class="sm:col-span-6 border rounded-xl p-2" placeholder="Name" required autocomplete="off">
      <input name="order[]" class="sm:col-span-2 border rounded-xl p-2" type="number" value="${idx}" min="0" inputmode="numeric" autocomplete="off">
      <label class="sm:col-span-3 flex items-center gap-2 bg-gray-50 border rounded-xl px-3 py-2">
        <input type="checkbox" class="obl-toggle" checked>
        <span class="text-sm">Required</span>
        <input type="hidden" name="mandatory[]" value="1">
      </label>
      <div class="sm:col-span-1 flex sm:justify-end">
        <button type="button"
                class="remove-btn px-3 py-2 rounded-xl border text-red-700 border-red-200 hover:bg-red-50"
                onclick="removeReq(this, null)">
          üóëÔ∏è
        </button>
      </div>
    `;

    list.appendChild(wrap);
  }

  function removeReq(btn, reqId) {
    const row = btn.closest('.req-row');
    if (reqId) {
      const bag = document.getElementById('delete-bag');
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'delete_id[]';
      hidden.value = String(reqId);
      bag.appendChild(hidden);
    }
    row.remove();
    reindexOrders();
  }

  function reindexOrders() {
    const ords = document.querySelectorAll('input[name="order[]"]');
    ords.forEach((inp, i) => { inp.value = i; });
  }

  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('obl-toggle')) {
      const row = e.target.closest('.req-row');
      const hidden = row.querySelector('input[type="hidden"][name="mandatory[]"]');
      if (hidden) hidden.value = e.target.checked ? "1" : "0";
    }
  });
</script>
{% endblock %}
