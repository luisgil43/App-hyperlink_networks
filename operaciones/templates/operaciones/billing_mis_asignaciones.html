{# templates/operaciones/billing_mis_asignaciones.html #}
{% extends "dashboard/base.html" %}
{% load humanize %}
{% block title %}My Assignments{% endblock %}

{% block content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">
  <h1 class="text-2xl font-bold mb-4">üßæ My Assignments</h1>

<div class="flex justify-start mb-2">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-gray-700 px-3 py-1 border rounded-full bg-gray-50 hover:bg-gray-100 select-none">
      ‚öôÔ∏è Columns
    </summary>

    <!-- IMPORTANTE: mismo id que usa el script -->
    <div id="columnToggles" class="absolute left-0 mt-1 w-56 bg-white border rounded-xl shadow-lg p-3 z-10">
      <p class="text-xs text-gray-500 mb-2">Show / hide columns</p>

      <!-- Master checkbox -->
      <label class="flex items-center gap-2 mb-2 pb-2 border-b">
        <input type="checkbox" id="col-toggle-all" checked>
        <span class="font-semibold text-xs">Show all columns</span>
      </label>

      <!-- Una l√≠nea por columna (0-based, coincide con el <thead>) -->
      <div class="space-y-1 text-sm">
        <!-- 0 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="0" checked>
          <span>Date</span>
        </label>

        <!-- 1 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="1" checked>
          <span>Project ID</span>
        </label>

        <!-- 2 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="2" checked>
          <span>Project address</span>
        </label>

        <!-- 3 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="3" checked>
          <span>Client</span>
        </label>

        <!-- 4 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="4" checked>
          <span>City</span>
        </label>

        <!-- 5 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="5" checked>
          <span>Project</span>
        </label>

        <!-- 6 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="6" checked>
          <span>Office</span>
        </label>

        <!-- 7 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="7" checked>
          <span>My Billing</span>
        </label>

        <!-- 8 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="8" checked>
          <span>Status</span>
        </label>

        <!-- 9 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="9" checked>
          <span>Photo Report</span>
        </label>

        <!-- 10 -->
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="10" checked>
          <span>Actions</span>
        </label>
      </div>
    </div>
  </details>
</div>

  <div class="overflow-x-auto">
    <table class="table-auto w-full text-sm min-w-full sm:min-w-[1200px]" style="white-space: nowrap;">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 text-left">Date</th>
          <th class="p-2 text-left">Project ID</th>
          <th class="p-2 text-left">Project address</th>
          <th class="p-2 text-left">Client</th>
          <th class="p-2 text-left">City</th>
          <th class="p-2 text-left">Project</th>
          <th class="p-2 text-left">Office</th>
          <th class="p-2 text-right">My Billing</th>
          <th class="p-2 text-left">Status</th>
          <th class="p-2 text-center">Photo Report</th>
          <th class="p-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for a in asignaciones %}
        <tr class="border-b align-top">
          <td class="p-2">{{ a.sesion.creado_en|date:"Y-m-d" }}</td>
          <td class="p-2">{{ a.sesion.proyecto_id }}</td>

          {# --- Project address (mismo comportamiento que listar_billing) --- #}
          <td class="p-2 align-top max-w-[360px] break-words" style="white-space: normal;">
            {% if a.sesion.direccion_proyecto %}
              {% if a.sesion.maps_href == a.sesion.direccion_proyecto %}
                <a href="{{ a.sesion.maps_href }}" class="text-blue-600 hover:underline" target="_blank" rel="noopener">üìç Address</a>
              {% else %}
                <div class="whitespace-normal break-words">{{ a.sesion.direccion_proyecto }}</div>
                <a href="{{ a.sesion.maps_href }}" target="_blank" rel="noopener" class="text-xs text-blue-600 hover:underline">[open map]</a>
              {% endif %}
            {% else %}‚Äî{% endif %}
          </td>

          <td class="p-2">{{ a.sesion.cliente }}</td>
          <td class="p-2">{{ a.sesion.ciudad }}</td>
          <td class="p-2">{{ a.proyecto_label }}</td>
          <td class="p-2">{{ a.sesion.oficina }}</td>
          <td class="p-2 text-right">${{ a.my_total|floatformat:2 }}</td>

          {# -------- STATUS (badges estilo rendiciones) -------- #}
          <td class="p-2 text-sm">
            <div class="flex flex-col gap-1 text-left leading-tight">
              {% if a.estado == 'asignado' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚è≥ Pending acceptance
                </span>
              {% elif a.estado == 'en_proceso' %}
                <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">
                  üöÄ In progress
                </span>
                <span class="text-xs text-gray-600">
                  Accepted by: {{ a.tecnico.get_full_name|default:a.tecnico.username }}
                  {% if a.aceptado_en %} ¬∑ {{ a.aceptado_en|date:"Y-m-d H:i" }}{% endif %}
                </span>
              {% elif a.estado == 'en_revision_supervisor' %}
                <span class="inline-block bg-amber-100 text-amber-800 px-2 py-1 rounded-full font-medium">
                  üì§ Submitted ‚Äî supervisor review
                </span>
              {% elif a.estado == 'rechazado_supervisor' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Rejected by supervisor
                </span>
                {% if a.supervisor_comentario %}
                  <div class="mt-0.5 text-xs text-red-700 whitespace-pre-wrap break-words">
                    <strong>Reason:</strong> {{ a.supervisor_comentario }}
                  </div>
                {% endif %}
              {% elif a.estado == 'aprobado_supervisor' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Approved by supervisor (pending PM)
                </span>
              {% elif a.estado == 'aprobado_pm' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                  üèÅ Approved by PM
                </span>
              {% elif a.estado == 'rechazado_pm' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Rejected by PM
                </span>
                {% if a.pm_comentario %}
                  <div class="mt-0.5 text-xs text-red-700 whitespace-pre-wrap break-words">
                    <strong>Reason:</strong> {{ a.pm_comentario }}
                  </div>
                {% endif %}
              {% else %}
                <span class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded-full font-medium">
                  ‚Äî
                </span>
              {% endif %}

              {% if a.reintento_habilitado %}
                <span class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded bg-indigo-100 text-indigo-800 w-max">
                  ‚ôªÔ∏è Reupload enabled
                </span>
              {% endif %}
            </div>
          </td>

          {# -------- PHOTO REPORT (nivel proyecto) -------- #}
          <td class="p-2 text-center">
            {% if a.sesion.reporte_fotografico %}
              <a class="inline-flex items-center gap-1 bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-full"
                 href="{{ a.sesion.reporte_fotografico.url }}" target="_blank" rel="noopener">
                ‚¨áÔ∏è Download
              </a>
            {% else %}
              <span class="text-gray-400">‚Äî</span>
            {% endif %}
          </td>

          {# -------- ACTIONS -------- #}
          <td class="p-2 text-center space-x-2">
            <a href="{% url 'operaciones:detalle_assignment' a.pk %}" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">View</a>

            {% if a.estado == "asignado" %}
              <button type="button"
                      class="px-3 py-1 rounded bg-green-600 text-white hover:bg-green-700 btn-accept-start"
                      data-action="{% url 'operaciones:start_assignment' a.pk %}">
                ‚úÖ Accept & Start
              </button>

            {% elif a.estado == "en_proceso" %}
              <a href="{% url 'operaciones:upload_evidencias' a.pk %}"
                 class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">
                Upload photos
              </a>
              <a href="{% url 'operaciones:finish_assignment' a.pk %}"
                 class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700">
                Finish
              </a>

            {% elif a.estado == "rechazado_supervisor" and a.reintento_habilitado %}
              <button type="button"
                      class="px-3 py-1 rounded bg-green-600 text-white hover:bg-green-700 btn-accept-start"
                      data-action="{% url 'operaciones:start_assignment' a.pk %}">
                Start
              </button>
              <a href="{% url 'operaciones:upload_evidencias' a.pk %}"
                 class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">
                Reupload photos
              </a>
              <a href="{% url 'operaciones:finish_assignment' a.pk %}"
                 class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700">
                Finish
              </a>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td class="p-4 text-center text-gray-500" colspan="12">No assignments yet.</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# ===== Modal Aceptar & Empezar (POST) ===== #}
<div id="modal-accept" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/40" data-close-modal></div>
  <div class="relative max-w-md mx-auto mt-40 bg-white rounded-2xl shadow p-6">
    <h3 class="text-lg font-semibold">Accept assignment?</h3>
    <p class="mt-1 text-sm text-gray-600">
      This will mark the task as <b>In progress</b> and store your acceptance timestamp.
    </p>
    <form id="form-accept" method="post" action="#" class="mt-4 flex justify-end gap-2">
      {% csrf_token %}
      <button type="button" class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200" data-close-modal>Cancel</button>
      <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Accept & Start</button>
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('modal-accept');
  const form  = document.getElementById('form-accept');

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-accept-start');
    if(!btn) return;
    form.action = btn.getAttribute('data-action'); // URL de start_assignment
    modal.classList.remove('hidden');
  });

  document.addEventListener('click', (e)=>{
    if (e.target.hasAttribute('data-close-modal')) {
      modal.classList.add('hidden');
    }
  });

  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') modal.classList.add('hidden');
  });
})();
</script>
<script>
/* Mantener el scroll horizontal en "My Assignments" */
(function () {
  const KEY = 'myassignScrollX:' + location.pathname;

  // El contenedor con overflow-x del listado
  function getScrollBox() {
    // es el .overflow-x-auto que envuelve la tabla dentro del wrapper principal
    return document.querySelector('.max-w-7xl .overflow-x-auto') || document.querySelector('.overflow-x-auto');
  }

  function saveX(x) {
    try { sessionStorage.setItem(KEY, String(x)); } catch (_) {}
  }
  function readX() {
    try { return Number(sessionStorage.getItem(KEY) || 0); } catch (_) { return 0; }
  }

  function restore() {
    const box = getScrollBox();
    if (!box) return;
    const x = readX();
    // aplicar despu√©s del layout
    requestAnimationFrame(() => { box.scrollLeft = x; });

    // ir guardando mientras el usuario se desplaza
    let t = null;
    box.addEventListener('scroll', () => {
      if (t) return;
      t = setTimeout(() => { t = null; saveX(box.scrollLeft); }, 120);
    }, { passive: true });
  }

  function saveBeforeLeave() {
    const box = getScrollBox();
    if (box) saveX(box.scrollLeft);
  }

  // Restaurar al cargar y guardar al salir/recargar
  document.addEventListener('DOMContentLoaded', restore);
  window.addEventListener('beforeunload', saveBeforeLeave);
})();
</script>
<script>
(function () {
  // Panel de columnas
  const panel = document.getElementById('columnToggles');
  if (!panel) return;

  // Tabla asociada: usa la que tenga data-columns-table
  const table =
    document.querySelector('[data-columns-table]') ||
    document.querySelector('table');
  if (!table) return;

  // Clave para recordar las columnas por vista/tabla
  const tableId = table.dataset.columnsTable || location.pathname;
  const STORAGE_KEY = 'cols:' + tableId;

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj === 'object' ? obj : {};
    } catch (e) {
      return {};
    }
  }

  function saveState(state) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  function applyVisibility() {
    const state = loadState(); // {0: true, 1: false, ...}

    // Encabezados
    const theadCells = table.querySelectorAll('thead tr th');
    theadCells.forEach((th, idx) => {
      const visible = state[idx] !== false; // por defecto visible
      th.style.display = visible ? '' : 'none';
    });

    // Celdas
    table.querySelectorAll('tbody tr').forEach((tr) => {
      const tds = tr.querySelectorAll('td');
      tds.forEach((td, idx) => {
        const visible = state[idx] !== false;
        td.style.display = visible ? '' : 'none';
      });
    });

    // Sincronizar checkboxes + master
    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');
    let allOn = true;

    checks.forEach((cb) => {
      const idx = parseInt(cb.dataset.col || '0', 10);
      const visible = state[idx] !== false;
      cb.checked = visible;
      if (!visible) allOn = false;
    });

    if (master) {
      master.checked = allOn;
    }
  }

  function bindToggles() {
    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    // Individuales
    checks.forEach((cb) => {
      cb.addEventListener('change', () => {
        const idx = parseInt(cb.dataset.col || '0', 10);
        const state = loadState();
        state[idx] = cb.checked;
        saveState(state);
        applyVisibility();
      });
    });

    // Master "Show all columns"
    if (master) {
      master.addEventListener('change', () => {
        const val = master.checked;
        const state = loadState();

        checks.forEach((cb) => {
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });

        saveState(state);
        applyVisibility();
      });
    }
  }

  // Cerrar el <details> al hacer clic fuera
  function bindOutsideClickToClose() {
    const details = panel.closest('details');
    if (!details) return;

    document.addEventListener('click', (e) => {
      if (!details.open) return;
      if (details.contains(e.target)) return;
      details.open = false;
    });
  }

  // Inicializar
  bindToggles();
  applyVisibility();
  bindOutsideClickToClose();
})();
</script>
{% endblock %}
