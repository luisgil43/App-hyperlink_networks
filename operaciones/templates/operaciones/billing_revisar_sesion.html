{% extends "dashboard_admin/base.html" %}
{% load humanize %}
{% block title %}Supervisor Review ‚Äî Project{% endblock %}

{% block dashboard_content %}
<div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">

  <!-- Encabezado Proyecto -->
  <div class="mb-4">
    <h1 class="text-2xl font-bold">
      üîé Review ‚Äî Billing #{{ s.id }} / {{ s.proyecto_id }}
    </h1>
    <div class="mt-1 text-sm text-gray-600 flex flex-wrap gap-x-4 gap-y-1 items-center">
      <span>Cliente: <b>{{ s.cliente }}</b></span>
      <span>Ciudad: <b>{{ s.ciudad }}</b></span>
      <span>Proyecto: <b>{{ s.proyecto }}</b></span>
      <span>Oficina: <b>{{ s.oficina }}</b></span>

      <!-- üîπ Project Status (badge √∫nico por proyecto) -->
      <span class="ml-auto"></span>
      <span class="text-sm">
        <span class="mr-1 font-semibold text-gray-700">Status:</span>
        {% if s.estado == "aprobado_pm" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-green-100 text-green-800">Approved by PM</span>
        {% elif s.estado == "rechazado_pm" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-red-100 text-red-800">Rejected by PM</span>
        {% elif s.estado == "aprobado_supervisor" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-green-100 text-green-800">Approved by supervisor</span>
        {% elif s.estado == "rechazado_supervisor" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-red-100 text-red-800">Rejected by supervisor</span>
        {% elif s.estado == "en_revision_supervisor" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-yellow-100 text-yellow-800">In supervisor review</span>
        {% elif s.estado == "finalizado" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-amber-100 text-amber-800">Finished (pending review)</span>
        {% elif s.estado == "en_proceso" %}
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-blue-100 text-blue-800">In progress</span>
        {% else %}
          <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-gray-800">Assigned</span>
        {% endif %}
      </span>
    </div>
  </div>

  {# ---- BARRA DE ACCIONES: Back / Aprobar / Rechazar ---- #}
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
    <a href="{% url 'operaciones:listar_billing' %}"
       class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded shadow inline-flex items-center gap-1">
      ‚¨ÖÔ∏è Back
    </a>

    {% if can_review %}
      <div class="flex items-center gap-2">
        <!-- Aprobar y generar reporte (POST a esta misma vista) -->
        <form method="post" action="{% url 'operaciones:revisar_sesion' s.id %}">
          {% csrf_token %}
          <input type="hidden" name="accion" value="aprobar">
          <button type="submit"
                  class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
            ‚úÖ Approve & Generate Report
          </button>
        </form>

        <!-- Rechazar: abre modal -->
        <button type="button"
                onclick="openRejectModal()"
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow">
          ‚ùå Reject
        </button>
      </div>
    {% else %}
      <div class="text-sm text-gray-500">
        This project is not ready for supervisor review.
      </div>
    {% endif %}
  </div>

  {# Aviso / descarga del reporte si existe #}
  {% if project_report_exists %}
    <div class="mb-6 p-3 rounded bg-blue-50 text-blue-800 text-sm flex items-center justify-between">
      <div>üìÑ A photo report already exists for this project.</div>
      <a href="{{ project_report_url }}" target="_blank" rel="noopener"
         class="text-blue-700 underline hover:no-underline">Download current report</a>
    </div>
  {% endif %}

  <!-- Technicians (solo nombres y %; SIN estado por t√©cnico) -->
  <div class="mb-6">
    <h2 class="text-sm font-semibold text-gray-800 mb-2">Technicians</h2>
    <div class="flex flex-wrap gap-2">
      {% for asig, _evs in evidencias_por_asig %}
        <span class="inline-flex items-center gap-2 px-2 py-1 rounded bg-gray-50 border">
          <span class="text-sm">
            {{ asig.tecnico.get_full_name|default:asig.tecnico.username }}
            (<span class="text-gray-600">{{ asig.porcentaje|floatformat:0 }}%</span>)
          </span>
        </span>
      {% empty %}
        <span class="text-gray-500 text-sm">Sin t√©cnicos asignados.</span>
      {% endfor %}
    </div>
  </div>

  <!-- Bloques por t√©cnico con sus fotos -->
  {% for asig, evs in evidencias_por_asig %}
    <section class="mb-8">
      <div class="flex items-baseline justify-between">
        <h3 class="text-lg font-semibold">
          üë∑ {{ asig.tecnico.get_full_name|default:asig.tecnico.username }}
          <span class="ml-2 text-sm text-gray-500 font-normal">({{ asig.porcentaje|floatformat:0 }}%)</span>
        </h3>
        <div class="text-xs text-gray-500">
          Aceptado: {{ asig.aceptado_en|date:"Y-m-d H:i"|default:"‚Äî" }} ¬∑
          Finalizado: {{ asig.finalizado_en|date:"Y-m-d H:i"|default:"‚Äî" }} ¬∑
          Revisado: {{ asig.supervisor_revisado_en|date:"Y-m-d H:i"|default:"‚Äî" }}
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[60vh] overflow-auto mt-2">
        {% for ev in evs %}
          <figure class="border rounded p-2 relative">
            {# üîí Bot√≥n X solo si el proyecto NO est√° aprobado por supervisor/PM #}
            {% if s.estado != "aprobado_supervisor" and s.estado != "aprobado_pm" %}
              <button type="button"
                      class="btn-open-delete absolute right-2 top-2 z-10 w-7 h-7 rounded-full bg-red-600 text-white text-sm hover:bg-red-700"
                      title="Delete photo"
                      data-action="{% url 'operaciones:eliminar_evidencia' asig.pk ev.id %}"
                      data-next="{{ request.get_full_path }}">
                ‚úï
              </button>
            {% else %}
              {# Si est√° aprobado, muestra un candado/deshabilitado opcionalmente #}
              <span class="absolute right-2 top-2 z-10 w-7 h-7 rounded-full bg-gray-300 text-white text-sm grid place-items-center" title="Locked">
                üîí
              </span>
            {% endif %}

            <div class="relative rounded overflow-hidden">
              {% if ev.lat and ev.lng %}
                <div class="absolute top-2 left-2 z-10">
                  <a target="_blank"
                     href="https://www.google.com/maps?q={{ ev.lat }},{{ ev.lng }}"
                     class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-600/90 text-white text-[11px] shadow">
                    üìç {{ ev.lat|floatformat:5 }}, {{ ev.lng|floatformat:5 }}
                  </a>
                  {% if ev.gps_accuracy_m %}
                    <span class="ml-1 px-2 py-0.5 rounded-full bg-black/60 text-white text-[10px]">
                      ¬± {{ ev.gps_accuracy_m|floatformat:0 }} m
                    </span>
                  {% endif %}
                </div>
              {% endif %}

              <img src="{{ ev.imagen.url }}" class="w-full h-40 object-cover rounded" alt="photo">
            </div>

            <figcaption class="text-xs mt-1">
              <div class="font-medium">{{ ev.requisito.titulo|default:"Extra" }}</div>
              <div>üïí {{ ev.client_taken_at|default:ev.tomada_en|date:"Y-m-d H:i" }}</div>

              <div class="text-gray-600">
                {% if ev.lat and ev.lng %}
                  üìç {{ ev.lat|floatformat:5 }}, {{ ev.lng|floatformat:5 }}
                  <a class="ml-1 text-blue-600 hover:underline" target="_blank"
                     href="https://www.google.com/maps?q={{ ev.lat }},{{ ev.lng }}">Open map</a>
                  {% if ev.gps_accuracy_m %}
                    <span class="ml-1 text-gray-400">¬± {{ ev.gps_accuracy_m|floatformat:0 }} m</span>
                  {% endif %}
                {% else %}
                  <span class="text-gray-400">üìç No GPS</span>
                {% endif %}
              </div>

              {% if ev.nota %}
                <div class="text-gray-600">{{ ev.nota }}</div>
              {% endif %}
            </figcaption>
          </figure>
        {% empty %}
          <div class="text-gray-500 text-sm">Este t√©cnico a√∫n no tiene fotos.</div>
        {% endfor %}
      </div>
    </section>
  {% empty %}
    <div class="text-gray-500">No hay evidencias en esta sesi√≥n.</div>
  {% endfor %}

  <!-- Nota flujo -->
  <p class="mt-4 text-xs text-gray-500">
    Recuerda: el reporte fotogr√°fico es <b>√∫nico por proyecto</b> y se genera/actualiza cuando el supervisor aprueba.
    Luego pasa a aprobaci√≥n de PM.
  </p>
</div>

{# -------- Modal de Rechazo -------- #}
<div id="reject-modal" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative max-w-md mx-auto bg-white rounded-2xl shadow p-6 mt-40">
    <h3 class="text-lg font-semibold text-red-600">Reject Project</h3>
    <form method="post" action="{% url 'operaciones:revisar_sesion' s.id %}">
      {% csrf_token %}
      <input type="hidden" name="accion" value="rechazar">
      <label class="block mt-4 text-sm font-medium text-gray-700">Reason</label>
      <textarea name="comentario" rows="3" class="w-full border rounded p-2 mt-1"
                placeholder="Enter rejection reason..." required></textarea>

      <div class="mt-4 flex justify-end gap-2">
        <button type="button" onclick="closeRejectModal()"
                class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button type="submit"
                class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Reject</button>
      </div>
    </form>
  </div>
</div>

{# -------- Modal Eliminar Foto (bonito) -------- #}
<div id="modal-delete" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/40" data-close-modal></div>
  <div class="relative max-w-md mx-auto bg-white rounded-2xl shadow p-6 mt-40">
    <div class="flex items-start gap-3">
      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
        <svg class="w-5 h-5 text-red-600" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8.257 3.099c.366-.446.92-.699 1.506-.699s1.14.253 1.506.7l6.347 7.736c.777.947.09 2.364-1.134 2.364H3.044c-1.223 0-1.91-1.417-1.133-2.364L8.257 3.1zM10 7.5a.75.75 0 00-.75.75v3.5a.75.75 0 001.5 0v-3.5A.75.75 0 0010 7.5zm0 7a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
        </svg>
      </div>
      <div class="flex-1">
        <h3 class="text-lg font-semibold">Delete photo?</h3>
        <p class="mt-1 text-sm text-gray-600">This action cannot be undone.</p>
      </div>
    </div>

    <form id="delete-form" method="post" action="#" class="mt-5 flex justify-end gap-2">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <button type="button" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200" data-close-modal>Cancel</button>
      <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Delete</button>
    </form>
  </div>
</div>

<script>
  function openRejectModal(){ document.getElementById('reject-modal').classList.remove('hidden'); }
  function closeRejectModal(){ document.getElementById('reject-modal').classList.add('hidden'); }

  // Modal eliminar foto
  (function(){
    const modal = document.getElementById('modal-delete');
    const form  = document.getElementById('delete-form');

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-open-delete');
      if(!btn) return;
      form.action = btn.getAttribute('data-action');
      const next = btn.getAttribute('data-next') || '';
      const hidden = form.querySelector('input[name="next"]');
      if(hidden) hidden.value = next;
      modal.classList.remove('hidden');
    });

    document.addEventListener('click', (e)=>{
      if (e.target.hasAttribute('data-close-modal')) {
        modal.classList.add('hidden');
      }
    });

    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') modal.classList.add('hidden');
    });
  })();
</script>
{% endblock %}
