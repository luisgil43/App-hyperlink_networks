{# templates/operaciones/billing_detalle_asignacion.html #}
{% extends "dashboard/base.html" %}
{% load humanize %}
{% block title %}Assignment Detail{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-2">
  <h1 class="text-2xl font-bold leading-tight min-w-0">
    Assignment #{{ a.id }} ‚Äî {{ a.get_estado_display }}
  </h1>

  <div class="flex flex-wrap gap-2 w-full sm:w-auto">
    <button type="button"
            class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded w-full sm:w-auto whitespace-nowrap"
            onclick="window.history.back()">‚¨ÖÔ∏è Back</button>

    {% if a.estado == "asignado" or a.reintento_habilitado %}
      <button type="button"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full sm:w-auto whitespace-nowrap btn-accept-start"
              data-action="{% url 'operaciones:start_assignment' a.pk %}">
        Start
      </button>
    {% elif a.estado == "en_proceso" %}
      <a href="{% url 'operaciones:upload_evidencias' a.pk %}"
   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full sm:w-auto whitespace-nowrap text-center sm:text-left">
  Upload photos
</a>
      <a href="{% url 'operaciones:finish_assignment' a.pk %}"
   class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded w-full sm:w-auto whitespace-nowrap text-center sm:text-left">
  Finish
</a>
    {% endif %}
  </div>
</div>


  {# ---- Datos del proyecto (con ubicaci√≥n y semana proyectada) ---- #}
  <div class="grid sm:grid-cols-2 gap-4 text-sm mb-4">
    <div><strong>Project ID:</strong> {{ a.sesion.proyecto_id }}</div>
    <div><strong>Client:</strong> {{ a.sesion.cliente }}</div>
    <div><strong>City:</strong> {{ a.sesion.ciudad }}</div>
    <div><strong>Project:</strong> {{ a.sesion.proyecto }}</div>
    <div><strong>Office:</strong> {{ a.sesion.oficina }}</div>

    {# === Location con manejo de URL o direcci√≥n larga === #}
    <div class="sm:col-span-2 min-w-0">
      <strong>Location:</strong>
      {% with addr=a.sesion.direccion_proyecto|default_if_none:'' %}
      {% with href=a.sesion.maps_href|default_if_none:'' %}
      {% if addr %}
        {# Si addr parece un link (http/https), no mostramos la URL larga, solo el bot√≥n de mapa #}
        {% if 'http' in addr|lower %}
          <a href="{{ addr }}" target="_blank" rel="noopener"
             class="ml-2 inline-flex items-center gap-1 text-blue-600 hover:underline break-all">
            üìç Open map
          </a>
        {% else %}
          {# Direcci√≥n normal: que envuelva bien en m√≥vil #}
          <span class="ml-1 break-words whitespace-pre-line">{{ addr }}</span>
          {% if href %}
            <a href="{{ href }}" target="_blank" rel="noopener"
               class="ml-2 inline-flex items-center gap-1 text-blue-600 hover:underline">
              üìç Open map
            </a>
          {% endif %}
        {% endif %}
      {% elif href %}
        <a href="{{ href }}" target="_blank" rel="noopener"
           class="ml-2 inline-flex items-center gap-1 text-blue-600 hover:underline break-all">
          üìç Open map
        </a>
      {% else %}
        ‚Äî
      {% endif %}
      {% endwith %}
      {% endwith %}
    </div>

    <div>
      <strong>Projected pay week:</strong>
      <span class="ml-1">{{ a.sesion.semana_pago_proyectada|default:"‚Äî" }}</span>
    </div>
  </div>

  <h2 class="text-lg font-semibold mb-2">Items</h2>
  <div class="overflow-x-auto rounded border">
    <table class="table-auto w-full text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 text-left">Code</th>
          <th class="p-2 text-left">Description</th>
          <th class="p-2 text-right">Qty</th>
          <th class="p-2 text-right">My Rate</th>
          <th class="p-2 text-right">Line Total</th>
        </tr>
      </thead>
      <tbody>
      {% for it in items %}
        <tr class="border-t">
          <td class="p-2">{{ it.item.codigo_trabajo }}</td>
          <td class="p-2">{{ it.item.descripcion }}</td>
          <td class="p-2 text-right">{{ it.item.cantidad|floatformat:2 }}</td>
          <td class="p-2 text-right">${{ it.tarifa_efectiva|floatformat:2 }}</td>
          <td class="p-2 text-right">${{ it.subtotal|floatformat:2 }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="p-3 text-center text-gray-500">No items.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# ===== Modal para aceptar (POST) ===== #}
<div id="modal-accept" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/40" data-close-modal></div>
  <div class="relative max-w-md mx-auto mt-40 bg-white rounded-2xl shadow p-6">
    <h3 class="text-lg font-semibold">Accept assignment?</h3>
    <p class="mt-1 text-sm text-gray-600">
      This will mark the task as <b>In progress</b> and store your acceptance timestamp.
    </p>
    <form id="form-accept" method="post" action="#" class="mt-4 flex justify-end gap-2">
      {% csrf_token %}
      <button type="button" class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200" data-close-modal>Cancel</button>
      <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Accept & Start</button>
    </form>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('modal-accept');
  const form  = document.getElementById('form-accept');

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-accept-start');
    if(!btn) return;
    form.action = btn.getAttribute('data-action'); // URL de start_assignment
    modal.classList.remove('hidden');
  });

  document.addEventListener('click', (e)=>{
    if (e.target.hasAttribute('data-close-modal')) {
      modal.classList.add('hidden');
    }
  });

  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') modal.classList.add('hidden');
  });
})();
</script>
{% endblock %}
