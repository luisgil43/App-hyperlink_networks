{% extends "dashboard_admin/base.html" %}
{% load humanize %}

{% block title %}Technician Prices{% endblock %}

{% block dashboard_content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">üí∞ Technician Prices</h2>
        <a href="{% url 'operaciones:importar_precios' %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
            ‚ûï Import Prices
        </a>
    </div>

    <!-- Table -->
    <div class="rounded-xl border border-gray-200 overflow-x-auto">
        <table class="table-auto border border-gray-300 rounded-xl text-sm w-full min-w-[1100px]" style="white-space: nowrap;">
            <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
                <tr>
                    <th class="p-2 border cursor-pointer" onclick="sortTable(0)">ID</th>
                    <th class="p-2 border cursor-pointer" onclick="sortTable(1)">Date</th>
                    <th class="p-2 border">Technician</th>
                    <th class="p-2 border">City</th>
                    <th class="p-2 border">Project</th>
                    <th class="p-2 border">Office</th>
                    <th class="p-2 border">Client</th>
                    <th class="p-2 border">Work Type</th>
                    <th class="p-2 border">Job Code</th>
                    <th class="p-2 border">Description</th>
                    <th class="p-2 border">UOM</th>
                    <th class="p-2 border text-right">Tech Price</th>
                    <th class="p-2 border text-right">Company Price</th>
                    <th class="p-2 border">Actions</th>
                </tr>
            </thead>
            <tbody class="text-center">
                {% for price in pagina %}
                <tr class="border-t">
                    <td class="p-2 border">{{ price.id }}</td>
                    <td class="p-2 border">{{ price.fecha_creacion|date:"d/m/Y" }}</td>
                    <td class="p-2 border">{{ price.tecnico.get_full_name }}</td>
                    <td class="p-2 border">{{ price.ciudad }}</td>
                    <td class="p-2 border">{{ price.proyecto }}</td>
                    <td class="p-2 border">{{ price.oficina }}</td>
                    <td class="p-2 border">{{ price.cliente }}</td>
                    <td class="p-2 border">{{ price.tipo_trabajo }}</td>
                    <td class="p-2 border">{{ price.codigo_trabajo }}</td>
                    <td class="p-2 border text-left">{{ price.descripcion }}</td>
                    <td class="p-2 border">{{ price.unidad_medida }}</td>
                    <td class="p-2 border text-right">${{ price.precio_tecnico|floatformat:2 }}</td>
                    <td class="p-2 border text-right">${{ price.precio_empresa|floatformat:2 }}</td>
                    <td class="p-2 border">
                        <a href="{% url 'operaciones:editar_precio' price.id %}" class="text-blue-600 hover:underline text-sm">‚úèÔ∏è Edit</a>
                        <a href="{% url 'operaciones:eliminar_precio' price.id %}" class="text-red-600 hover:underline text-sm ml-2">üóëÔ∏è Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="13" class="p-4 text-center text-gray-500">No prices available. <a href="{% url 'operaciones:importar_precios' %}" class="text-blue-600 hover:underline">Import Prices</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination controls -->
    <div class="mt-4 flex flex-wrap justify-between items-center text-sm">
        <form method="get" class="flex items-center gap-2">
            <label for="cantidad" class="text-sm font-medium text-gray-700">Show:</label>
            <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
                <option value="5" {% if cantidad == '5' %}selected{% endif %}>5</option>
                <option value="10" {% if cantidad == '10' %}selected{% endif %}>10</option>
                <option value="20" {% if cantidad == '20' %}selected{% endif %}>20</option>
                <option value="todos" {% if cantidad == 'todos' %}selected{% endif %}>All</option>
            </select>
        </form>
    </div>

    <div class="mt-2 flex justify-center text-sm">
        {% if cantidad == 'todos' %}
            <span>Page 1 of 1</span>
        {% else %}
            <span>Page {{ pagina.number }} of {{ pagina.paginator.num_pages }}</span>
        {% endif %}
    </div>

    <div class="mt-2 flex justify-center gap-2 text-sm">
        {% if pagina.has_previous %}
            <a href="?page=1&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ First</a>
            <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Previous</a>
        {% endif %}
        {% if pagina.has_next %}
            <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next ‚Ä∫</a>
            <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Last ¬ª</a>
        {% endif %}
    </div>
</div>
{% endblock %}

<script>
  // Function to sort the table by column (if needed)
  function sortTable(colIndex) {
    const rows = document.querySelectorAll("table tbody tr");
    const sortedRows = Array.from(rows).sort((a, b) => {
      const aText = a.children[colIndex].textContent.trim();
      const bText = b.children[colIndex].textContent.trim();
      return aText.localeCompare(bText, undefined, {numeric: true});
    });
    const tbody = document.querySelector("table tbody");
    tbody.innerHTML = "";
    sortedRows.forEach(row => tbody.appendChild(row));
  }
</script>
