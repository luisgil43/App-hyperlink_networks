{% extends "dashboard/base.html" %}
{% load humanize %}
{% load widget_tweaks %}
{% load custom_filters %}

{% block title %}My Expense Reports{% endblock %}

{% block content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">

  <!-- Header -->
<div class="flex flex-col sm:flex-row items-start gap-2 mb-4">
  <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
    üßæ My Expense Reports
  </h2>

  <a href="{% url 'operaciones:exportar_mis_rendiciones' %}"
     class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow">
    üì• Export to Excel
  </a>
</div>

  <!-- Balance cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-green-50 p-4 rounded-lg shadow">
      <h3 class="text-gray-600 text-sm font-medium">Available Balance</h3>
      <p class="text-2xl font-bold text-green-700">{{ saldo_disponible|formato_usd }}</p>
    </div>
    <div class="bg-yellow-50 p-4 rounded-lg shadow">
      <h3 class="text-gray-600 text-sm font-medium">Pending Approval Balance</h3>
      <p class="text-2xl font-bold text-yellow-700">{{ saldo_pendiente|formato_usd }}</p>
    </div>
    <div class="bg-orange-50 p-4 rounded-lg shadow">
      <h3 class="text-gray-600 text-sm font-medium">Reported Balance</h3>
      <p class="text-2xl font-bold text-orange-700">{{ saldo_rendido|formato_usd }}</p>
    </div>
  </div>

  <h3 class="text-lg font-semibold mb-2">‚ûï Register New Expense Report</h3>

  <!-- New expense report form -->
  <div class="mb-6">
    {% if form.errors %}
    <div class="bg-red-100 text-red-700 p-3 rounded mb-3">
      <ul>
        {% for field, errors in form.errors.items %}
          {% if field != '__all__' %}
            <li><strong>{{ form|field_label:field }}:</strong> {{ errors|join:", " }}</li>
          {% endif %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li><strong>General:</strong> {{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

<form method="post" enctype="multipart/form-data"
      class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="formRendicion">
  {% csrf_token %}

  <!-- Fila 1 -->
  <div>
    <label class="block text-sm font-medium text-gray-700">Project:</label>
    {{ form.proyecto|add_class:"w-full border rounded-xl px-3 py-2" }}
  </div>
  <div>
    <label class="block text-sm font-medium text-gray-700">Type:</label>
    {{ form.tipo|add_class:"w-full border rounded-xl px-3 py-2" }}
  </div>

  <!-- Fila 2 -->
  <div>
    <label class="block text-sm font-medium text-gray-700">Amount (USD):</label>
    {{ form.cargos|add_class:"w-full border rounded-xl px-3 py-2" }}
  </div>

  <!-- Fila 3: Remarks a lo ancho -->
   <div>
    <label class="block text-sm font-medium text-gray-700">Remarks:</label>
    {{ form.observaciones|add_class:"w-full border rounded-xl px-3 py-2" }}
  </div>

  <!-- Odometer km (se muestra/oculta con JS cuando es Fuel) -->
  <div id="bloque-fuel-km" class="">
    <label class="block text-sm font-medium text-gray-700">Odometer (km):</label>
    {{ form.kilometraje|add_class:"w-full border rounded-xl px-3 py-2" }}
  </div>


  <!-- Fila 4: Receipt (debajo de Remarks, ancho completo) -->
  <div class="sm:col-span-2">
    <label class="block text-sm font-medium text-gray-700">Receipt:</label>
    <div class="flex gap-2">
      <label class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full shadow cursor-pointer">
        üì∑ Take Photo
        <input type="file" id="comprobante_foto" name="comprobante_foto" accept="image/*" capture="environment" class="hidden" />
      </label>
      <label class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow cursor-pointer">
        üìÑ Upload File
        <input type="file" id="comprobante_archivo" name="comprobante_archivo" accept="application/pdf,image/*" class="hidden" />
      </label>
      <span class="hidden">{{ form.comprobante }}</span>
    </div>
    <span id="nombre_comprobante" class="text-sm text-gray-600 italic mt-1 block">
      {% if wasabi_key %}File already uploaded. It will be saved when the form is valid.{% else %}No file selected{% endif %}
    </span>
    <img id="preview_comprobante" alt="Receipt preview" class="mt-2 max-h-40 rounded shadow hidden" />
  </div>

  <!-- Fila 5: Odometer photo (debajo de Receipt, ancho completo) -->
  <div id="bloque-fuel-foto" class="sm:col-span-2">
    <label class="block text-sm font-medium text-gray-700">Odometer photo (dashboard):</label>
    <label for="id_foto_tablero"
           class="flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-full shadow cursor-pointer w-fit">
      üì∑ Take Photo
    </label>
    {{ form.foto_tablero|attr:"id:id_foto_tablero"|attr:"accept:image/*"|attr:"capture:environment"|add_class:"hidden" }}
    <span id="nombre_foto_tablero" class="text-sm text-gray-600 italic mt-1 block">
      {% if wasabi_key_foto_tablero %}Photo already uploaded. It will be saved when the form is valid.{% else %}No file selected{% endif %}
    </span>
    <img id="preview_tablero" alt="Odometer preview" class="mt-2 max-h-40 rounded shadow hidden" />
  </div>

  <!-- Hidden keys -->
  <input type="hidden" name="wasabi_key" id="wasabi_key" value="{{ wasabi_key|default_if_none:'' }}">
  <input type="hidden" name="wasabi_key_foto_tablero" id="wasabi_key_foto_tablero" value="{{ wasabi_key_foto_tablero|default_if_none:'' }}">

  <!-- Bot√≥n -->
  <div class="sm:col-span-2">
    <button type="submit" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full shadow">
      Save Expense Report
    </button>
  </div>
</form>
  </div>

  <!-- Tabla -->
  <div class="overflow-x-auto">
    <table class="table-auto w-full text-sm min-w-full sm:min-w-[1200px]" style="white-space: nowrap;">
      <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
        <tr>
          <th class="p-2 border">Date</th>
          <th class="p-2 border">Project</th>
          <th class="p-2 border">Type</th>
          <th class="p-2 border text-right">Expenses (USD)</th>
          <th class="p-2 border text-right">Credits (USD)</th>
          <th class="p-2 border">Remarks</th>
          <th class="p-2 border">Receipt</th>
          <th class="p-2 border">Odometer (km)</th> <!-- üëà NUEVO -->
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Actions</th>
        </tr>
      </thead>
      <tbody class="text-center">
        {% for mov in pagina %}
        <tr class="border-t">
          <td class="p-2 border">{{ mov.fecha|date:"d/m/Y" }}</td>
          <td class="p-2 border">{{ mov.proyecto }}</td>
          <td class="p-2 border">{{ mov.tipo }}</td>
          <td class="p-2 border text-right">{{ mov.cargos|default:0|formato_usd }}</td>
          <td class="p-2 border text-right">{{ mov.abonos|default:0|formato_usd }}</td>
          <td class="p-2 border">{{ mov.observaciones }}</td>
          <td class="p-2 border">
            {% if mov.tipo and mov.tipo.nombre|lower == "fuel" %}
              <div class="flex flex-col items-center gap-1">
                {% if mov.comprobante %}
                  <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">üìÑ Receipt</a>
                {% endif %}
                {% if mov.foto_tablero %}
                  <a href="{{ mov.foto_tablero.url }}" target="_blank" class="text-blue-600 underline">üì∑ Odometer</a>
                {% endif %}
                {% if not mov.comprobante and not mov.foto_tablero %} ‚Äî {% endif %}
              </div>
            {% else %}
              {% if mov.comprobante %}
                <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">View</a>
              {% else %} ‚Äî {% endif %}
            {% endif %}
          </td>
          <td class="p-2 border text-right">
            {% if mov.kilometraje %}{{ mov.kilometraje|intcomma }}{% else %}‚Äî{% endif %}
          </td>
          <!-- Status translation (igual a tu c√≥digo) -->
          <td class="p-2 text-sm">
            <div class="flex flex-col gap-1 text-left leading-tight">
              {% if mov.status == 'pendiente_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚è≥ Pending Supervisor Approval</span>
              {% elif mov.status == 'aprobado_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚è≥ Pending PM Approval</span>
              {% elif mov.status == 'rechazado_supervisor' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by Supervisor</span>
              {% elif mov.status == 'aprobado_pm' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br> ‚è≥ Pending Finance Approval</span>
              {% elif mov.status == 'rechazado_pm' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by PM</span>
              {% elif mov.status == 'aprobado_finanzas' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br> ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br> ‚úÖ Finance: {{ mov.aprobado_por_finanzas.get_full_name }}</span>
              {% elif mov.status == 'rechazado_finanzas' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Rejected by Finance</span>
              {% elif mov.status == 'pendiente_abono_usuario' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">‚è≥ Pending User Approval</span>
              {% elif mov.status == 'aprobado_abono_usuario' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">‚úÖ Credit Approved by User</span>
              {% elif mov.status == 'rechazado_abono_usuario' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">‚ùå Credit Rejected by User</span>
              {% else %}
                {{ mov.get_status_display }}
              {% endif %}
              {% if 'rechazado' in mov.status and mov.motivo_rechazo %}
                <div class="mt-1 text-xs text-red-700 whitespace-pre-wrap break-words editable-motivo">
                  <strong>Reason:</strong> <span class="motivo-text">{{ mov.motivo_rechazo }}</span>
                </div>
              {% endif %}
            </div>
          </td>

          <!-- Actions -->
          <td class="p-2 border text-center">
            {% if mov.tipo and mov.tipo.categoria == 'abono' %}
              {% if mov.status == 'pendiente_abono_usuario' %}
                <a href="{% url 'operaciones:aprobar_abono' mov.id %}"
                   class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200">‚úÖ Approve</a>
                <button onclick="abrirModalRechazo({{ mov.id }})"
                        class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200">‚ùå Reject</button>
              {% endif %}
            {% else %}
              {% if mov.status == 'pendiente_supervisor' or mov.status == 'rechazado_supervisor' or mov.status == 'rechazado_pm' or mov.status == 'rechazado_finanzas' %}
                <a href="{% url 'operaciones:editar_rendicion' mov.id %}"
                   class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200">‚úèÔ∏è Edit</a>
                <a href="{% url 'operaciones:eliminar_rendicion' mov.id %}"
                   class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200">üóëÔ∏è Delete</a>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="11" class="p-4 text-center text-gray-500">You have no expense reports registered.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modal rechazo (como ten√≠as) -->
  <div id="modalRechazo" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-lg font-bold mb-4">Reject Credit</h2>
      <form id="formRechazo" method="post">
        {% csrf_token %}
        <textarea name="motivo" rows="3" class="w-full border rounded-lg p-2" placeholder="Enter the rejection reason"></textarea>
        <div class="mt-4 flex justify-end gap-2">
          <button type="button" onclick="cerrarModalRechazo()" class="px-3 py-1 bg-gray-200 rounded">Cancel</button>
          <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Reject</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pagination (igual a tu c√≥digo) -->
  <div class="mt-4 flex flex-wrap justify-between items-center text-sm">
    <form method="get" class="flex items-center gap-2">
      <label for="cantidad" class="text-sm font-medium text-gray-700">Show:</label>
      <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
        <option value="5" {% if cantidad == '5' %}selected{% endif %}>5</option>
        <option value="10" {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20" {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="todos" {% if cantidad == 'todos' %}selected{% endif %}>All</option>
      </select>
    </form>
  </div>

  <div class="mt-2 flex justify-center text-sm">
    {% if cantidad == 'todos' %}
      <span>Page 1 of 1</span>
    {% else %}
      <span>Page {{ pagina.number }} of {{ pagina.paginator.num_pages }}</span>
    {% endif %}
  </div>

  <div class="mt-2 flex justify-center gap-2 text-sm">
    {% if pagina.has_previous %}
      <a href="?page=1&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ First</a>
      <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Previous</a>
    {% endif %}
    {% if pagina.has_next %}
      <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next ‚Ä∫</a>
      <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Last ¬ª</a>
    {% endif %}
  </div>
</div>

<!-- Scripts -->
<script>
function abrirModalRechazo(id) {
  document.getElementById('formRechazo').action = `/operaciones/rechazar_abono/${id}/`;
  document.getElementById('modalRechazo').classList.remove('hidden');
}
function cerrarModalRechazo() {
  document.getElementById('modalRechazo').classList.add('hidden');
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const inputFoto = document.getElementById("comprobante_foto");
  const inputArchivo = document.getElementById("comprobante_archivo");
  const nombreComprobante = document.getElementById("nombre_comprobante");
  const previewComprobante = document.getElementById("preview_comprobante");

  const odoInput   = document.getElementById("id_foto_tablero");
  const odoName    = document.getElementById("nombre_foto_tablero");
  const odoPreview = document.getElementById("preview_tablero");

  function hideImg(img) {
    if (!img) return;
    img.src = "";
    img.classList.add("hidden");
    img.style.display = "none";
  }
  function showImg(img, dataUrl) {
    if (!img) return;
    img.src = dataUrl;
    img.classList.remove("hidden");
    img.style.display = "block";
  }

  function showReceiptPreview(file) {
    if (!file) { hideImg(previewComprobante); return; }
    nombreComprobante.textContent = `Selected file: ${file.name}`;
    if (file.type && file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = (e) => showImg(previewComprobante, e.target.result);
      reader.readAsDataURL(file);
    } else {
      hideImg(previewComprobante); // pdf u otro
      nombreComprobante.textContent += file.type === "application/pdf" ? " (PDF)" : " (Preview not available)";
    }
  }

  function showOdoPreview(file) {
    if (!file) { hideImg(odoPreview); return; }
    odoName.textContent = `Selected file: ${file.name}`;
    if (file.type && file.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = (e) => showImg(odoPreview, e.target.result);
      reader.readAsDataURL(file);
    } else {
      hideImg(odoPreview);
    }
  }

  // Eventos de cambio
  if (inputFoto)    inputFoto.addEventListener("change", () => showReceiptPreview(inputFoto.files[0]));
  if (inputArchivo) inputArchivo.addEventListener("change", () => showReceiptPreview(inputArchivo.files[0]));
  if (odoInput)     odoInput.addEventListener("change", () => showOdoPreview(odoInput.files[0]));

  // Al cargar la p√°gina (GET despu√©s del redirect), asegurar que NO queden rotos
  const hadWasabiComp = "{{ wasabi_key|default_if_none:'' }}" !== "";
  const hadWasabiOdo  = "{{ wasabi_key_foto_tablero|default_if_none:'' }}" !== "";
  if (!hadWasabiComp) hideImg(previewComprobante);
  if (!hadWasabiOdo)  hideImg(odoPreview);
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const selectTipo = document.getElementById("id_tipo");
  const fuelKm     = document.getElementById("bloque-fuel-km");
  const fuelFoto   = document.getElementById("bloque-fuel-foto");

  function esFuel() {
    const opt = selectTipo?.selectedOptions?.[0];
    const txt = (opt ? opt.textContent : "").trim().toLowerCase();
    return txt === "fuel";
  }

  function toggleFuel() {
    const show = esFuel();
    if (fuelKm)   fuelKm.classList.toggle("hidden", !show);
    if (fuelFoto) fuelFoto.classList.toggle("hidden", !show);

    // required din√°mico
    const km   = document.getElementById("id_kilometraje");
    const foto = document.getElementById("id_foto_tablero");
    if (km)   km.required = show;
    if (foto) foto.required = show;
  }

  if (selectTipo) {
    selectTipo.addEventListener("change", toggleFuel);
    toggleFuel(); // estado inicial
  }
});
</script>

<script>
// ======== Multipart Upload (S3-compatible) + compresi√≥n opcional ========

const ENDPOINTS = {
  create: "{% url 'operaciones:multipart_create' %}",
  sign: "{% url 'operaciones:multipart_sign_part' %}",
  complete: "{% url 'operaciones:multipart_complete' %}",
  abort: "{% url 'operaciones:multipart_abort' %}",
};

const MAX_MB = {{ receipt_max_mb|default:25 }};
const CSRF = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || "";

function api(url, payload) {
  return fetch(url, {
    method: "POST",
    headers: {"Content-Type": "application/json", "X-CSRFToken": CSRF},
    body: JSON.stringify(payload)
  }).then(async r => {
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  });
}

// (Opcional) compresi√≥n cliente con fallback si no hay createImageBitmap
async function compressImageIfNeeded(file, maxDim=1600, quality=0.8) {
  if (!file || !file.type || !file.type.startsWith("image/")) return file;

  const toCanvasBlob = (img) => new Promise(resolve => {
    const canvas = document.createElement("canvas");
    const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
    canvas.width = Math.round(img.width * scale);
    canvas.height = Math.round(img.height * scale);
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(resolve, "image/jpeg", quality);
  });

  // try createImageBitmap, fallback to Image()
  try {
    if (window.createImageBitmap) {
      const bmp = await createImageBitmap(file);
      const canvas = document.createElement("canvas");
      const scale = Math.min(1, maxDim / Math.max(bmp.width, bmp.height));
      canvas.width = Math.round(bmp.width * scale);
      canvas.height = Math.round(bmp.height * scale);
      const ctx = canvas.getContext("2d");
      ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", quality));
      const name = file.name.replace(/\.(heic|heif|png)$/i, ".jpg");
      return new File([blob], name, {type: "image/jpeg"});
    }
  } catch (_) { /* fallback abajo */ }

  // Fallback con <img>
  const dataURL = await new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
  const img = await new Promise((resolve, reject) => {
    const im = new Image();
    im.onload = () => resolve(im);
    im.onerror = reject;
    im.src = dataURL;
  });
  const blob = await toCanvasBlob(img);
  const name = file.name.replace(/\.(heic|heif|png)$/i, ".jpg");
  return new File([blob], name, {type: "image/jpeg"});
}

// Subida multipart (divide en partes y sube en paralelo)
async function multipartUpload(file, onProgress) {
  // 1) create
  const create = await api(ENDPOINTS.create, {
    filename: file.name,
    contentType: file.type || "application/octet-stream"
  });
  const { uploadId, key } = create;

  // config de multipart
  const CHUNK_SIZE = 6 * 1024 * 1024; // 6 MB
  const CONCURRENCY = 4;              // 4 partes a la vez
  const totalParts = Math.ceil(file.size / CHUNK_SIZE);

  let nextPart = 1;
  let uploadedParts = 0; // para progreso aproximado
  let aborted = false;
  const parts = [];

  async function uploadPart(partNumber) {
    const start = (partNumber - 1) * CHUNK_SIZE;
    const end = Math.min(start + CHUNK_SIZE, file.size);
    const blob = file.slice(start, end);

    // 2) firmar parte
    const { url } = await api(ENDPOINTS.sign, { key, uploadId, partNumber });

    // 3) PUT de la parte al presigned URL
   const resp = await fetch(url, {
  method: "PUT",
  body: blob
});
    if (!resp.ok) throw new Error(`Part ${partNumber} failed: ` + resp.status);

    const etag = resp.headers.get("ETag") || resp.headers.get("etag") || "";
    parts.push({ ETag: etag.replace(/^W\//, ""), PartNumber: partNumber });

    uploadedParts++;
    if (onProgress) onProgress(Math.round(uploadedParts * 100 / totalParts));
  }

  // Pool de concurrencia
  const workers = Array.from({length: Math.min(CONCURRENCY, totalParts)}).map(async () => {
    while (!aborted) {
      const p = nextPart++;
      if (p > totalParts) break;
      try {
        await uploadPart(p);
      } catch (e) {
        aborted = true;
        await api(ENDPOINTS.abort, { key, uploadId }).catch(() => {});
        throw e;
      }
    }
  });

  await Promise.all(workers);

  // 4) complete
  await api(ENDPOINTS.complete, {
    key,
    uploadId,
    parts: parts.sort((a,b) => a.PartNumber - b.PartNumber)
  });

  return key;
}

// Hook del form
document.getElementById("formRendicion").addEventListener("submit", async (e) => {
  const form = e.currentTarget;
  const keyInputComp = document.getElementById('wasabi_key');
  const keyInputOdo  = document.getElementById('wasabi_key_foto_tablero');

  const fCompFoto = document.getElementById('comprobante_foto')?.files?.[0] || null;
  const fCompArch = document.getElementById('comprobante_archivo')?.files?.[0] || null;
  const fComprobante = fCompFoto || fCompArch || null;
  const fOdom = document.getElementById('id_foto_tablero')?.files?.[0] || null;

  const alreadyComp = !!keyInputComp.value;
  const alreadyOdo  = !!keyInputOdo.value;

  if ((alreadyComp || !fComprobante) && (alreadyOdo || !fOdom)) return;

  const tooBig = (f) => f && f.size > MAX_MB * 1024 * 1024;
  if (tooBig(fComprobante) || tooBig(fOdom)) {
    e.preventDefault();
    alert(`File too large. Max ${MAX_MB}MB.`);
    return;
  }

  e.preventDefault();

  // indicador simple (opcional)
  const submitBtn = form.querySelector('button[type="submit"]');
  const prevLabel = submitBtn ? submitBtn.textContent : "";
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = "Uploading..."; }

  try {
    // Compresi√≥n opcional
    const compPromise = alreadyComp || !fComprobante ? Promise.resolve(null)
      : compressImageIfNeeded(fComprobante);
    const odoPromise = alreadyOdo || !fOdom ? Promise.resolve(null)
      : compressImageIfNeeded(fOdom);

    const [compFile, odoFile] = await Promise.all([compPromise, odoPromise]);

    // Subir en paralelo ambos (cada uno multipart)
    const upComp = alreadyComp || !compFile ? Promise.resolve("") :
      multipartUpload(compFile, p => { /* console.log('receipt', p) */ });

    const upOdo  = alreadyOdo || !odoFile ? Promise.resolve("") :
      multipartUpload(odoFile, p => { /* console.log('odometer', p) */ });

    const [keyComp, keyOdo] = await Promise.all([upComp, upOdo]);

    if (keyComp) keyInputComp.value = keyComp;
    if (keyOdo)  keyInputOdo.value  = keyOdo;

    // limpiar inputs/preview para que Django no re-suban
    const nf = document.getElementById('nombre_comprobante');
    const nt = document.getElementById('nombre_foto_tablero');
    const pc = document.getElementById('preview_comprobante');
    const pt = document.getElementById('preview_tablero');

    if (keyComp) {
      if (nf) nf.textContent = "File uploaded. It will be saved when the form is valid.";
      const a = document.getElementById('comprobante_archivo');
      const f = document.getElementById('comprobante_foto');
      if (a) a.value = "";
      if (f) f.value = "";
      if (pc) { pc.src = ""; pc.classList.add("hidden"); pc.style.display = "none"; }
    }
    if (keyOdo) {
      if (nt) nt.textContent = "Photo uploaded. It will be saved when the form is valid.";
      const o = document.getElementById('id_foto_tablero');
      if (o) o.value = "";
      if (pt) { pt.src = ""; pt.classList.add("hidden"); pt.style.display = "none"; }
    }

    form.submit();
  } catch (err) {
    console.error(err);
    alert("Upload error. Please check your connection and try again.");
    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = prevLabel; }
  }
});
</script>

<script>
/* Mantener el scroll horizontal en "My Expense Reports" */
(function () {
  const KEY = 'myexpensesScrollX:' + location.pathname;

  // El contenedor con overflow-x que envuelve la tabla
  function getScrollBox() {
    // busca el primer .overflow-x-auto dentro del contenedor principal
    return document.querySelector('.max-w-6xl .overflow-x-auto') || document.querySelector('.overflow-x-auto');
  }

  function saveX(x) {
    try { sessionStorage.setItem(KEY, String(x)); } catch (_) {}
  }
  function readX() {
    try { return Number(sessionStorage.getItem(KEY) || 0); } catch (_) { return 0; }
  }

  function restore() {
    const box = getScrollBox();
    if (!box) return;
    const x = readX();
    // aplicar tras el layout para que no lo pise el navegador
    requestAnimationFrame(() => { box.scrollLeft = x; });

    // ir guardando mientras el usuario se desplaza
    let t = null;
    box.addEventListener('scroll', () => {
      if (t) return;
      t = setTimeout(() => { t = null; saveX(box.scrollLeft); }, 120);
    }, { passive: true });
  }

  function saveBeforeLeave() {
    const box = getScrollBox();
    if (box) saveX(box.scrollLeft);
  }

  // Restaurar al cargar y guardar al salir/recargar
  document.addEventListener('DOMContentLoaded', restore);
  window.addEventListener('beforeunload', saveBeforeLeave);
})();
</script>


{% endblock %}
