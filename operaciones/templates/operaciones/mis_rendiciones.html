{% extends "dashboard/base.html" %}
{% load humanize %}
{% load widget_tweaks %}
{% load custom_filters %}

{% block title %}My Expense Reports{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">üßæ My Expense Reports</h2>
   <a href="{% url 'operaciones:exportar_mis_rendiciones' %}" 
   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow">
    üì• Export to Excel
</a>
    </div>

   <!-- Balance cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-green-50 p-4 rounded-lg shadow">
        <h3 class="text-gray-600 text-sm font-medium">Available Balance</h3>
        <p class="text-2xl font-bold text-green-700">
            {{ saldo_disponible|formato_usd }}
        </p>
    </div>
    <div class="bg-yellow-50 p-4 rounded-lg shadow">
        <h3 class="text-gray-600 text-sm font-medium">Pending Approval Balance</h3>
        <p class="text-2xl font-bold text-yellow-700">
            {{ saldo_pendiente|formato_usd }}
        </p>
    </div>
    <div class="bg-orange-50 p-4 rounded-lg shadow">
        <h3 class="text-gray-600 text-sm font-medium">Reported Balance</h3>
        <p class="text-2xl font-bold text-orange-700">
            {{ saldo_rendido|formato_usd }}
        </p>
    </div>
</div>

<h3 class="text-lg font-semibold mb-2">‚ûï Register New Expense Report</h3>

<!-- New expense report form -->
<div class="mb-6">
{% if form.errors %}
<div class="bg-red-100 text-red-700 p-3 rounded mb-3">
  <ul>
    {% for field, errors in form.errors.items %}
      {% if field != '__all__' %}
        <li><strong>{{ form|field_label:field }}:</strong> {{ errors|join:", " }}</li>
      {% endif %}
    {% endfor %}
    {% for error in form.non_field_errors %}
      <li><strong>General:</strong> {{ error }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    {% csrf_token %}
    <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-700">Project:</label>
        {{ form.proyecto|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>
    <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-700">Type:</label>
        {{ form.tipo|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-700">Amount (USD):</label>
        {{ form.cargos|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>
    <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-700">Remarks:</label>
        {{ form.observaciones|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700">Receipt:</label>
        <div class="flex gap-2">
            <!-- Camera button -->
            <label class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full shadow cursor-pointer">
                üì∑ Take Photo
                <input type="file" id="comprobante_foto" name="comprobante_foto" accept="image/*" capture="environment" class="hidden" />
            </label>

            <!-- File button -->
            <label class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow cursor-pointer">
                üìÑ Upload File
                <input type="file" id="comprobante_archivo" name="comprobante_archivo" accept="application/pdf,image/*" class="hidden" />
            </label>
        </div>
        <span id="nombre_comprobante" class="text-sm text-gray-600 italic mt-1 block">No file selected</span>
        <img id="preview_comprobante" class="mt-2 max-h-40 rounded shadow hidden">
    </div>

    <div class="col-span-1 sm:col-span-2">
        <button type="submit" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full shadow">
            Save Expense Report
        </button>
    </div>
</form>
</div>

<!-- Responsive table -->
<div class="rounded-xl border border-gray-200 overflow-x-auto">
  <table class="table-auto border border-gray-300 rounded-xl text-sm w-full min-w-[1200px]" style="white-space: nowrap;">
    <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
      <tr>
        <th class="p-2 border">Name</th>
        <th class="p-2 border">Date</th>
        <th class="p-2 border">Project</th>
        <th class="p-2 border">Type</th>
        <th class="p-2 border text-right">Expenses (USD)</th>
        <th class="p-2 border text-right">Credits (USD)</th>
        <th class="p-2 border">Remarks</th>
        <th class="p-2 border">Receipt</th>
        <th class="p-2 border">Status</th>
        <th class="p-2 border">Actions</th>
      </tr>
    </thead>
    <tbody class="text-center">
      {% for mov in pagina %}
      <tr class="border-t">
        <td class="p-2 border">{{ mov.usuario.get_full_name }}</td>
        <td class="p-2 border">{{ mov.fecha|date:"d/m/Y" }}</td>
        <td class="p-2 border">{{ mov.proyecto }}</td>
        <td class="p-2 border">{{ mov.tipo }}</td>
        <td class="p-2 border text-right">{{ mov.cargos|default:0|formato_usd }}</td>
        <td class="p-2 border text-right">{{ mov.abonos|default:0|formato_usd }}</td>
        <td class="p-2 border">{{ mov.observaciones }}</td>
        <td class="p-2 border">
          {% if mov.comprobante %}
            <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">View</a>
          {% else %} ‚Äî {% endif %}
        </td>
        <!-- Status translation -->
        <td class="p-2 text-sm">
            <div class="flex flex-col gap-1 text-left leading-tight">
                {% if mov.status == 'pendiente_supervisor' %}
                    <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                        ‚è≥ Pending Supervisor Approval
                    </span>
                {% elif mov.status == 'aprobado_supervisor' %}
                    <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                        ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                        ‚è≥ Pending PM Approval
                    </span>
                {% elif mov.status == 'rechazado_supervisor' %}
                    <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                        ‚ùå Rejected by Supervisor
                    </span>
                {% elif mov.status == 'aprobado_pm' %}
                    <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                        ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                        ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br>
                        ‚è≥ Pending Finance Approval
                    </span>
                {% elif mov.status == 'rechazado_pm' %}
                    <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                        ‚ùå Rejected by PM
                    </span>
                {% elif mov.status == 'aprobado_finanzas' %}
                    <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                        ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                        ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br>
                        ‚úÖ Finance: {{ mov.aprobado_por_finanzas.get_full_name }}
                    </span>
                {% elif mov.status == 'rechazado_finanzas' %}
                    <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                        ‚ùå Rejected by Finance
                    </span>
                {% elif mov.status == 'pendiente_abono_usuario' %}
                    <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                        ‚è≥ Pending User Approval
                    </span>
                {% elif mov.status == 'aprobado_abono_usuario' %}
                    <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                        ‚úÖ Credit Approved by User
                    </span>
                {% elif mov.status == 'rechazado_abono_usuario' %}
                    <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                        ‚ùå Credit Rejected by User
                    </span>
                {% else %}
                    {{ mov.get_status_display }}
                {% endif %}

                {% if 'rechazado' in mov.status and mov.motivo_rechazo %}
                    <div class="mt-1 text-xs text-red-700 whitespace-pre-wrap break-words editable-motivo">
                        <strong>Reason:</strong> <span class="motivo-text">{{ mov.motivo_rechazo }}</span>
                    </div>
                {% endif %}
            </div>
        </td>

    <!-- Actions -->
<td class="p-2 border text-center">
    {% if mov.tipo and mov.tipo.categoria == 'abono' %}
        {% if mov.status == 'pendiente_abono_usuario' %}
            <a href="{% url 'operaciones:aprobar_abono' mov.id %}" 
               class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200">
                ‚úÖ Approve
            </a>
            <button onclick="abrirModalRechazo({{ mov.id }})" 
                    class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200">
                ‚ùå Reject
            </button>
        {% endif %}
    {% else %}
        {% if mov.status == 'pendiente_supervisor' or mov.status == 'rechazado_supervisor' or mov.status == 'rechazado_pm' or mov.status == 'rechazado_finanzas' %}
            <a href="{% url 'operaciones:editar_rendicion' mov.id %}" 
               class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200">
                ‚úèÔ∏è Edit
            </a>
            <a href="{% url 'operaciones:eliminar_rendicion' mov.id %}" 
               class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200">
                üóëÔ∏è Delete
            </a>
        {% endif %}
    {% endif %}
</td>
      </tr>
      {% empty %}
      <tr><td colspan="10" class="p-4 text-center text-gray-500">You have no expense reports registered.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal -->
<div id="modalRechazo" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h2 class="text-lg font-bold mb-4">Reject Credit</h2>
    <form id="formRechazo" method="post">
      {% csrf_token %}
      <textarea name="motivo" rows="3" class="w-full border rounded-lg p-2" placeholder="Enter the rejection reason"></textarea>
      <div class="mt-4 flex justify-end gap-2">
        <button type="button" onclick="cerrarModalRechazo()" class="px-3 py-1 bg-gray-200 rounded">Cancel</button>
        <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Reject</button>
      </div>
    </form>
  </div>
</div>

<script>
function abrirModalRechazo(id) {
    document.getElementById('formRechazo').action = `/operaciones/rechazar_abono/${id}/`;
    document.getElementById('modalRechazo').classList.remove('hidden');
}
function cerrarModalRechazo() {
    document.getElementById('modalRechazo').classList.add('hidden');
}
</script>

<!-- Pagination -->
<div class="mt-4 flex flex-wrap justify-between items-center text-sm">
    <form method="get" class="flex items-center gap-2">
        <label for="cantidad" class="text-sm font-medium text-gray-700">Show:</label>
        <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
            <option value="5" {% if cantidad == '5' %}selected{% endif %}>5</option>
            <option value="10" {% if cantidad == '10' %}selected{% endif %}>10</option>
            <option value="20" {% if cantidad == '20' %}selected{% endif %}>20</option>
            <option value="todos" {% if cantidad == 'todos' %}selected{% endif %}>All</option>
        </select>
    </form>
</div>

<div class="mt-2 flex justify-center text-sm">
    {% if cantidad == 'todos' %}
        <span>Page 1 of 1</span>
    {% else %}
        <span>Page {{ pagina.number }} of {{ pagina.paginator.num_pages }}</span>
    {% endif %}
</div>

<div class="mt-2 flex justify-center gap-2 text-sm">
    {% if pagina.has_previous %}
        <a href="?page=1&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ First</a>
        <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Previous</a>
    {% endif %}
    {% if pagina.has_next %}
        <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next ‚Ä∫</a>
        <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Last ¬ª</a>
    {% endif %}
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const inputFoto = document.getElementById("comprobante_foto");
  const inputArchivo = document.getElementById("comprobante_archivo");
  const nombreComprobante = document.getElementById("nombre_comprobante");
  const previewComprobante = document.getElementById("preview_comprobante");

  function showPreview(input) {
    const file = input.files[0];
    if (!file) return;

    nombreComprobante.textContent = `Selected file: ${file.name}`;
    const reader = new FileReader();

    if (file.type.startsWith("image/")) {
      reader.onload = function (e) {
        previewComprobante.src = e.target.result;
        previewComprobante.classList.remove("hidden");
        previewComprobante.style.display = "block";
      };
      reader.readAsDataURL(file);
    } else if (file.type === "application/pdf") {
      previewComprobante.classList.add("hidden");
      previewComprobante.style.display = "none";
      nombreComprobante.textContent += " (PDF)";
    } else {
      previewComprobante.classList.add("hidden");
      previewComprobante.style.display = "none";
      nombreComprobante.textContent += " (Preview not available)";
    }
  }

  inputFoto.addEventListener("change", function () { showPreview(this); });
  inputArchivo.addEventListener("change", function () { showPreview(this); });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Selecciona todos los campos con required
  document.querySelectorAll("form [required]").forEach(function (input) {
    input.oninvalid = function (e) {
      e.target.setCustomValidity(""); // limpia por si acaso
      if (!e.target.validity.valid) {
        if (e.target.tagName === "SELECT") {
          e.target.setCustomValidity("Please select an option");
        } else if (e.target.type === "file") {
          e.target.setCustomValidity("Please upload a file");
        } else if (e.target.type === "number" || e.target.type === "text") {
          e.target.setCustomValidity("This field is required");
        } else {
          e.target.setCustomValidity("Please fill out this field");
        }
      }
    };
    // Limpiar cuando el usuario escriba/seleccione
    input.oninput = function (e) {
      e.target.setCustomValidity("");
    };
  });
});
</script>

<input type="hidden" name="wasabi_key" value="">

<script>
(function(){
  const DIRECT_ENABLED = {{ direct_uploads_receipts_enabled|yesno:"true,false" }};
  const MAX_MB = {{ receipt_max_mb|default:25 }};
  const getCsrf = () => (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || "";

  async function presign(filename, contentType, sizeBytes){
    const resp = await fetch("{% url 'operaciones:presign_rendicion' %}", {
      method: "POST",
      headers: {"Content-Type": "application/json", "X-CSRFToken": getCsrf()},
      body: JSON.stringify({ filename, contentType, sizeBytes }),
    });
    if(!resp.ok){
      const t = await resp.text(); throw new Error("Presign failed: " + t);
    }
    return resp.json(); // { post:{url, fields{}}, key }
  }

  async function directUpload(file){
    const { post, key } = await presign(file.name, file.type || "application/octet-stream", file.size);
    const fd = new FormData();
    Object.entries(post.fields).forEach(([k, v]) => fd.append(k, v));
    fd.append("key", post.fields.key || key);
    fd.append("file", file, file.name);

    const up = await fetch(post.url, { method: "POST", body: fd });
    if (up.status !== 201) {
      const t = await up.text(); throw new Error("Upload error: " + t);
    }
    return key;
  }

  document.addEventListener("submit", async (e)=>{
    const form = e.target.closest("form");
    if(!form) return;
    const fileInput = form.querySelector('input[type="file"][name="comprobante"]');
    const keyInput  = form.querySelector('input[name="wasabi_key"]');
    if(!DIRECT_ENABLED || !fileInput || !fileInput.files || !fileInput.files.length) return;

    const file = fileInput.files[0];
    if (file.size > MAX_MB*1024*1024){
      e.preventDefault();
      alert(`File too large. Max ${MAX_MB}MB.`);
      return;
    }

    e.preventDefault(); // interceptamos
    try{
      const key = await directUpload(file);
      // Limpiamos el file input para que Django NO suba bytes
      fileInput.value = "";
      keyInput.value = key;
      form.submit(); // ahora s√≠: s√≥lo metadatos + wasabi_key
    }catch(err){
      console.error(err);
      alert("There was a problem uploading the receipt. Please try again.");
    }
  });
})();
</script>
{% endblock %}

