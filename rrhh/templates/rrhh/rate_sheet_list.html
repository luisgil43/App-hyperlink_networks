{% extends "dashboard_admin/base.html" %}
{% load humanize %}

{% block title %}Rate Sheets{% endblock %}

{% block dashboard_content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">

  <!-- Encabezado -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">📄 Rate Sheets</h2>
    <a href="{% url 'rrhh:add_rate_sheet' %}" 
       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow">
      ➕ Add Rate Sheet
    </a>
  </div>

  <!-- Tabla responsive -->
  <div class="rounded-xl border border-gray-200 overflow-x-auto">
    <table class="table-auto border border-gray-300 rounded-xl text-sm w-full min-w-[1000px]" style="white-space: nowrap;">
      <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
        <tr>
          <th class="p-2 border">ID</th>
          <th class="p-2 border">Technician</th>
          <th class="p-2 border">Created</th>
          <th class="p-2 border">Unsigned PDF</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Signed At</th>
          <th class="p-2 border">Signed PDF</th>
          <th class="p-2 border">Actions</th>
        </tr>
      </thead>
      <tbody class="text-center">
        {% for r in pagina %}
        <tr class="border-t">
          <td class="p-2 border">{{ r.id }}</td>
          <td class="p-2 border">{{ r.technician.get_full_name|default:r.technician.username }}</td>
          <td class="p-2 border">{{ r.created_at|date:"d/m/Y H:i" }}</td>
          <td class="p-2 border">
            {% if r.file_unsigned %}
              <a href="{{ r.file_unsigned.url }}" target="_blank" class="text-blue-600 underline">Download</a>
            {% else %} — {% endif %}
          </td>

          <!-- Estado -->
          <td class="p-2 text-sm">
            {% if r.status == 'pending' %}
              <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                ✖ Pending Signature
              </span>
            {% else %}
              <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                ✔ Signed
              </span>
            {% endif %}
          </td>

          <td class="p-2 border">{{ r.signed_at|date:"d/m/Y H:i" }}</td>

          <td class="p-2 border">
            {% if r.file_signed %}
              <a href="{{ r.file_signed.url }}" target="_blank" class="text-blue-600 underline">Download</a>
            {% else %} — {% endif %}
          </td>

          <!-- Acciones -->
          <td class="p-2 border text-center">
            <div class="flex items-center justify-center gap-2">
              {% if r.status == "pending" and r.technician_id == request.user.id %}
                <a href="{% url 'rrhh:sign_rate_sheet' r.id %}"
                   class="inline-block bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-yellow-200">
                  ✍️ Sign
                </a>
              {% endif %}
              <a href="{% url 'rrhh:edit_rate_sheet' r.id %}"
                 class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200">
                ✏️ Edit
              </a>

              <!-- Botón que abre modal de eliminar -->
              <button
                type="button"
                class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200"
                data-open-delete
                data-delete-url="{% url 'rrhh:delete_rate_sheet' r.id %}"
                data-delete-label="Rate Sheet #{{ r.id }} — {{ r.technician.get_full_name|default:r.technician.username }}"
              >
                🗑️ Delete
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="p-4 text-center text-gray-500">No rate sheets available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <div class="mt-4 flex flex-wrap justify-between items-center text-sm">
    <form method="get" class="flex items-center gap-2">
      <label for="cantidad" class="text-sm font-medium text-gray-700">Show:</label>
      <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
        <option value="5" {% if cantidad == '5' %}selected{% endif %}>5</option>
        <option value="10" {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20" {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="todos" {% if cantidad == 'todos' %}selected{% endif %}>All</option>
      </select>
    </form>
  </div>

  <div class="mt-2 flex justify-center text-sm">
    {% if cantidad == 'todos' %}
      <span>Page 1 of 1</span>
    {% else %}
      <span>Page {{ pagina.number }} of {{ pagina.paginator.num_pages }}</span>
    {% endif %}
  </div>

  <div class="mt-2 flex justify-center gap-2 text-sm">
    {% if pagina.has_previous %}
      <a href="?page=1&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">« First</a>
      <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‹ Previous</a>
    {% endif %}
    {% if pagina.has_next %}
      <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next ›</a>
      <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Last »</a>
    {% endif %}
  </div>

</div>

<!-- MODAL ELIMINAR (reutilizable) -->
<div id="deleteModal" class="fixed inset-0 z-[60] hidden" aria-hidden="true">
  <!-- Overlay -->
  <div class="absolute inset-0 bg-black/40 backdrop-blur-[1px] opacity-0 transition-opacity duration-200" data-overlay></div>

  <!-- Dialog -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-md translate-y-4 opacity-0 transition-all duration-200" data-dialog>
      <div class="bg-white rounded-2xl shadow-xl border border-gray-200">
        <div class="px-6 pt-5 pb-3">
          <div class="flex items-start gap-3">
            <div class="shrink-0 rounded-full bg-red-100 p-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v4m0 4h.01M12 22C6.48 22 2 17.52 2 12S6.48 2 12 2s10 4.48 10 10-4.48 10-10 10z"/>
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900">Delete Rate Sheet</h3>
              <p class="mt-1 text-sm text-gray-600">
                You’re about to delete: <span id="deleteItemLabel" class="font-medium text-gray-800"></span>.
                This action cannot be undone.
              </p>
            </div>
          </div>
        </div>

        <div class="px-6 pb-5 flex items-center justify-end gap-3">
          <button type="button" class="px-4 py-2 rounded-full text-sm border border-gray-300 hover:bg-gray-50" data-cancel>
            Cancel
          </button>

          <!-- Form real que envía el POST con CSRF -->
          <form id="deleteForm" method="post" action="#">
            {% csrf_token %}
            <button type="submit" class="px-4 py-2 rounded-full text-sm font-semibold bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
              Yes, delete
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS del modal -->
<script>
(function () {
  const modal = document.getElementById('deleteModal');
  if (!modal) return;

  const overlay = modal.querySelector('[data-overlay]');
  const dialog  = modal.querySelector('[data-dialog]');
  const cancel  = modal.querySelector('[data-cancel]');
  const labelEl = document.getElementById('deleteItemLabel');
  const form    = document.getElementById('deleteForm');

  let lastFocused = null;

  function openModal(url, labelText) {
    lastFocused = document.activeElement;

    // Set action + label
    form.setAttribute('action', url || '#');
    labelEl.textContent = labelText || '';

    modal.classList.remove('hidden');
    requestAnimationFrame(() => {
      overlay.classList.remove('opacity-0');
      dialog.classList.remove('opacity-0', 'translate-y-4');
      dialog.classList.add('opacity-100', 'translate-y-0');
    });

    modal.setAttribute('aria-hidden', 'false');

    // Focus trap básico: foco al botón de confirmación
    const confirmBtn = form.querySelector('button[type="submit"]');
    confirmBtn && confirmBtn.focus();

    // Escape para cerrar
    document.addEventListener('keydown', onEsc);
  }

  function closeModal() {
    overlay.classList.add('opacity-0');
    dialog.classList.add('opacity-0', 'translate-y-4');
    dialog.classList.remove('opacity-100', 'translate-y-0');

    setTimeout(() => {
      modal.classList.add('hidden');
      modal.setAttribute('aria-hidden', 'true');
      if (lastFocused) lastFocused.focus();
    }, 180);

    document.removeEventListener('keydown', onEsc);
  }

  function onEsc(e) {
    if (e.key === 'Escape') closeModal();
  }

  // Abridores
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-open-delete]');
    if (!btn) return;
    const url = btn.getAttribute('data-delete-url');
    const label = btn.getAttribute('data-delete-label');
    openModal(url, label);
  });

  // Cerrar por overlay o cancelar
  overlay && overlay.addEventListener('click', closeModal);
  cancel && cancel.addEventListener('click', closeModal);
})();
</script>
{% endblock %}
